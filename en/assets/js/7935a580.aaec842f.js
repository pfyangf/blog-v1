"use strict";(globalThis.webpackChunkblog_v1=globalThis.webpackChunkblog_v1||[]).push([[1353],{2489(n,e,t){t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>d});var s=t(5602),r=t(4848),a=t(8453);const i={slug:"web3-wallet-security",title:"Web3\u94b1\u5305\u5b89\u5168\u5b8c\u5168\u6307\u5357\uff1a\u4ece\u539f\u7406\u5230\u5b9e\u8df5",authors:["autosec"],tags:["\u94b1\u5305\u5b89\u5168","\u79c1\u94a5\u7ba1\u7406","Web3\u5b89\u5168","\u52a0\u5bc6\u8d27\u5e01","\u5b89\u5168\u6700\u4f73\u5b9e\u8df5"]},o="Web3\u94b1\u5305\u5b89\u5168\u5b8c\u5168\u6307\u5357\uff1a\u4ece\u539f\u7406\u5230\u5b9e\u8df5",c={authorsImageUrls:[void 0]},d=[{value:"\u94b1\u5305\u57fa\u7840\u77e5\u8bc6",id:"\u94b1\u5305\u57fa\u7840\u77e5\u8bc6",level:2},{value:"\u94b1\u5305\u7c7b\u578b",id:"\u94b1\u5305\u7c7b\u578b",level:3},{value:"1. \u70ed\u94b1\u5305 vs \u51b7\u94b1\u5305",id:"1-\u70ed\u94b1\u5305-vs-\u51b7\u94b1\u5305",level:4},{value:"2. \u6258\u7ba1\u94b1\u5305 vs \u975e\u6258\u7ba1\u94b1\u5305",id:"2-\u6258\u7ba1\u94b1\u5305-vs-\u975e\u6258\u7ba1\u94b1\u5305",level:4},{value:"\u5e38\u89c1\u653b\u51fb\u624b\u6cd5",id:"\u5e38\u89c1\u653b\u51fb\u624b\u6cd5",level:2},{value:"1. \u9493\u9c7c\u653b\u51fb",id:"1-\u9493\u9c7c\u653b\u51fb",level:3},{value:"\u7b7e\u540d\u9493\u9c7c",id:"\u7b7e\u540d\u9493\u9c7c",level:4},{value:"2. \u6388\u6743\u6ee5\u7528",id:"2-\u6388\u6743\u6ee5\u7528",level:3},{value:"3. \u79c1\u94a5\u6cc4\u9732",id:"3-\u79c1\u94a5\u6cc4\u9732",level:3},{value:"\u5e38\u89c1\u6cc4\u9732\u9014\u5f84",id:"\u5e38\u89c1\u6cc4\u9732\u9014\u5f84",level:4},{value:"\u5b89\u5168\u6700\u4f73\u5b9e\u8df5",id:"\u5b89\u5168\u6700\u4f73\u5b9e\u8df5",level:2},{value:"1. \u52a9\u8bb0\u8bcd\u7ba1\u7406",id:"1-\u52a9\u8bb0\u8bcd\u7ba1\u7406",level:3},{value:"2. \u4ea4\u6613\u7b7e\u540d\u9a8c\u8bc1",id:"2-\u4ea4\u6613\u7b7e\u540d\u9a8c\u8bc1",level:3},{value:"3. \u667a\u80fd\u5408\u7ea6\u4ea4\u4e92\u5b89\u5168",id:"3-\u667a\u80fd\u5408\u7ea6\u4ea4\u4e92\u5b89\u5168",level:3},{value:"4. \u591a\u91cd\u7b7e\u540d\u94b1\u5305",id:"4-\u591a\u91cd\u7b7e\u540d\u94b1\u5305",level:3},{value:"\u5e94\u6025\u54cd\u5e94",id:"\u5e94\u6025\u54cd\u5e94",level:2},{value:"\u8d44\u4ea7\u88ab\u76d7\u540e\u7684\u5904\u7406",id:"\u8d44\u4ea7\u88ab\u76d7\u540e\u7684\u5904\u7406",level:3},{value:"\u5b89\u5168\u5de5\u5177\u63a8\u8350",id:"\u5b89\u5168\u5de5\u5177\u63a8\u8350",level:2},{value:"1. \u94b1\u5305\u5b89\u5168\u68c0\u67e5\u5de5\u5177",id:"1-\u94b1\u5305\u5b89\u5168\u68c0\u67e5\u5de5\u5177",level:3},{value:"2. \u4ea4\u6613\u6a21\u62df\u5de5\u5177",id:"2-\u4ea4\u6613\u6a21\u62df\u5de5\u5177",level:3},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}];function l(n){const e={code:"code",h2:"h2",h3:"h3",h4:"h4",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.p,{children:"Web3\u94b1\u5305\u662f\u7528\u6237\u8fdb\u5165\u533a\u5757\u94fe\u4e16\u754c\u7684\u95e8\u6237\uff0c\u4f46\u4e5f\u662f\u6700\u5bb9\u6613\u53d7\u5230\u653b\u51fb\u7684\u73af\u8282\u3002\u672c\u6587\u5c06\u6df1\u5165\u63a2\u8ba8\u94b1\u5305\u5b89\u5168\u7684\u5404\u4e2a\u65b9\u9762\uff0c\u4ece\u6280\u672f\u539f\u7406\u5230\u5b9e\u8df5\u5efa\u8bae\u3002"}),"\n",(0,r.jsx)(e.h2,{id:"\u94b1\u5305\u57fa\u7840\u77e5\u8bc6",children:"\u94b1\u5305\u57fa\u7840\u77e5\u8bc6"}),"\n",(0,r.jsx)(e.h3,{id:"\u94b1\u5305\u7c7b\u578b",children:"\u94b1\u5305\u7c7b\u578b"}),"\n",(0,r.jsx)(e.h4,{id:"1-\u70ed\u94b1\u5305-vs-\u51b7\u94b1\u5305",children:"1. \u70ed\u94b1\u5305 vs \u51b7\u94b1\u5305"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"// \u70ed\u94b1\u5305\u793a\u4f8b\uff1aMetaMask \u8fde\u63a5\nasync function connectWallet() {\n    if (typeof window.ethereum !== 'undefined') {\n        try {\n            const accounts = await window.ethereum.request({\n                method: 'eth_requestAccounts'\n            });\n            \n            console.log('Connected account:', accounts[0]);\n            return accounts[0];\n        } catch (error) {\n            console.error('User rejected connection:', error);\n        }\n    } else {\n        console.error('MetaMask not installed');\n    }\n}\n\n// \u51b7\u94b1\u5305\uff1a\u786c\u4ef6\u94b1\u5305\u7b7e\u540d\nasync function signWithHardwareWallet(transaction) {\n    // \u4f7f\u7528 Ledger \u6216 Trezor \u7b49\u786c\u4ef6\u94b1\u5305\n    const signature = await hardwareWallet.signTransaction(transaction);\n    return signature;\n}\n"})}),"\n",(0,r.jsx)(e.h4,{id:"2-\u6258\u7ba1\u94b1\u5305-vs-\u975e\u6258\u7ba1\u94b1\u5305",children:"2. \u6258\u7ba1\u94b1\u5305 vs \u975e\u6258\u7ba1\u94b1\u5305"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-solidity",children:'// \u975e\u6258\u7ba1\u94b1\u5305\uff1a\u7528\u6237\u5b8c\u5168\u63a7\u5236\u79c1\u94a5\ncontract NonCustodialWallet {\n    address public owner;\n    \n    modifier onlyOwner() {\n        require(msg.sender == owner, "Not owner");\n        _;\n    }\n    \n    function transfer(address to, uint256 amount) external onlyOwner {\n        payable(to).transfer(amount);\n    }\n}\n\n// \u591a\u7b7e\u94b1\u5305\uff1a\u589e\u5f3a\u5b89\u5168\u6027\ncontract MultiSigWallet {\n    address[] public owners;\n    uint256 public required;\n    \n    mapping(uint256 => mapping(address => bool)) public confirmations;\n    \n    function executeTransaction(uint256 txId) external {\n        require(getConfirmationCount(txId) >= required, "Not enough confirmations");\n        // \u6267\u884c\u4ea4\u6613\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u5e38\u89c1\u653b\u51fb\u624b\u6cd5",children:"\u5e38\u89c1\u653b\u51fb\u624b\u6cd5"}),"\n",(0,r.jsx)(e.h3,{id:"1-\u9493\u9c7c\u653b\u51fb",children:"1. \u9493\u9c7c\u653b\u51fb"}),"\n",(0,r.jsx)(e.h4,{id:"\u7b7e\u540d\u9493\u9c7c",children:"\u7b7e\u540d\u9493\u9c7c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"// \u6076\u610f\u7f51\u7ad9\u8bf1\u5bfc\u7528\u6237\u7b7e\u540d\nconst maliciousMessage = {\n    types: {\n        Transfer: [\n            { name: 'to', type: 'address' },\n            { name: 'amount', type: 'uint256' }\n        ]\n    },\n    primaryType: 'Transfer',\n    domain: {\n        name: 'Fake DApp',\n        version: '1',\n        chainId: 1\n    },\n    message: {\n        to: '0xAttackerAddress',\n        amount: '1000000000000000000000' // 1000 ETH!\n    }\n};\n\n// \u7528\u6237\u4e0d\u5c0f\u5fc3\u7b7e\u540d\u540e\uff0c\u8d44\u4ea7\u88ab\u8f6c\u8d70\nawait ethereum.request({\n    method: 'eth_signTypedData_v4',\n    params: [userAddress, JSON.stringify(maliciousMessage)]\n});\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u9632\u5fa1\u63aa\u65bd\uff1a"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"// \u5b89\u5168\u7684\u7b7e\u540d\u9a8c\u8bc1\nfunction verifySignatureRequest(message) {\n    // 1. \u68c0\u67e5\u57df\u540d\n    if (message.domain.name !== EXPECTED_DAPP_NAME) {\n        throw new Error('Suspicious domain name');\n    }\n    \n    // 2. \u68c0\u67e5\u63a5\u6536\u5730\u5740\n    if (!isKnownAddress(message.message.to)) {\n        console.warn('Warning: Unknown recipient address');\n        return false;\n    }\n    \n    // 3. \u68c0\u67e5\u91d1\u989d\n    if (message.message.amount > MAX_SAFE_AMOUNT) {\n        console.warn('Warning: Large amount requested');\n        return false;\n    }\n    \n    return true;\n}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"2-\u6388\u6743\u6ee5\u7528",children:"2. \u6388\u6743\u6ee5\u7528"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-solidity",children:"// \u5371\u9669\uff1a\u65e0\u9650\u6388\u6743\ntoken.approve(spender, type(uint256).max);\n\n// \u5b89\u5168\uff1a\u9650\u989d\u6388\u6743\ntoken.approve(spender, specificAmount);\n\n// \u66f4\u5b89\u5168\uff1a\u4f7f\u7528 permit (EIP-2612)\nfunction permitAndTransfer(\n    address token,\n    address owner,\n    address spender,\n    uint256 value,\n    uint256 deadline,\n    uint8 v,\n    bytes32 r,\n    bytes32 s\n) external {\n    IERC20Permit(token).permit(owner, spender, value, deadline, v, r, s);\n    IERC20(token).transferFrom(owner, address(this), value);\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u68c0\u67e5\u548c\u64a4\u9500\u6388\u6743\uff1a"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"// \u68c0\u67e5\u5f53\u524d\u6388\u6743\nasync function checkAllowance(tokenAddress, ownerAddress, spenderAddress) {\n    const token = new ethers.Contract(tokenAddress, ERC20_ABI, provider);\n    const allowance = await token.allowance(ownerAddress, spenderAddress);\n    \n    console.log('Current allowance:', ethers.utils.formatEther(allowance));\n    return allowance;\n}\n\n// \u64a4\u9500\u6388\u6743\nasync function revokeApproval(tokenAddress, spenderAddress) {\n    const token = new ethers.Contract(tokenAddress, ERC20_ABI, signer);\n    const tx = await token.approve(spenderAddress, 0);\n    await tx.wait();\n    \n    console.log('Approval revoked');\n}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"3-\u79c1\u94a5\u6cc4\u9732",children:"3. \u79c1\u94a5\u6cc4\u9732"}),"\n",(0,r.jsx)(e.h4,{id:"\u5e38\u89c1\u6cc4\u9732\u9014\u5f84",children:"\u5e38\u89c1\u6cc4\u9732\u9014\u5f84"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.strong,{children:"\u660e\u6587\u5b58\u50a8"})}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"// \u5371\u9669\uff01\u6c38\u8fdc\u4e0d\u8981\u8fd9\u6837\u505a\nconst privateKey = \"0x1234567890abcdef...\";\nlocalStorage.setItem('privateKey', privateKey);\n\n// \u6b63\u786e\u505a\u6cd5\uff1a\u4f7f\u7528\u52a0\u5bc6\u5b58\u50a8\nimport CryptoJS from 'crypto-js';\n\nfunction encryptPrivateKey(privateKey, password) {\n    return CryptoJS.AES.encrypt(privateKey, password).toString();\n}\n\nfunction decryptPrivateKey(encryptedKey, password) {\n    const bytes = CryptoJS.AES.decrypt(encryptedKey, password);\n    return bytes.toString(CryptoJS.enc.Utf8);\n}\n"})}),"\n",(0,r.jsxs)(e.ol,{start:"2",children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.strong,{children:"\u7f51\u7edc\u4f20\u8f93\u6cc4\u9732"})}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"// \u5371\u9669\uff1a\u901a\u8fc7HTTP\u53d1\u9001\u79c1\u94a5\nfetch('http://api.example.com/login', {\n    method: 'POST',\n    body: JSON.stringify({ privateKey: key })\n});\n\n// \u6b63\u786e\uff1a\u6c38\u8fdc\u4e0d\u8981\u53d1\u9001\u79c1\u94a5\uff0c\u4f7f\u7528\u7b7e\u540d\u9a8c\u8bc1\nasync function authenticateWithSignature() {\n    const message = `Login to DApp at ${Date.now()}`;\n    const signature = await signer.signMessage(message);\n    \n    fetch('https://api.example.com/login', {\n        method: 'POST',\n        body: JSON.stringify({\n            address: await signer.getAddress(),\n            message: message,\n            signature: signature\n        })\n    });\n}\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u5b89\u5168\u6700\u4f73\u5b9e\u8df5",children:"\u5b89\u5168\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,r.jsx)(e.h3,{id:"1-\u52a9\u8bb0\u8bcd\u7ba1\u7406",children:"1. \u52a9\u8bb0\u8bcd\u7ba1\u7406"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:'// \u751f\u6210\u52a9\u8bb0\u8bcd\nimport { ethers } from \'ethers\';\n\nfunction generateMnemonic() {\n    const wallet = ethers.Wallet.createRandom();\n    return {\n        mnemonic: wallet.mnemonic.phrase,\n        address: wallet.address,\n        privateKey: wallet.privateKey\n    };\n}\n\n// \u4ece\u52a9\u8bb0\u8bcd\u6062\u590d\u94b1\u5305\nfunction recoverFromMnemonic(mnemonic, index = 0) {\n    const hdNode = ethers.utils.HDNode.fromMnemonic(mnemonic);\n    const path = `m/44\'/60\'/0\'/0/${index}`;\n    const wallet = hdNode.derivePath(path);\n    \n    return {\n        address: wallet.address,\n        privateKey: wallet.privateKey\n    };\n}\n\n// \u52a9\u8bb0\u8bcd\u5b89\u5168\u5b58\u50a8\u5efa\u8bae\nconst mnemonicSecurityTips = [\n    "1. \u6c38\u8fdc\u4e0d\u8981\u6570\u5b57\u5316\u5b58\u50a8\uff08\u4e0d\u8981\u622a\u56fe\u3001\u4e0d\u8981\u4e91\u5b58\u50a8\uff09",\n    "2. \u4f7f\u7528\u7269\u7406\u4ecb\u8d28\uff08\u91d1\u5c5e\u677f\u3001\u7eb8\u5f20\uff09",\n    "3. \u5206\u6563\u5b58\u50a8\uff08\u4e0d\u540c\u5730\u70b9\uff09",\n    "4. \u8003\u8651\u4f7f\u7528 Shamir\'s Secret Sharing \u5206\u7247",\n    "5. \u5b9a\u671f\u68c0\u67e5\u5907\u4efd\u5b8c\u6574\u6027"\n];\n'})}),"\n",(0,r.jsx)(e.h3,{id:"2-\u4ea4\u6613\u7b7e\u540d\u9a8c\u8bc1",children:"2. \u4ea4\u6613\u7b7e\u540d\u9a8c\u8bc1"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"// \u5b8c\u6574\u7684\u4ea4\u6613\u9a8c\u8bc1\u6d41\u7a0b\nasync function safeTransactionFlow(transaction) {\n    // 1. \u9a8c\u8bc1\u63a5\u6536\u5730\u5740\n    if (!ethers.utils.isAddress(transaction.to)) {\n        throw new Error('Invalid recipient address');\n    }\n    \n    // 2. \u68c0\u67e5\u5730\u5740\u662f\u5426\u5728\u9ed1\u540d\u5355\n    if (await isBlacklistedAddress(transaction.to)) {\n        throw new Error('Recipient is blacklisted');\n    }\n    \n    // 3. \u4f30\u7b97 gas\n    const gasEstimate = await provider.estimateGas(transaction);\n    transaction.gasLimit = gasEstimate.mul(120).div(100); // 20% buffer\n    \n    // 4. \u83b7\u53d6\u5f53\u524d gas \u4ef7\u683c\n    const gasPrice = await provider.getGasPrice();\n    transaction.gasPrice = gasPrice;\n    \n    // 5. \u8ba1\u7b97\u603b\u6210\u672c\n    const totalCost = transaction.value.add(\n        transaction.gasLimit.mul(transaction.gasPrice)\n    );\n    \n    // 6. \u68c0\u67e5\u4f59\u989d\n    const balance = await provider.getBalance(await signer.getAddress());\n    if (balance.lt(totalCost)) {\n        throw new Error('Insufficient balance');\n    }\n    \n    // 7. \u663e\u793a\u4ea4\u6613\u8be6\u60c5\u4f9b\u7528\u6237\u786e\u8ba4\n    console.log('Transaction Details:');\n    console.log('To:', transaction.to);\n    console.log('Value:', ethers.utils.formatEther(transaction.value), 'ETH');\n    console.log('Gas Cost:', ethers.utils.formatEther(\n        transaction.gasLimit.mul(transaction.gasPrice)\n    ), 'ETH');\n    \n    // 8. \u7528\u6237\u786e\u8ba4\u540e\u7b7e\u540d\n    const signedTx = await signer.signTransaction(transaction);\n    \n    // 9. \u53d1\u9001\u4ea4\u6613\n    const txResponse = await provider.sendTransaction(signedTx);\n    \n    // 10. \u7b49\u5f85\u786e\u8ba4\n    const receipt = await txResponse.wait();\n    \n    return receipt;\n}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"3-\u667a\u80fd\u5408\u7ea6\u4ea4\u4e92\u5b89\u5168",children:"3. \u667a\u80fd\u5408\u7ea6\u4ea4\u4e92\u5b89\u5168"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"// \u5b89\u5168\u7684\u5408\u7ea6\u8c03\u7528\nasync function safeContractInteraction(contractAddress, abi, method, params) {\n    // 1. \u9a8c\u8bc1\u5408\u7ea6\u5730\u5740\n    const code = await provider.getCode(contractAddress);\n    if (code === '0x') {\n        throw new Error('No contract at this address');\n    }\n    \n    // 2. \u68c0\u67e5\u5408\u7ea6\u662f\u5426\u5df2\u9a8c\u8bc1\n    const isVerified = await checkContractVerification(contractAddress);\n    if (!isVerified) {\n        console.warn('Warning: Contract source code not verified');\n    }\n    \n    // 3. \u521b\u5efa\u5408\u7ea6\u5b9e\u4f8b\n    const contract = new ethers.Contract(contractAddress, abi, signer);\n    \n    // 4. \u6a21\u62df\u8c03\u7528\uff08\u68c0\u67e5\u662f\u5426\u4f1a\u5931\u8d25\uff09\n    try {\n        await contract.callStatic[method](...params);\n    } catch (error) {\n        throw new Error(`Transaction would fail: ${error.message}`);\n    }\n    \n    // 5. \u4f30\u7b97 gas\n    const gasEstimate = await contract.estimateGas[method](...params);\n    \n    // 6. \u6267\u884c\u4ea4\u6613\n    const tx = await contract[method](...params, {\n        gasLimit: gasEstimate.mul(120).div(100)\n    });\n    \n    // 7. \u7b49\u5f85\u786e\u8ba4\n    const receipt = await tx.wait();\n    \n    return receipt;\n}\n\n// \u68c0\u67e5\u5408\u7ea6\u9a8c\u8bc1\u72b6\u6001\nasync function checkContractVerification(address) {\n    // \u4f7f\u7528 Etherscan API\n    const response = await fetch(\n        `https://api.etherscan.io/api?module=contract&action=getabi&address=${address}`\n    );\n    const data = await response.json();\n    return data.status === '1';\n}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"4-\u591a\u91cd\u7b7e\u540d\u94b1\u5305",children:"4. \u591a\u91cd\u7b7e\u540d\u94b1\u5305"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-solidity",children:'// \u9ad8\u7ea7\u591a\u7b7e\u94b1\u5305\u5b9e\u73b0\ncontract AdvancedMultiSig {\n    struct Transaction {\n        address to;\n        uint256 value;\n        bytes data;\n        bool executed;\n        uint256 confirmations;\n        uint256 createdAt;\n    }\n    \n    address[] public owners;\n    mapping(address => bool) public isOwner;\n    uint256 public required;\n    uint256 public transactionTimeout = 7 days;\n    \n    Transaction[] public transactions;\n    mapping(uint256 => mapping(address => bool)) public confirmations;\n    \n    event TransactionSubmitted(uint256 indexed txId, address indexed submitter);\n    event TransactionConfirmed(uint256 indexed txId, address indexed confirmer);\n    event TransactionExecuted(uint256 indexed txId);\n    event TransactionCancelled(uint256 indexed txId);\n    \n    modifier onlyOwner() {\n        require(isOwner[msg.sender], "Not owner");\n        _;\n    }\n    \n    modifier txExists(uint256 txId) {\n        require(txId < transactions.length, "Transaction does not exist");\n        _;\n    }\n    \n    modifier notExecuted(uint256 txId) {\n        require(!transactions[txId].executed, "Transaction already executed");\n        _;\n    }\n    \n    modifier notExpired(uint256 txId) {\n        require(\n            block.timestamp <= transactions[txId].createdAt + transactionTimeout,\n            "Transaction expired"\n        );\n        _;\n    }\n    \n    function submitTransaction(\n        address to,\n        uint256 value,\n        bytes memory data\n    ) external onlyOwner returns (uint256) {\n        uint256 txId = transactions.length;\n        \n        transactions.push(Transaction({\n            to: to,\n            value: value,\n            data: data,\n            executed: false,\n            confirmations: 0,\n            createdAt: block.timestamp\n        }));\n        \n        emit TransactionSubmitted(txId, msg.sender);\n        \n        // \u81ea\u52a8\u786e\u8ba4\n        confirmTransaction(txId);\n        \n        return txId;\n    }\n    \n    function confirmTransaction(uint256 txId)\n        public\n        onlyOwner\n        txExists(txId)\n        notExecuted(txId)\n        notExpired(txId)\n    {\n        require(!confirmations[txId][msg.sender], "Already confirmed");\n        \n        confirmations[txId][msg.sender] = true;\n        transactions[txId].confirmations++;\n        \n        emit TransactionConfirmed(txId, msg.sender);\n        \n        if (transactions[txId].confirmations >= required) {\n            executeTransaction(txId);\n        }\n    }\n    \n    function executeTransaction(uint256 txId) internal {\n        Transaction storage transaction = transactions[txId];\n        transaction.executed = true;\n        \n        (bool success, ) = transaction.to.call{value: transaction.value}(\n            transaction.data\n        );\n        require(success, "Transaction execution failed");\n        \n        emit TransactionExecuted(txId);\n    }\n    \n    function revokeConfirmation(uint256 txId)\n        external\n        onlyOwner\n        txExists(txId)\n        notExecuted(txId)\n    {\n        require(confirmations[txId][msg.sender], "Not confirmed");\n        \n        confirmations[txId][msg.sender] = false;\n        transactions[txId].confirmations--;\n    }\n    \n    function cancelTransaction(uint256 txId)\n        external\n        onlyOwner\n        txExists(txId)\n        notExecuted(txId)\n    {\n        require(\n            block.timestamp > transactions[txId].createdAt + transactionTimeout,\n            "Not expired yet"\n        );\n        \n        transactions[txId].executed = true; // \u6807\u8bb0\u4e3a\u5df2\u6267\u884c\u4ee5\u9632\u6b62\u6267\u884c\n        emit TransactionCancelled(txId);\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u5e94\u6025\u54cd\u5e94",children:"\u5e94\u6025\u54cd\u5e94"}),"\n",(0,r.jsx)(e.h3,{id:"\u8d44\u4ea7\u88ab\u76d7\u540e\u7684\u5904\u7406",children:"\u8d44\u4ea7\u88ab\u76d7\u540e\u7684\u5904\u7406"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"// \u7d27\u6025\u8f6c\u79fb\u5269\u4f59\u8d44\u4ea7\nasync function emergencyTransfer(compromisedWallet, safeWallet) {\n    const balance = await provider.getBalance(compromisedWallet.address);\n    \n    // \u8ba1\u7b97 gas \u6210\u672c\n    const gasPrice = await provider.getGasPrice();\n    const gasLimit = 21000;\n    const gasCost = gasPrice.mul(gasLimit);\n    \n    // \u8f6c\u79fb\u6240\u6709\u5269\u4f59\u8d44\u4ea7\n    const amountToSend = balance.sub(gasCost);\n    \n    if (amountToSend.gt(0)) {\n        const tx = await compromisedWallet.sendTransaction({\n            to: safeWallet,\n            value: amountToSend,\n            gasPrice: gasPrice.mul(150).div(100), // \u63d0\u9ad8 gas \u4ef7\u683c\u4ee5\u52a0\u5feb\u786e\u8ba4\n            gasLimit: gasLimit\n        });\n        \n        await tx.wait();\n        console.log('Emergency transfer completed');\n    }\n}\n\n// \u64a4\u9500\u6240\u6709\u4ee3\u5e01\u6388\u6743\nasync function revokeAllApprovals(wallet, tokenAddresses) {\n    for (const tokenAddress of tokenAddresses) {\n        const token = new ethers.Contract(tokenAddress, ERC20_ABI, wallet);\n        \n        // \u83b7\u53d6\u6240\u6709\u6388\u6743\u7684\u5730\u5740\uff08\u9700\u8981\u4e8b\u5148\u8bb0\u5f55\uff09\n        const spenders = await getApprovedSpenders(tokenAddress, wallet.address);\n        \n        for (const spender of spenders) {\n            try {\n                const tx = await token.approve(spender, 0, {\n                    gasPrice: (await provider.getGasPrice()).mul(150).div(100)\n                });\n                await tx.wait();\n                console.log(`Revoked approval for ${spender}`);\n            } catch (error) {\n                console.error(`Failed to revoke ${spender}:`, error);\n            }\n        }\n    }\n}\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u5b89\u5168\u5de5\u5177\u63a8\u8350",children:"\u5b89\u5168\u5de5\u5177\u63a8\u8350"}),"\n",(0,r.jsx)(e.h3,{id:"1-\u94b1\u5305\u5b89\u5168\u68c0\u67e5\u5de5\u5177",children:"1. \u94b1\u5305\u5b89\u5168\u68c0\u67e5\u5de5\u5177"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Revoke.cash"}),": \u68c0\u67e5\u548c\u64a4\u9500\u4ee3\u5e01\u6388\u6743"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Etherscan Token Approvals"}),": \u67e5\u770b\u6240\u6709\u6388\u6743"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Wallet Guard"}),": \u6d4f\u89c8\u5668\u6269\u5c55\uff0c\u8b66\u544a\u6076\u610f\u4ea4\u6613"]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"2-\u4ea4\u6613\u6a21\u62df\u5de5\u5177",children:"2. \u4ea4\u6613\u6a21\u62df\u5de5\u5177"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Tenderly"}),": \u4ea4\u6613\u6a21\u62df\u548c\u8c03\u8bd5"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Phalcon"}),": \u4ea4\u6613\u5206\u6790"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Blocksec"}),": \u5b9e\u65f6\u4ea4\u6613\u76d1\u63a7"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,r.jsx)(e.p,{children:"Web3 \u94b1\u5305\u5b89\u5168\u7684\u5173\u952e\u8981\u70b9\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["\ud83d\udd10 ",(0,r.jsx)(e.strong,{children:"\u79c1\u94a5\u7ba1\u7406"}),"\uff1a\u6c38\u8fdc\u4e0d\u8981\u5728\u7ebf\u5b58\u50a8\u6216\u4f20\u8f93"]}),"\n",(0,r.jsxs)(e.li,{children:["\u2705 ",(0,r.jsx)(e.strong,{children:"\u4ea4\u6613\u9a8c\u8bc1"}),"\uff1a\u4ed4\u7ec6\u68c0\u67e5\u6bcf\u7b14\u4ea4\u6613"]}),"\n",(0,r.jsxs)(e.li,{children:["\ud83d\udee1\ufe0f ",(0,r.jsx)(e.strong,{children:"\u6388\u6743\u63a7\u5236"}),"\uff1a\u5b9a\u671f\u68c0\u67e5\u548c\u64a4\u9500\u4e0d\u5fc5\u8981\u7684\u6388\u6743"]}),"\n",(0,r.jsxs)(e.li,{children:["\ud83d\udd0d ",(0,r.jsx)(e.strong,{children:"\u8b66\u60d5\u9493\u9c7c"}),"\uff1a\u9a8c\u8bc1\u7f51\u7ad9\u771f\u5b9e\u6027"]}),"\n",(0,r.jsxs)(e.li,{children:["\ud83d\udcbe ",(0,r.jsx)(e.strong,{children:"\u5907\u4efd\u52a9\u8bb0\u8bcd"}),"\uff1a\u4f7f\u7528\u7269\u7406\u4ecb\u8d28\uff0c\u5206\u6563\u5b58\u50a8"]}),"\n",(0,r.jsxs)(e.li,{children:["\ud83d\udea8 ",(0,r.jsx)(e.strong,{children:"\u5e94\u6025\u51c6\u5907"}),"\uff1a\u5236\u5b9a\u8d44\u4ea7\u88ab\u76d7\u5e94\u6025\u9884\u6848"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u8bb0\u4f4f\uff1a",(0,r.jsx)(e.strong,{children:"\u5728 Web3 \u4e16\u754c\uff0c\u4f60\u5c31\u662f\u81ea\u5df1\u7684\u94f6\u884c\u3002\u5b89\u5168\u8d23\u4efb\u5b8c\u5168\u5728\u4f60\u624b\u4e2d\u3002"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"AutoSec \u63d0\u9192"}),"\uff1a\u5b9a\u671f\u8fdb\u884c\u5b89\u5168\u5ba1\u67e5\uff0c\u4fdd\u6301\u8b66\u60d5\uff0c\u4fdd\u62a4\u4f60\u7684\u6570\u5b57\u8d44\u4ea7\u3002"]})]})}function u(n={}){const{wrapper:e}={...(0,a.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(l,{...n})}):l(n)}},8453(n,e,t){t.d(e,{R:()=>i,x:()=>o});var s=t(6540);const r={},a=s.createContext(r);function i(n){const e=s.useContext(a);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:i(n.components),s.createElement(a.Provider,{value:e},n.children)}},5602(n){n.exports=JSON.parse('{"permalink":"/en/web3-wallet-security","editUrl":"https://github.com/pfyangf/pfyangf.github.io/tree/main/blog/2025/01-31-web3-wallet-security.md","source":"@site/blog/2025/01-31-web3-wallet-security.md","title":"Web3\u94b1\u5305\u5b89\u5168\u5b8c\u5168\u6307\u5357\uff1a\u4ece\u539f\u7406\u5230\u5b9e\u8df5","description":"Web3\u94b1\u5305\u662f\u7528\u6237\u8fdb\u5165\u533a\u5757\u94fe\u4e16\u754c\u7684\u95e8\u6237\uff0c\u4f46\u4e5f\u662f\u6700\u5bb9\u6613\u53d7\u5230\u653b\u51fb\u7684\u73af\u8282\u3002\u672c\u6587\u5c06\u6df1\u5165\u63a2\u8ba8\u94b1\u5305\u5b89\u5168\u7684\u5404\u4e2a\u65b9\u9762\uff0c\u4ece\u6280\u672f\u539f\u7406\u5230\u5b9e\u8df5\u5efa\u8bae\u3002","date":"2025-01-31T00:00:00.000Z","tags":[{"inline":true,"label":"\u94b1\u5305\u5b89\u5168","permalink":"/en/tags/\u94b1\u5305\u5b89\u5168"},{"inline":true,"label":"\u79c1\u94a5\u7ba1\u7406","permalink":"/en/tags/\u79c1\u94a5\u7ba1\u7406"},{"inline":true,"label":"Web3\u5b89\u5168","permalink":"/en/tags/web-3-\u5b89\u5168"},{"inline":true,"label":"\u52a0\u5bc6\u8d27\u5e01","permalink":"/en/tags/\u52a0\u5bc6\u8d27\u5e01"},{"inline":true,"label":"\u5b89\u5168\u6700\u4f73\u5b9e\u8df5","permalink":"/en/tags/\u5b89\u5168\u6700\u4f73\u5b9e\u8df5"}],"readingTime":7.47,"hasTruncateMarker":true,"authors":[{"name":"AutoSec Team","title":"Web3 Security Researchers","url":"https://autosec.dev","imageURL":"/en/img/autosec.logo.png","key":"autosec","page":null}],"frontMatter":{"slug":"web3-wallet-security","title":"Web3\u94b1\u5305\u5b89\u5168\u5b8c\u5168\u6307\u5357\uff1a\u4ece\u539f\u7406\u5230\u5b9e\u8df5","authors":["autosec"],"tags":["\u94b1\u5305\u5b89\u5168","\u79c1\u94a5\u7ba1\u7406","Web3\u5b89\u5168","\u52a0\u5bc6\u8d27\u5e01","\u5b89\u5168\u6700\u4f73\u5b9e\u8df5"]},"unlisted":false,"prevItem":{"title":"Solidity Security Patterns: Writing Secure Smart Contracts","permalink":"/en/solidity-security-patterns"},"nextItem":{"title":"TypeScript Best Practices Guide","permalink":"/en/typescript-best-practices"}}')}}]);